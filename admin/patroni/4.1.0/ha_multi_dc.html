

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HA multi datacenter &mdash; Patroni 4.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="_static/github_style.css?v=1093691d" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=977c162b" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=42d1b3bd"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="FAQ" href="faq.html" />
    <link rel="prev" title="Security Considerations" href="security.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Patroni
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="patroni_configuration.html">Patroni configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="rest_api.html">Patroni REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="patronictl.html">patronictl</a></li>
<li class="toctree-l1"><a class="reference internal" href="replica_bootstrap.html">Replica imaging and bootstrap</a></li>
<li class="toctree-l1"><a class="reference internal" href="replication_modes.html">Replication modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="standby_cluster.html">Standby cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="watchdog.html">Watchdog support</a></li>
<li class="toctree-l1"><a class="reference internal" href="pause.html">Pause/Resume mode for the cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="dcs_failsafe_mode.html">DCS Failsafe Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="kubernetes.html">Using Patroni with Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="citus.html">Citus support</a></li>
<li class="toctree-l1"><a class="reference internal" href="existing_data.html">Convert a Standalone to a Patroni Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="existing_data.html#major-upgrade-of-postgresql-version">Major Upgrade of PostgreSQL Version</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools_integration.html">Integration with other tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security Considerations</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">HA multi datacenter</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#synchronous-replication">Synchronous Replication</a></li>
<li class="toctree-l2"><a class="reference internal" href="#asynchronous-replication">Asynchronous Replication</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Patroni</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">HA multi datacenter</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/patroni/patroni/blob/master/docs/ha_multi_dc.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ha-multi-datacenter">
<span id="ha-multi-dc"></span><h1>HA multi datacenter<a class="headerlink" href="#ha-multi-datacenter" title="Link to this heading"></a></h1>
<p>The high availability of a PostgreSQL cluster deployed in multiple data centers is based on replication, which can be synchronous or asynchronous (see <a class="reference internal" href="replication_modes.html#replication-modes"><span class="std std-ref">replication modes</span></a>).</p>
<p>In both cases, it is important to be clear about the following concepts:</p>
<ul class="simple">
<li><p>Postgres can run as primary or standby leader only when it owns the leading key and can update the leading key.</p></li>
<li><p>You should run the odd number of etcd, ZooKeeper or Consul nodes: 3 or 5!</p></li>
</ul>
<section id="synchronous-replication">
<h2>Synchronous Replication<a class="headerlink" href="#synchronous-replication" title="Link to this heading"></a></h2>
<p>To have a multi DC cluster that can automatically tolerate a zone drop, a minimum of 3 is required.</p>
<p>The architecture diagram would be the following:</p>
<img alt="_images/multi-dc-synchronous-replication.png" src="_images/multi-dc-synchronous-replication.png" />
<p>We must deploy a cluster of etcd, ZooKeeper or Consul through the different DC, with a minimum of 3 nodes, one in each zone.</p>
<p>Regarding postgres, we must deploy at least 2 nodes, in different DC. Then you have to set <code class="docutils literal notranslate"><span class="pre">synchronous_mode:</span> <span class="pre">true</span></code> in the global <a class="reference internal" href="dynamic_configuration.html#dynamic-configuration"><span class="std std-ref">dynamic configuration</span></a>.</p>
<p>This enables sync replication and the primary node will choose one of the nodes as synchronous.</p>
</section>
<section id="asynchronous-replication">
<h2>Asynchronous Replication<a class="headerlink" href="#asynchronous-replication" title="Link to this heading"></a></h2>
<p>With only two data centers it would be better to have two independent etcd clusters and run Patroni <a class="reference internal" href="standby_cluster.html#standby-cluster"><span class="std std-ref">standby cluster</span></a> in the second data center. If the first site is down, you can MANUALLY promote the <code class="docutils literal notranslate"><span class="pre">standby_cluster</span></code>.</p>
<p>The architecture diagram would be the following:</p>
<img alt="_images/multi-dc-asynchronous-replication.png" src="_images/multi-dc-asynchronous-replication.png" />
<p>Automatic promotion is not possible, because DC2 will never able to figure out the state of DC1.</p>
<p>You should not use <code class="docutils literal notranslate"><span class="pre">pg_ctl</span> <span class="pre">promote</span></code> in this scenario, you need “manually promote” the healthy cluster by removing <code class="docutils literal notranslate"><span class="pre">standby_cluster</span></code> section from the <a class="reference internal" href="dynamic_configuration.html#dynamic-configuration"><span class="std std-ref">dynamic configuration</span></a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If the source cluster is still up and running and you promote the standby cluster you create a split-brain.</p>
</div>
<p>In case you want to return to the “initial” state, there are only two ways of resolving it:</p>
<ul class="simple">
<li><p>Add the standby_cluster section back and it will trigger <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code>; however, for <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> to function properly, either the cluster must be initialized with <code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">page</span> <span class="pre">checksums</span></code> (<code class="docutils literal notranslate"><span class="pre">--data-checksums</span></code> option for <code class="docutils literal notranslate"><span class="pre">initdb</span></code>) and/or <code class="docutils literal notranslate"><span class="pre">wal_log_hints</span></code> must be set to <code class="docutils literal notranslate"><span class="pre">on</span></code>, but there are still chances that <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> might fail due to other factors.</p></li>
<li><p>Rebuild the standby cluster from scratch.</p></li>
</ul>
<p>Before promoting standby cluster one have to manually ensure that the source cluster is down (STONITH). When DC1 recovers, the cluster has to be converted to a standby cluster.</p>
<p>Before doing that you may manually examine the database and extract all changes that happened between the time when network between DC1 and DC2 has stopped working and the time when you manually stopped the cluster in DC1.</p>
<p>Once extracted, you may also manually apply these changes to the cluster in DC2.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="security.html" class="btn btn-neutral float-left" title="Security Considerations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="faq.html" class="btn btn-neutral float-right" title="FAQ" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025 Compose, Zalando SE, Patroni Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>