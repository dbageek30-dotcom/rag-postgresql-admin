

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Release notes &mdash; Patroni 4.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="_static/github_style.css?v=1093691d" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=977c162b" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=42d1b3bd"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Contributing" href="CONTRIBUTING.html" />
    <link rel="prev" title="FAQ" href="faq.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Patroni
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="patroni_configuration.html">Patroni configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="rest_api.html">Patroni REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="patronictl.html">patronictl</a></li>
<li class="toctree-l1"><a class="reference internal" href="replica_bootstrap.html">Replica imaging and bootstrap</a></li>
<li class="toctree-l1"><a class="reference internal" href="replication_modes.html">Replication modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="standby_cluster.html">Standby cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="watchdog.html">Watchdog support</a></li>
<li class="toctree-l1"><a class="reference internal" href="pause.html">Pause/Resume mode for the cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="dcs_failsafe_mode.html">DCS Failsafe Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="kubernetes.html">Using Patroni with Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="citus.html">Citus support</a></li>
<li class="toctree-l1"><a class="reference internal" href="existing_data.html">Convert a Standalone to a Patroni Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="existing_data.html#major-upgrade-of-postgresql-version">Major Upgrade of PostgreSQL Version</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools_integration.html">Integration with other tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security Considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="ha_multi_dc.html">HA multi datacenter</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Release notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#version-4-1-0">Version 4.1.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-4-0-7">Version 4.0.7</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-4-0-6">Version 4.0.6</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-4-0-5">Version 4.0.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-4-0-4">Version 4.0.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-4-0-3">Version 4.0.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-4-0-2">Version 4.0.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-4-0-1">Version 4.0.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-4-0-0">Version 4.0.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-3-2">Version 3.3.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-3-1">Version 3.3.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-3-0">Version 3.3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-2-2">Version 3.2.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-2-1">Version 3.2.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-2-0">Version 3.2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-1-2">Version 3.1.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-1-1">Version 3.1.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-1-0">Version 3.1.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-0-4">Version 3.0.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-0-3">Version 3.0.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-0-2">Version 3.0.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-0-1">Version 3.0.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-3-0-0">Version 3.0.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-2-1-7">Version 2.1.7</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-2-1-6">Version 2.1.6</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-2-1-5">Version 2.1.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-2-1-4">Version 2.1.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-2-1-3">Version 2.1.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-2-1-2">Version 2.1.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-2-1-1">Version 2.1.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-2-1-0">Version 2.1.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-2-0-2">Version 2.0.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-2-0-1">Version 2.0.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-2-0-0">Version 2.0.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-6-5">Version 1.6.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-6-4">Version 1.6.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-6-3">Version 1.6.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-6-2">Version 1.6.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-6-1">Version 1.6.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-6-0">Version 1.6.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-5-6">Version 1.5.6</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-5-5">Version 1.5.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-5-4">Version 1.5.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-5-3">Version 1.5.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-5-2">Version 1.5.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-5-1">Version 1.5.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-5-0">Version 1.5.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-4-6">Version 1.4.6</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-4-5">Version 1.4.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-4-4">Version 1.4.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-4-3">Version 1.4.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-4-2">Version 1.4.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-4-1">Version 1.4.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-4">Version 1.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-3-6">Version 1.3.6</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-3-5">Version 1.3.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-3-4">Version 1.3.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-3-3">Version 1.3.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-3-2">Version 1.3.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-3-1">Version 1.3.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-3">Version 1.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-2">Version 1.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-1">Version 1.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-1-0">Version 1.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-0-90">Version 0.90</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-0-80">Version 0.80</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Patroni</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Release notes</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/patroni/patroni/blob/master/docs/releases.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="release-notes">
<span id="releases"></span><h1>Release notes<a class="headerlink" href="#release-notes" title="Link to this heading"></a></h1>
<section id="version-4-1-0">
<h2>Version 4.1.0<a class="headerlink" href="#version-4-1-0" title="Link to this heading"></a></h2>
<p>Released 2025-09-23</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Add support for systemd “notify” unit type (Ronan Dunklau)</p>
<p>Without a notify unit type, it is possible to start Patroni and immediately send it a SIGHUP signal using systemd, effectively killing it before it had time to set up its signal handlers.</p>
</li>
<li><p>Provide receive and replay LSN/lag information in API and ctl (Polina Bungina)</p>
<p>Patroni REST API <code class="docutils literal notranslate"><span class="pre">/cluster</span></code> endpoint and <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">list</span></code> command now provide receive LSN, replay LSN, receive lag, and replay lag information for each replica member.</p>
</li>
<li><p>Ensure clean demotion to standby cluster (Polina Bungina)</p>
<p>Make sure the introduction of the <code class="docutils literal notranslate"><span class="pre">standby_cluster</span></code> section in the dynamic configuration leads to a clean cluster demotion.</p>
</li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">demote-cluster</span></code> and <code class="docutils literal notranslate"><span class="pre">promote-cluster</span></code> commands (Polina Bungina)</p>
<p>New commands for cluster demotion and promotion handle both the dynamic configuration editing and checking the result status.</p>
</li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">sync_priority</span></code> tag (Polina Bungina)</p>
<p>This parameter controls the priority a member should have during synchronous replica selection when <code class="docutils literal notranslate"><span class="pre">synchronous_mode</span></code> is set to <code class="docutils literal notranslate"><span class="pre">on</span></code>.</p>
</li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">--print</span></code> option for <code class="docutils literal notranslate"><span class="pre">--validate-config</span></code> (Polina Bungina)</p>
<p>Print out local configuration (including environment configuration overrides) after it has been successfully validated.</p>
</li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">kubernetes.bootstrap_labels</span></code> (Polina Bungina)</p>
<p>This feature allows you to define labels that will be assigned to a member pod when in <code class="docutils literal notranslate"><span class="pre">initializing</span> <span class="pre">new</span> <span class="pre">cluster</span></code>, <code class="docutils literal notranslate"><span class="pre">running</span> <span class="pre">custom</span> <span class="pre">bootstrap</span> <span class="pre">script</span></code>, <code class="docutils literal notranslate"><span class="pre">starting</span> <span class="pre">after</span> <span class="pre">custom</span> <span class="pre">bootstrap</span></code>, or <code class="docutils literal notranslate"><span class="pre">creating</span> <span class="pre">replica</span></code> state.</p>
</li>
<li><p>Add configuration option to suppress duplicate heartbeat logs (Michael Morris)</p>
<p>If set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, successive heartbeat logs that are identical shall not be output.</p>
</li>
<li><p>Add optional <code class="docutils literal notranslate"><span class="pre">cluster_type</span></code> attribute to permanent replication slots (Michael Banck)</p>
<p>This allows you to set whether a particular permanent replication slot should always be created, or just on a primary or standby cluster.</p>
</li>
<li><p>Make HTTP Server header configurable (David Grierson)</p>
<p>Introduce the <code class="docutils literal notranslate"><span class="pre">restapi.server_tokens</span></code> configuration parameter that allows you to restrict information disclosed in the HTTP Server header.</p>
</li>
<li><p>Implement readiness API checks for replication on replica members (Ants Aasma)</p>
<p>The previous implementation considered replicas ready as soon as PostgreSQL was started. With this change, a replica pod is only considered ready when PostgreSQL is replicating and is not too far behind the leader.</p>
</li>
</ul>
<p><strong>Improvements</strong></p>
<ul>
<li><p>Reduce log level of watchdog configuration failure (Ants Aasma)</p>
<p>Show the <cite>Could not activate Linux watchdog device</cite> log line on debug logging level, unless the watchdog is configured with <code class="docutils literal notranslate"><span class="pre">required</span></code> mode. It was previously shown on info level.</p>
</li>
<li><p>Take advantage of <code class="docutils literal notranslate"><span class="pre">written_lsn</span></code> and <code class="docutils literal notranslate"><span class="pre">latest_end_lsn</span></code> from <code class="docutils literal notranslate"><span class="pre">pg_stat_wal_receiver</span></code> (Alexander Kukushkin)</p>
<p><code class="docutils literal notranslate"><span class="pre">written_lsn</span></code>, the actual write LSN, is now preferred over the one returned by <code class="docutils literal notranslate"><span class="pre">pg_last_wal_receive_lsn()</span></code>, which is in fact the flush LSN. <code class="docutils literal notranslate"><span class="pre">latest_end_lsn</span></code> points to WAL flush on the source host. In case of a primary, it allows better calculation of the replay lag, because values stored in DCS are updated only every <code class="docutils literal notranslate"><span class="pre">loop_wait</span></code> seconds.</p>
</li>
<li><p>Avoid interactions with slots created with the <code class="docutils literal notranslate"><span class="pre">failover=true</span></code> option (Alexander Kukushkin)</p>
<p>This change is required to make the logical failover slots feature fully functional.</p>
</li>
<li><p>Add PostgreSQL state to <code class="docutils literal notranslate"><span class="pre">/metrics</span></code> REST API endpoint (Ivan Filianin)</p>
<p>PostgreSQL instance state information is now available in the Prometheus format output of the <code class="docutils literal notranslate"><span class="pre">/metrics</span></code> REST API endpoint.</p>
</li>
</ul>
</section>
<section id="version-4-0-7">
<h2>Version 4.0.7<a class="headerlink" href="#version-4-0-7" title="Link to this heading"></a></h2>
<p>Released 2025-09-22</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Add support for PostgreSQL 18 RC1 (Alexander Kukushkin)</p>
<p>GUC’s validator rules were extended. Patroni now properly handles the new background I/O worker.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Fix potential issue around resolving localhost to IPv6 on Windows (András Váczi)</p>
<p>When configuring <code class="docutils literal notranslate"><span class="pre">listen_addresses</span></code> in PostgreSQL, using <code class="docutils literal notranslate"><span class="pre">0.0.0.0</span></code> or <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code> will restrict listening to IPv4 only, excluding IPv6. On typical Windows systems, however, <code class="docutils literal notranslate"><span class="pre">localhost</span></code> often resolves to the IPv6 address <code class="docutils literal notranslate"><span class="pre">::1</span></code> by default. To ensure compatibility, Patroni now configures PostgreSQL to listen on <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code>, instead of <code class="docutils literal notranslate"><span class="pre">localhost</span></code>, on Windows systems.</p>
</li>
<li><p>Return global config only when <code class="docutils literal notranslate"><span class="pre">/config</span></code> key exists in DCS (Alexander Kukushkin)</p>
<p>Patroni REST API was returning an empty configuration instead of raising an error if the <code class="docutils literal notranslate"><span class="pre">/config</span></code> key was missing in DCS.</p>
</li>
<li><p>Fix the issue of failsafe mode not being triggered in case of Etcd unavailability (Alexander Kukushkin)</p>
<p>Patroni was not always properly handling <code class="docutils literal notranslate"><span class="pre">etcd3</span></code> exceptions, which resulted in failsafe mode not being triggered.</p>
</li>
<li><p>Fix signal handler reentrancy deadlock (Waynerv)</p>
<p>Patroni running in a Docker container with <code class="docutils literal notranslate"><span class="pre">PID=1</span></code> in some special cases was experiencing deadlock after receiving <code class="docutils literal notranslate"><span class="pre">SIGCHLD</span></code>.</p>
</li>
<li><p>Recreate (permanent) physical slot when it doesn’t reserve WAL (Israel Barth Rubio)</p>
<p>Permanent physical replication slots created outside of Patroni scope without reserving WALs were causing a <code class="docutils literal notranslate"><span class="pre">replication</span> <span class="pre">slot</span> <span class="pre">cannot</span> <span class="pre">be</span> <span class="pre">advanced</span></code> error. To avoid this, Patroni now recreates such slots.</p>
</li>
<li><p>Handle watch cancelation messages in <code class="docutils literal notranslate"><span class="pre">etcd3</span></code> properly (Alexander Kukushkin)</p>
<p>When <code class="docutils literal notranslate"><span class="pre">etcd3</span></code> sends a cancelation message to the watch channel, it doesn’t close the connection. This results in Patroni using stale data. Patroni now solves it by breaking a loop of reading chunked response and closing the connection on the Patroni side.</p>
</li>
<li><p>Handle case when <code class="docutils literal notranslate"><span class="pre">HTTPConnection</span></code> socket is wrapped with <code class="docutils literal notranslate"><span class="pre">pyopenssl</span></code> (Alexander Kukushkin)</p>
<p>Patroni was not correctly using <code class="docutils literal notranslate"><span class="pre">pyopenssl</span></code> interfaces, enforced in <code class="docutils literal notranslate"><span class="pre">python-etcd</span></code>.</p>
</li>
</ul>
<p><strong>Documentation improvements</strong></p>
<ul>
<li><p>Improve 2-node cluster guidance (Nikolay Samokhvalov)</p>
<p>Clarify behaviour during failover and DCS requirements.</p>
</li>
</ul>
</section>
<section id="version-4-0-6">
<h2>Version 4.0.6<a class="headerlink" href="#version-4-0-6" title="Link to this heading"></a></h2>
<p>Released 2025-06-06</p>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Fix bug in failover from a leader with a higher priority (Alexander Kukushkin)</p>
<p>Make sure Patroni ignores the former leader with higher priority when it reports the same <code class="docutils literal notranslate"><span class="pre">LSN</span></code> as the current node.</p>
</li>
<li><p>Fix permissions for the <code class="docutils literal notranslate"><span class="pre">postgresql.conf</span></code> file created outside of <code class="docutils literal notranslate"><span class="pre">PGDATA</span></code> (Michael Banck)</p>
<p>Respect the system-wide umask value when creating the <code class="docutils literal notranslate"><span class="pre">postgresql.conf</span></code> file outside of the <code class="docutils literal notranslate"><span class="pre">PGDATA</span></code> directory.</p>
</li>
<li><p>Fix bug with switchover in <code class="docutils literal notranslate"><span class="pre">synchronous_mode=quorum</span></code> (Alexander Kukushkin)</p>
<p>Do not check quorum requirements when a candidate is specified.</p>
</li>
<li><p>Ignore stale Etcd nodes by comparing cluster term (Alexander Kukushkin)</p>
<p>Memorize the last known “raft_term” of the Etcd cluster, and when executing client requests, compare it with the “raft_term” reported by an Etcd node.</p>
</li>
<li><p>Update PostgreSQL configuration files on <code class="docutils literal notranslate"><span class="pre">SIGHUP</span></code> (Alexander Kukushkin)</p>
<p>Previously, Patroni was only replacing PostgreSQL configuration files if a change in global or local configuration was detected.</p>
</li>
<li><p>Properly handle <code class="docutils literal notranslate"><span class="pre">Unavailable</span></code> exception raised by <code class="docutils literal notranslate"><span class="pre">etcd3</span></code> (Alexander Kukushkin)</p>
<p>Patroni used to retry such requests on the same <code class="docutils literal notranslate"><span class="pre">etcd3</span></code> node, while switching to another node is a better strategy.</p>
</li>
<li><p>Improve <code class="docutils literal notranslate"><span class="pre">etcd3</span></code> lease handling (Alexander Kukushkin)</p>
<p>Make sure Patroni refreshes the <code class="docutils literal notranslate"><span class="pre">etcd3</span></code> lease at least once per HA loop.</p>
</li>
<li><p>Recheck annotations on 409 status code when attempting to acquire leader lock (Alexander Kukushkin)</p>
<p>Implement the same behavior as was done for the leader object read in Patroni version 4.0.3.</p>
</li>
<li><p>Consider <code class="docutils literal notranslate"><span class="pre">replay_lsn</span></code> when advancing slots (Polina Bungina)</p>
<p>Do not try to advance slots on replicas past the <code class="docutils literal notranslate"><span class="pre">replay_lsn</span></code>. Additionally, advance the slot to the <code class="docutils literal notranslate"><span class="pre">replay_lsn</span></code> position if it is already past the <code class="docutils literal notranslate"><span class="pre">confirmed_flush_lsn</span></code> of this slot on the replica but the replica has still not replayed the actual <code class="docutils literal notranslate"><span class="pre">LSN</span></code> at which this slot is on the primary.</p>
</li>
<li><p>Make sure <code class="docutils literal notranslate"><span class="pre">CHECKPOINT</span></code> is executed after promote (Alexander Kukushkin)</p>
<p>It was possible that checkpoint task wasn’t reset on demote because <code class="docutils literal notranslate"><span class="pre">CHECKPOINT</span></code> wasn’t yet finished. This resulted in using a stale <code class="docutils literal notranslate"><span class="pre">result</span></code> when the next promote is triggered.</p>
</li>
<li><p>Avoid running “offline” demotion concurrently (Alexander Kukushkin)</p>
<p>In case of a slow shutdown, it might happen that the next heartbeat loop hits the DCS error handling method again, resulting in <code class="docutils literal notranslate"><span class="pre">AsyncExecutor</span> <span class="pre">is</span> <span class="pre">busy,</span> <span class="pre">demoting</span> <span class="pre">from</span> <span class="pre">the</span> <span class="pre">main</span> <span class="pre">thread</span></code> warning and starting offline demotion again.</p>
</li>
<li><p>Normalize the <code class="docutils literal notranslate"><span class="pre">data_dir</span></code> value before renaming the data directory on initialization failure (Waynerv)</p>
<p>Prevent a trailing slash in the <code class="docutils literal notranslate"><span class="pre">data_dir</span></code> parameter value from breaking the renaming process after an initialization failure.</p>
</li>
<li><p>Check that <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code> contains the expected value (Alexander Kukushkin)</p>
<p>Previously, the mechanism implementing the state machine for non-quorum synchronous replication didn’t check the actual value of <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code>, what resulted in a stale value of <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code> being used when <code class="docutils literal notranslate"><span class="pre">pg_stat_replication</span></code> is a subset of <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code>.</p>
</li>
</ul>
</section>
<section id="version-4-0-5">
<h2>Version 4.0.5<a class="headerlink" href="#version-4-0-5" title="Link to this heading"></a></h2>
<p>Released 2025-02-20</p>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Compatibility with <code class="docutils literal notranslate"><span class="pre">python-json-logger&gt;=3.1</span></code> (Alexander Kukushkin)</p>
<p>Get rid of the warnings produced by the old API usage.</p>
</li>
<li><p>Compatibility with Python 3.13 (Alexander Kukushkin)</p>
<p>Run tests against Python 3.13.</p>
</li>
<li><p>Compatibility with <code class="docutils literal notranslate"><span class="pre">pyinstaller&gt;=4.4</span></code> (Joe Jensen)</p>
<p>Fall back to the default <code class="docutils literal notranslate"><span class="pre">iter_modules</span></code> if <code class="docutils literal notranslate"><span class="pre">pyinstaller</span></code> <code class="docutils literal notranslate"><span class="pre">toc</span></code> attribute is not present.</p>
</li>
<li><p>Fix issues with PostgreSQL 9.5 support (Alexander Kukushkin)</p>
<ul class="simple">
<li><p>Properly handle <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> output format.</p></li>
<li><p>Consider <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code> format not supporting “num” specification.</p></li>
</ul>
</li>
<li><p>Compatibility with the latest changes in <code class="docutils literal notranslate"><span class="pre">urlparse</span></code> (Alexander Kukushkin)</p>
<p><code class="docutils literal notranslate"><span class="pre">urlparse</span></code> doesn’t accept multiple hosts with <code class="docutils literal notranslate"><span class="pre">[]</span></code> character in URL anymore. To mitigate the problem, switch to the native wrappers of <code class="docutils literal notranslate"><span class="pre">PQconninfoParse()</span></code> from <code class="docutils literal notranslate"><span class="pre">libpq</span></code>, when it is possible, and use our implementation only for older <code class="docutils literal notranslate"><span class="pre">psycopg2</span></code> versions that are linked with an outdated version of <code class="docutils literal notranslate"><span class="pre">libpq</span></code>.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Show only the members to be restarted upon restart confirmation (András Váczi)</p>
<p>Previously, when doing <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">restart</span> <span class="pre">&lt;clustername&gt;</span> <span class="pre">--pending</span></code>, the confirmation listed all members, regardless of whether their restart is pending.</p>
</li>
<li><p>Cancel long-running jobs on Patroni stop and remove data directory on replica bootstrap failure (Alexander Kukushkin)</p>
<p>Previously, Patroni could be doing replica bootstrap, while <code class="docutils literal notranslate"><span class="pre">pg_basebackup</span></code> / <code class="docutils literal notranslate"><span class="pre">wal-g</span></code> / <code class="docutils literal notranslate"><span class="pre">pgBackRest</span></code> / <code class="docutils literal notranslate"><span class="pre">barman</span></code> or similar keep running.</p>
</li>
<li><p>Properly handle cluster names with a slash in <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">edit-config</span></code> (Antoni Mur)</p>
<p>Replace a forward slash in <code class="docutils literal notranslate"><span class="pre">cluster_name</span></code> with an underscore.</p>
</li>
<li><p>Avoid dropping physical slots too early (Alexander Kukushkin)</p>
<p>Postpone removal of physical replication slots containing <code class="docutils literal notranslate"><span class="pre">xmin</span></code> after a failover: on the new primary – until this member is promoted, on replicas – until there is a leader in the cluster.</p>
</li>
<li><p>Handle all exceptions raised by subprocess in <code class="docutils literal notranslate"><span class="pre">controldata()</span></code> (Alexander Kukushkin)</p>
<p>Patroni was not properly handling all exceptions possibly raised when calling <code class="docutils literal notranslate"><span class="pre">pg_controldata</span></code> utility.</p>
</li>
<li><p>Fix bug with a slot for a former leader not retained on failover (Alexander Kukushkin)</p>
<p>Avoid falsely relying on members being present in DCS, while on failover <code class="docutils literal notranslate"><span class="pre">/member</span></code> key for the former leader is expiring exactly at the same time.</p>
</li>
<li><p>Fix a couple of bugs in the quorum state machine (Alexander Kukushkin)</p>
<ul class="simple">
<li><p>When evaluating whether there are healthy nodes for a leader race, before demoting we need to take into account quorum requirements. Without it, the former leader may end up in recovery surrounded by asynchronous nodes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">QuorumStateResolver</span></code> wasn’t correctly handling the case when a replica node quickly joined and disconnected.</p></li>
</ul>
</li>
</ul>
<p><strong>Improvements</strong></p>
<ul>
<li><p>Improve error on am empty or non-dictionary configuration file (Julian)</p>
<p>Throw a more explicit exception when validating if Patroni configuration file contains a valid <code class="docutils literal notranslate"><span class="pre">Mapping</span></code> object.</p>
</li>
</ul>
</section>
<section id="version-4-0-4">
<h2>Version 4.0.4<a class="headerlink" href="#version-4-0-4" title="Link to this heading"></a></h2>
<p>Released 2024-11-22</p>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Add compatibility with the <code class="docutils literal notranslate"><span class="pre">py-consul</span></code> module (Alexander Kukushkin)</p>
<p><code class="docutils literal notranslate"><span class="pre">python-consul</span></code> module is unmaintained for a long time, while <code class="docutils literal notranslate"><span class="pre">py-consul</span></code> is the official replacement. Backward compatibility with python-consul is retained.</p>
</li>
<li><p>Add compatibility with the <code class="docutils literal notranslate"><span class="pre">prettytable&gt;=3.12.0</span></code> module (Alexander Kukushkin)</p>
<p>Address deprecation warnings.</p>
</li>
<li><p>Compatibility with the <code class="docutils literal notranslate"><span class="pre">ydiff==1.4.2</span></code> module (Alexander Kukushkin)</p>
<p>Fix compatibility issues for the latest version, constrain version in <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code>, and introduce latest version compatibility test.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">on_role_change</span></code> callback after a failed primary recovery (Polina Bungina, Alexander Kukushkin)</p>
<p>Additionally run <code class="docutils literal notranslate"><span class="pre">on_role_change</span></code> callback for a primary that failed to start after a crash to increase chances the callback is executed, even if the further start as a replica fails.</p>
</li>
<li><p>Fix a thread leak in <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">list</span> <span class="pre">-W</span></code> (Alexander Kukushkin)</p>
<p>Cache DCS instance object to avoid thread leak.</p>
</li>
<li><p>Ensure only supported parameters are written to the connection string (Alexander Kukushkin)</p>
<p>Patroni used to pass parameters introduced in newer versions to the connection string, which had been leading to connection errors.</p>
</li>
</ul>
</section>
<section id="version-4-0-3">
<h2>Version 4.0.3<a class="headerlink" href="#version-4-0-3" title="Link to this heading"></a></h2>
<p>Released 2024-10-18</p>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Disable <code class="docutils literal notranslate"><span class="pre">pgaudit</span></code> when creating users not to expose password (kviset)</p>
<p>Patroni was logging <code class="docutils literal notranslate"><span class="pre">superuser</span></code>, <code class="docutils literal notranslate"><span class="pre">replication</span></code>, and <code class="docutils literal notranslate"><span class="pre">rewind</span></code> passwords on their creation when <code class="docutils literal notranslate"><span class="pre">pgaudit</span></code> extension was enabled.</p>
</li>
<li><p>Fix issue with mixed setups: primary on pre-Patroni v4 and replicas on v4+ (Alexander Kukushkin)</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">xlog_location</span></code> extracted from <code class="docutils literal notranslate"><span class="pre">/members</span></code> key instead of trying to get a member’s slot position from <code class="docutils literal notranslate"><span class="pre">/status</span></code> key if Patroni version running on the leader is pre-4.0.0. Not doing so has been causing WALs accumulation on replicas.</p>
</li>
<li><p>Do not ignore valid PostgreSQL GUCs that don’t have Patroni validator (Polina Bungina)</p>
<p>Still check against <code class="docutils literal notranslate"><span class="pre">postgres</span> <span class="pre">--describe-config</span></code> if a GUC does not have a Patroni validator but is, in fact, a valid GUC.</p>
</li>
</ul>
<p><strong>Improvements</strong></p>
<ul>
<li><p>Recheck annotations on 409 status code when reading leader object in K8s (Alexander Kukushkin)</p>
<p>Avoid an additional update if <code class="docutils literal notranslate"><span class="pre">PATCH</span></code> request was canceled by Patroni, while the request successfully updated the target.</p>
</li>
<li><p>Add support of <code class="docutils literal notranslate"><span class="pre">sslnegotiation</span></code> client-side connection option (Alexander Kukushkin)</p>
<p><code class="docutils literal notranslate"><span class="pre">sslnegotiation</span></code> was added to the final PostgreSQL 17 release.</p>
</li>
</ul>
</section>
<section id="version-4-0-2">
<h2>Version 4.0.2<a class="headerlink" href="#version-4-0-2" title="Link to this heading"></a></h2>
<p>Released 2024-09-17</p>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Handle exceptions while discovering configuration validation files (Alexander Kukushkin)</p>
<p>Skip directories for which Patroni does not have sufficient permissions to perform list operations.</p>
</li>
<li><p>Make sure inactive hot physical replication slots don’t hold <code class="docutils literal notranslate"><span class="pre">xmin</span></code> (Alexander Kukushkin, Polina Bungina)</p>
<p>Since version 3.2.0 Patroni creates physical replication slots for all members on replicas and periodically moves them forward using <code class="docutils literal notranslate"><span class="pre">pg_replication_slot_advance()</span></code> function. However if for any reason <code class="docutils literal notranslate"><span class="pre">hot_standby_feedback</span></code> is enabled and the primary is demoted to replica, the now inactive slots have <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> <code class="docutils literal notranslate"><span class="pre">xmin</span></code> value propagated back to the new primary. This results in <code class="docutils literal notranslate"><span class="pre">xmin</span></code> horizon not being moved forward and vacuum not being able to clean up dead tuples. With this fix, Patroni recreates the physical replication slots that are supposed to be inactive but have <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> <code class="docutils literal notranslate"><span class="pre">xmin</span></code> value.</p>
</li>
<li><p>Fix unhandled <code class="docutils literal notranslate"><span class="pre">DCSError</span></code> during the startup phase (Waynerv)</p>
<p>Ensure DCS connectivity before trying to check the uniqueness of the node name.</p>
</li>
<li><p>Explicitly include <code class="docutils literal notranslate"><span class="pre">CMDLINE_OPTIONS</span></code> GUCs when querying <code class="docutils literal notranslate"><span class="pre">pg_settings</span></code> (Alexander Kukushkin)</p>
<p>Make sure all GUCs that are passed to postmaster as command line parameters are restored when Patroni is joining a running standby. This is a follow-up for the bug fixed in Patroni 3.2.2.</p>
</li>
<li><p>Fix bug in <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code> quotting logic (Alexander Kukushkin)</p>
<p>According to PostgreSQL documentation, <code class="docutils literal notranslate"><span class="pre">ANY</span></code> and <code class="docutils literal notranslate"><span class="pre">FIRST</span></code> keywords are supposed to be double-quoted, which Patroni did not do before.</p>
</li>
<li><p>Fix keepalive connection out-of-range issue (hadizamani021)</p>
<p>Ensure that <code class="docutils literal notranslate"><span class="pre">keepalive</span></code> option value calculated based on the <code class="docutils literal notranslate"><span class="pre">ttl</span></code> set does not exceed the maximum allowed value for the current platform.</p>
</li>
</ul>
</section>
<section id="version-4-0-1">
<h2>Version 4.0.1<a class="headerlink" href="#version-4-0-1" title="Link to this heading"></a></h2>
<p>Released 2024-08-30</p>
<p><strong>Bugfix</strong></p>
<ul>
<li><p>Patroni was creating unnecessary replication slots for itself (Alexander Kukushkin)</p>
<p>It was happening if <code class="docutils literal notranslate"><span class="pre">name</span></code> contains upper-case or special characters.</p>
</li>
</ul>
</section>
<section id="version-4-0-0">
<h2>Version 4.0.0<a class="headerlink" href="#version-4-0-0" title="Link to this heading"></a></h2>
<p>Released 2024-08-29</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<ul class="simple">
<li><p>This version completes work on getting rid of the “master” term, in favor of “primary”. This means a couple of breaking changes, please read the release notes carefully. Upgrading to the Patroni 4+ will work reliably only if you run Patroni 3.1.0 or newer. Upgrading from an older version directly to 4+ is possible but may lead to unexpected behavior if the primary fails while the rest of the nodes are running on other Patroni versions.</p></li>
</ul>
</div>
<p><strong>Breaking changes</strong></p>
<ul class="simple">
<li><p>The following breaking changes were introduced when getting rid of the non-inclusive “master” term in the Patroni code:</p>
<ul>
<li><p>On Kubernetes, Patroni by default will set <code class="docutils literal notranslate"><span class="pre">role</span></code> label to <code class="docutils literal notranslate"><span class="pre">primary</span></code>. In case if you want to keep the old behavior and avoid downtime or lengthy complex migrations, you can configure parameters <code class="docutils literal notranslate"><span class="pre">kubernetes.leader_label_value</span></code> and <code class="docutils literal notranslate"><span class="pre">kubernetes.standby_leader_label_value</span></code> to <code class="docutils literal notranslate"><span class="pre">master</span></code>. Read more <a class="reference internal" href="kubernetes.html#kubernetes-role-values"><span class="std std-ref">here</span></a>.</p></li>
<li><p>Patroni role is written to DCS as <code class="docutils literal notranslate"><span class="pre">primary</span></code> instead of <code class="docutils literal notranslate"><span class="pre">master</span></code>.</p></li>
<li><p>Patroni role returned by Patroni REST API has been changed from <code class="docutils literal notranslate"><span class="pre">master</span></code> to <code class="docutils literal notranslate"><span class="pre">primary</span></code>.</p></li>
<li><p>Patroni REST API no longer accepts <code class="docutils literal notranslate"><span class="pre">role=master</span></code> in requests to <code class="docutils literal notranslate"><span class="pre">/switchover</span></code>, <code class="docutils literal notranslate"><span class="pre">/failover</span></code>, <code class="docutils literal notranslate"><span class="pre">/restart</span></code> endpoints.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/metrics</span></code> REST API endpoint will no longer report <code class="docutils literal notranslate"><span class="pre">patroni_master</span></code> metric.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">patronictl</span></code> no longer accepts <code class="docutils literal notranslate"><span class="pre">--master</span></code> option for any command. <code class="docutils literal notranslate"><span class="pre">--leader</span></code> or <code class="docutils literal notranslate"><span class="pre">--primary</span></code> options should be used instead.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">no_master</span></code> option in the declarative configuration of custom replica creation methods is no longer treated as a special option, please use <code class="docutils literal notranslate"><span class="pre">no_leader</span></code> instead.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">patroni_wale_restore</span></code> script doesn’t accept <code class="docutils literal notranslate"><span class="pre">--no_master</span></code> option anymore.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">patroni_barman</span></code> script doesn’t accept <code class="docutils literal notranslate"><span class="pre">--role=master</span></code> option anymore.</p></li>
<li><p>All callback scripts are executed with <code class="docutils literal notranslate"><span class="pre">role=primary</span></code> option passed instead of <code class="docutils literal notranslate"><span class="pre">role=master</span></code>.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">failover</span></code> does not accept <code class="docutils literal notranslate"><span class="pre">--leader</span></code> option that was deprecated since Patroni 3.2.0.</p></li>
<li><p>User creation functionality (<code class="docutils literal notranslate"><span class="pre">bootstrap.users</span></code> configuration section) deprecated since Patroni 3.2.0 has been removed.</p></li>
</ul>
<p><strong>New features</strong></p>
<ul>
<li><p>Quorum-based failover (Ants Aasma, Alexander Kukushkin)</p>
<p>The feature implements quorum-based synchronous replication (available from PostgreSQL v10) which helps to reduce worst-case latencies, even during normal operation, as a higher latency of replicating to one standby can be compensated by other standbys. Patroni implements additional safeguards to prevent any user-visible data loss by choosing a failover candidate based on the latest transaction received.</p>
</li>
<li><p>Register Citus secondaries in <code class="docutils literal notranslate"><span class="pre">pg_dist_node</span></code> (Alexander Kukushkin)</p>
<p>Patroni now maintains the list of nodes with <code class="docutils literal notranslate"><span class="pre">role==replica</span></code>, <code class="docutils literal notranslate"><span class="pre">state==running</span></code> and without <code class="docutils literal notranslate"><span class="pre">noloadbalance</span></code> <a class="reference internal" href="yaml_configuration.html#tags-settings"><span class="std std-ref">tag</span></a> in <code class="docutils literal notranslate"><span class="pre">pg_dist_node</span></code>.</p>
</li>
<li><p>Configurable retention of members’ replication slots (Alexander Kukushkin)</p>
<p>Implements support of <code class="docutils literal notranslate"><span class="pre">member_slots_ttl</span></code> global configuration parameter that controls for how long member replication slots should be kept around when the member key is absent.</p>
</li>
<li><p>Make permissions of log files created by Patroni configurable (Alexander Kukushkin)</p>
<p>Allows to set specific permissions for log files created by Patroni. If not specified, permissions are set based on the current <code class="docutils literal notranslate"><span class="pre">umask</span></code> value.</p>
</li>
<li><p>Compatibility with PostgreSQL 17 beta3 (Alexander Kukushkin)</p>
<p>GUC’s validator rules were extended. Patroni handles all the new auxiliary backends during shutdown and sets <code class="docutils literal notranslate"><span class="pre">dbname</span></code> in <code class="docutils literal notranslate"><span class="pre">primary_conninfo</span></code>, as it is required for logical replication slots synchronization.</p>
</li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">--ignore-listen-port</span></code> option for Patroni config validation (Sahil Naphade)</p>
<p>Make it possible to ignore already bound ports when running <code class="docutils literal notranslate"><span class="pre">patroni</span> <span class="pre">--validate-config</span></code>.</p>
</li>
</ul>
<p><strong>Improvements</strong></p>
<ul>
<li><p>Make <code class="docutils literal notranslate"><span class="pre">wal_log_hints</span></code> configurable (Paul_Kim)</p>
<p>Allows to avoid the overhead of <code class="docutils literal notranslate"><span class="pre">wal_log_hints</span></code> configuration being enabled in case <code class="docutils literal notranslate"><span class="pre">use_pg_rewind</span></code> is set to <code class="docutils literal notranslate"><span class="pre">off</span></code>.</p>
</li>
<li><p>Log <code class="docutils literal notranslate"><span class="pre">pg_basebackup</span></code> command in <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> level (Waynerv)</p>
<p>Facilitates failed initialization debugging.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Advance permanent slots for cascading nodes while in failsafe (Alexander Kukushkin)</p>
<p>Ensure that slots for cascading replicas are properly advanced on the primary when failsafe mode is activated. It is done by extending replicas response on <code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/failsafe</span></code> REST API request with their <code class="docutils literal notranslate"><span class="pre">xlog_location</span></code>.</p>
</li>
<li><p>Don’t let the current node be chosen as synchronous (Alexander Kukushkin)</p>
<p>There may be “something” streaming from the current primary node with <code class="docutils literal notranslate"><span class="pre">application_name</span></code> that matches the name of the current primary. Patroni was not properly handling this situation, which could end up in the primary being declared as a synchronous node and consequently was blocking switchovers.</p>
</li>
<li><p>Ignore <code class="docutils literal notranslate"><span class="pre">restapi.allowlist_include_members</span></code> for POST /failsafe (Alexander Kukushkin)</p></li>
<li><p>Improve GUCs validation (Polina Bungina)</p>
<p>Due to additional validation through running <code class="docutils literal notranslate"><span class="pre">postgres</span> <span class="pre">--describe-config</span></code> command, it was previously not possible to set GUCs not listed there through Patroni configuration. This limitation is now removed.</p>
</li>
<li><p>Add line with <code class="docutils literal notranslate"><span class="pre">localhost</span></code> to <code class="docutils literal notranslate"><span class="pre">.pgpass</span></code> file when unix sockets are detected (Alexander Kukushkin)</p>
<p>Patroni will add an additional line to <code class="docutils literal notranslate"><span class="pre">.pgpass</span></code> file if <code class="docutils literal notranslate"><span class="pre">host</span></code> parameter specified starts with <code class="docutils literal notranslate"><span class="pre">/</span></code> character. This allows to cover a corner case when <code class="docutils literal notranslate"><span class="pre">host</span></code> matches the default socket directory path.</p>
</li>
<li><p>Fix logging issues (Waynerv)</p>
<p>Defined proper request URL in failsafe handling logs and fixed the order of timestamps in postmaster check log.</p>
</li>
</ul>
</section>
<section id="version-3-3-2">
<h2>Version 3.3.2<a class="headerlink" href="#version-3-3-2" title="Link to this heading"></a></h2>
<p>Released 2024-07-11</p>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Fix plain Postgres synchronous replication mode (Israel Barth Rubio)</p>
<p>Since <code class="docutils literal notranslate"><span class="pre">synchronous_mode</span></code> was introduced to Patroni, the plain Postgres synchronous replication was not working. With this bugfix, Patroni sets the value of <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code> as configured by the user, if that is the case, when <code class="docutils literal notranslate"><span class="pre">synchronous_mode</span></code> is disabled.</p>
</li>
<li><p>Handle logical slots invalidation on a standby (Polina Bungina)</p>
<p>Since PG16 logical replication slots on a standby can be invalidated due to horizon: from now on, Patroni forces copy (i.e., recreation) of invalidated slots.</p>
</li>
<li><p>Fix race condition with logical slot advance and copy (Alexander Kukushkin)</p>
<p>Due to this bug, it was a possible situation when an invalidated logical replication slot was copied with PostgreSQL restart more than once.</p>
</li>
</ul>
</section>
<section id="version-3-3-1">
<h2>Version 3.3.1<a class="headerlink" href="#version-3-3-1" title="Link to this heading"></a></h2>
<p>Released 2024-06-17</p>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Compatibility with Python 3.12 (Alexander Kukushkin)</p>
<p>Handle a new attribute added to <code class="docutils literal notranslate"><span class="pre">logging.LogRecord</span></code>.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Fix infinite recursion in <code class="docutils literal notranslate"><span class="pre">replicatefrom</span></code> tags handling (Alexander Kukushkin)</p>
<p>As a part of this fix, also improve <code class="docutils literal notranslate"><span class="pre">is_physical_slot()</span></code> check and adjust documentation.</p>
</li>
<li><p>Fix wrong role reporting in standby clusters (Alexander Kukushkin)</p>
<p><code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code> and synchronous replication only work on a real primary node and in the case of cascading replication are simply ignored by Postgres. Before this fix, <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">list</span></code> and <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/cluster</span></code> were falsely reporting some nodes as synchronous.</p>
</li>
<li><p>Fix availability of the <code class="docutils literal notranslate"><span class="pre">allow_in_place_tablespaces</span></code> GUC (Polina Bungina)</p>
<p><code class="docutils literal notranslate"><span class="pre">allow_in_place_tablespaces</span></code> was not only added to PostgreSQL 15 but also backpatched to PostgreSQL 10-14.</p>
</li>
</ul>
</section>
<section id="version-3-3-0">
<h2>Version 3.3.0<a class="headerlink" href="#version-3-3-0" title="Link to this heading"></a></h2>
<p>Released 2024-04-04</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>All older Partoni versions are not compatible with <code class="docutils literal notranslate"><span class="pre">ydiff&gt;=1.3</span></code>.</p>
<p>There are the following options available to “fix” the problem:</p>
<ol class="arabic simple">
<li><p>upgrade Patroni to the latest version</p></li>
<li><p>install <code class="docutils literal notranslate"><span class="pre">ydiff&lt;1.3</span></code> after installing Patroni</p></li>
<li><p>install <code class="docutils literal notranslate"><span class="pre">cdiff</span></code> module</p></li>
</ol>
</div>
<p><strong>New features</strong></p>
<ul>
<li><p>Add ability to pass <code class="docutils literal notranslate"><span class="pre">auth_data</span></code> to Zookeeper client (Aras Mumcuyan)</p>
<p>It allows to specify the authentication credentials to use for the connection.</p>
</li>
<li><p>Add a contrib script for <code class="docutils literal notranslate"><span class="pre">Barman</span></code> integration (Israel Barth Rubio)</p>
<p>Provide an application <code class="docutils literal notranslate"><span class="pre">patroni_barman</span></code> that allows to perform <code class="docutils literal notranslate"><span class="pre">Barman</span></code> operations remotely and can be used as a custom bootstrap/custom replica method or as an <code class="docutils literal notranslate"><span class="pre">on_role_change</span></code> callback. Please check <a class="reference internal" href="tools_integration.html#tools-integration"><span class="std std-ref">here</span></a> for more information.</p>
</li>
<li><p>Support <code class="docutils literal notranslate"><span class="pre">JSON</span></code> log format (alisalemmi)</p>
<p>Apart from <code class="docutils literal notranslate"><span class="pre">plain</span></code> (default), Patroni now also supports <code class="docutils literal notranslate"><span class="pre">json</span></code> log format. Requires <code class="docutils literal notranslate"><span class="pre">python-json-logger&gt;=2.0.2</span></code> library to be installed.</p>
</li>
<li><p>Show <code class="docutils literal notranslate"><span class="pre">pending_restart_reason</span></code> information (Polina Bungina)</p>
<p>Provide extended information about the PostgreSQL parameters that caused <code class="docutils literal notranslate"><span class="pre">pending_restart</span></code> flag to be set. Both <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">list</span></code> and <code class="docutils literal notranslate"><span class="pre">/patroni</span></code> REST API endpoint now show the parameters names and their “diff” as <code class="docutils literal notranslate"><span class="pre">pending_restart_reason</span></code>.</p>
</li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">nostream</span></code> tag (Grigory Smolkin)</p>
<p>If <code class="docutils literal notranslate"><span class="pre">nostream</span></code> tag is set to <code class="docutils literal notranslate"><span class="pre">true</span></code>, the node will not use replication protocol to stream WAL but instead rely on archive recovery (if <code class="docutils literal notranslate"><span class="pre">restore_command</span></code> is configured). It also disables copying and synchronization of permanent logical replication slots on the node itself and all its cascading replicas.</p>
</li>
</ul>
<p><strong>Improvements</strong></p>
<ul>
<li><p>Implement validation of the <code class="docutils literal notranslate"><span class="pre">log</span></code> section (Alexander Kukushkin)</p>
<p>Until now validator was not checking the correctness of the logging configuration provided.</p>
</li>
<li><p>Improve logging for PostgreSQL parameters change (Polina Bungina)</p>
<p>Convert old values to a human-readable format and log information about the <code class="docutils literal notranslate"><span class="pre">pg_controldata</span></code> vs Patroni global configuration mismatch.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Properly filter out not allowed <code class="docutils literal notranslate"><span class="pre">pg_basebackup</span></code> options (Israel Barth Rubio)</p>
<p>Due to a bug, Patroni was not properly filtering out the not allowed options configured for the <code class="docutils literal notranslate"><span class="pre">basebackup</span></code> replica bootstrap method, when provided in the <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">setting:</span> <span class="pre">value</span></code> format.</p>
</li>
<li><p>Fix <code class="docutils literal notranslate"><span class="pre">etcd3</span></code> authentication error handling (Alexander Kukushkin)</p>
<p>Always retry one time on <code class="docutils literal notranslate"><span class="pre">etcd3</span></code> authentication error if authentication was not done right before executing the request. Also, do not restart watchers on reauthentication.</p>
</li>
<li><p>Improve logic of the validator files discovery (Waynerv)</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">importlib</span></code> library to discover the files with available configuration parameters when possible (for Python 3.9+). This implementation is more stable and doesn’t break the Patroni distributions based on <code class="docutils literal notranslate"><span class="pre">zip</span></code> archives.</p>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">target_session_attrs</span></code> only when multiple hosts are specified in the <code class="docutils literal notranslate"><span class="pre">standby_cluster</span></code> section (Alexander Kukushkin)</p>
<p><code class="docutils literal notranslate"><span class="pre">target_session_attrs=read-write</span></code> is now added to the <code class="docutils literal notranslate"><span class="pre">primary_conninfo</span></code> on the standby leader node only when <code class="docutils literal notranslate"><span class="pre">standby_cluster.host</span></code> section contains multiple hosts separated by commas.</p>
</li>
<li><p>Add compatibility code for <code class="docutils literal notranslate"><span class="pre">ydiff</span></code> library version 1.3+ (Alexander Kukushkin)</p>
<p>Patroni is relying on some API from <code class="docutils literal notranslate"><span class="pre">ydiff</span></code> that is not public because it is supposed to be just a terminal tool rather than a python module. Unfortunately, the API change in 1.3 broke old Patroni versions.</p>
</li>
</ul>
</section>
<section id="version-3-2-2">
<h2>Version 3.2.2<a class="headerlink" href="#version-3-2-2" title="Link to this heading"></a></h2>
<p>Released 2024-01-17</p>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Don’t let replica restore initialize key when DCS was wiped (Alexander Kukushkin)</p>
<p>It was happening in the method where Patroni was supposed to take over a standalone PG cluster.</p>
</li>
<li><p>Use consistent read when fetching just updated sync key from Consul (Alexander Kukushkin)</p>
<p>Consul doesn’t provide any interface to immediately get <code class="docutils literal notranslate"><span class="pre">ModifyIndex</span></code> for the key that we just updated, therefore we have to perform an explicit read operation. Since stale reads are allowed by default, we sometimes used to get an outdated version of the key.</p>
</li>
<li><p>Reload Postgres config if a parameter that requires restart was reset to the original value (Polina Bungina)</p>
<p>Previously Patroni wasn’t updating the config, but only resetting the <code class="docutils literal notranslate"><span class="pre">pending_restart</span></code>.</p>
</li>
<li><p>Fix erroneous inverted logic of the confirmation prompt message when doing a failover to an async candidate in synchronous mode (Polina Bungina)</p>
<p>The problem existed only in <code class="docutils literal notranslate"><span class="pre">patronictl</span></code>.</p>
</li>
<li><p>Exclude leader from failover candidates in <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> (Polina Bungina)</p>
<p>If the cluster is healthy, failing over to an existing leader is no-op.</p>
</li>
<li><p>Create Citus database and extension idempotently (Alexander Kukushkin, Zhao Junwang)</p>
<p>It will allow to create them in the <code class="docutils literal notranslate"><span class="pre">post_bootstrap</span></code> script in case if there is a need to add some more dependencies to the Citus database.</p>
</li>
<li><p>Don’t filter our contradictory <code class="docutils literal notranslate"><span class="pre">nofailover</span></code> tag (Polina Bungina)</p>
<p>The configuration <code class="docutils literal notranslate"><span class="pre">{nofailover:</span> <span class="pre">false,</span> <span class="pre">failover_priority:</span> <span class="pre">0}</span></code> set on a node didn’t allow it to participate in the race, while it should, because <code class="docutils literal notranslate"><span class="pre">nofailover</span></code> tag should take precedence.</p>
</li>
<li><p>Fixed PyInstaller frozen issue (Sophia Ruan)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">freeze_support()</span></code> was called after <code class="docutils literal notranslate"><span class="pre">argparse</span></code> and as a result, Patroni wasn’t able to start Postgres.</p>
</li>
<li><p>Fixed bug in the config generator for <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> and <code class="docutils literal notranslate"><span class="pre">Citus</span></code> configuration (Israel Barth Rubio)</p>
<p>It prevented <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> and <code class="docutils literal notranslate"><span class="pre">Citus</span></code> configuration parameters set via environment variables from being written into the generated config.</p>
</li>
<li><p>Restore recovery GUCs and some Patroni-managed parameters when joining a running standby (Alexander Kukushkin)</p>
<p>Patroni was failing to restart Postgres v12 onwards with an error about missing <code class="docutils literal notranslate"><span class="pre">port</span></code> in one of the internal structures.</p>
</li>
<li><p>Fixes around <code class="docutils literal notranslate"><span class="pre">pending_restart</span></code> flag (Polina Bungina)</p>
<p>Don’t expose <code class="docutils literal notranslate"><span class="pre">pending_restart</span></code> when in custom bootstrap with <code class="docutils literal notranslate"><span class="pre">recovery_target_action</span> <span class="pre">=</span> <span class="pre">promote</span></code> or when someone changed <code class="docutils literal notranslate"><span class="pre">hot_standby</span></code> or <code class="docutils literal notranslate"><span class="pre">wal_log_hints</span></code> using for example <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span></code>.</p>
</li>
</ul>
</section>
<section id="version-3-2-1">
<h2>Version 3.2.1<a class="headerlink" href="#version-3-2-1" title="Link to this heading"></a></h2>
<p>Released 2023-11-30</p>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Limit accepted values for <code class="docutils literal notranslate"><span class="pre">--format</span></code> argument in <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> (Alexander Kukushkin)</p>
<p>It used to accept any arbitrary string and produce no output if the value wasn’t recognized.</p>
</li>
<li><p>Verify that replica nodes received checkpoint LSN on shutdown before releasing the leader key (Alexander Kukushkin)</p>
<p>Previously in some cases, we were using LSN of the SWITCH record that is followed by CHECKPOINT (if archiving mode is enabled). As a result the former primary sometimes had to do <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code>, but there would be no data loss involved.</p>
</li>
<li><p>Do a real HTTP request when performing node name uniqueness check (Alexander Kukushkin)</p>
<p>When running Patroni in containers it is possible that the traffic is routed using <code class="docutils literal notranslate"><span class="pre">docker-proxy</span></code>, which listens on the port and accepts incoming connections. It was causing false positives.</p>
</li>
<li><p>Fixed Citus support with Etcd v2 (Alexander Kukushkin)</p>
<p>Patroni was failing to deploy a new Citus cluster with Etcd v2.</p>
</li>
<li><p>Fixed <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> behavior with Postgres v16+ (Alexander Kukushkin)</p>
<p>The error message format of <code class="docutils literal notranslate"><span class="pre">pg_waldump</span></code> changed in v16 which caused <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> to be called by Patroni even when it was not necessary.</p>
</li>
<li><p>Fixed bug with custom bootstrap (Alexander Kukushkin)</p>
<p>Patroni was falsely applying <code class="docutils literal notranslate"><span class="pre">--command</span></code> argument, which is a bootstrap command itself.</p>
</li>
<li><p>Fixed the issue with REST API health check endpoints (Sophia Ruan)</p>
<p>There were chances that after Postgres restart it could return <code class="docutils literal notranslate"><span class="pre">unknown</span></code> state for Postgres because connections were not properly closed.</p>
</li>
<li><p>Cache <code class="docutils literal notranslate"><span class="pre">postgres</span> <span class="pre">--describe-config</span></code> output results (Waynerv)</p>
<p>They are used to figure out which GUCs are available to validate PostgreSQL configuration and we don’t expect this list to change while Patroni is running.</p>
</li>
</ul>
</section>
<section id="version-3-2-0">
<h2>Version 3.2.0<a class="headerlink" href="#version-3-2-0" title="Link to this heading"></a></h2>
<p>Released 2023-10-25</p>
<p><strong>Deprecation notice</strong></p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">bootstrap.users</span></code> support will be removed in version 4.0.0. If you need to create users after deploying a new cluster please use the <code class="docutils literal notranslate"><span class="pre">bootstrap.post_bootstrap</span></code> hook for that.</p></li>
</ul>
<p><strong>Breaking changes</strong></p>
<ul>
<li><p>Enforce <code class="docutils literal notranslate"><span class="pre">loop_wait</span> <span class="pre">+</span> <span class="pre">2*retry_timeout</span> <span class="pre">&lt;=</span> <span class="pre">ttl</span></code> rule and hard-code minimal possible values (Alexander Kukushkin)</p>
<p>Minimal values: <code class="docutils literal notranslate"><span class="pre">loop_wait=2</span></code>, <code class="docutils literal notranslate"><span class="pre">retry_timeout=3</span></code>, <code class="docutils literal notranslate"><span class="pre">ttl=20</span></code>. In case values are smaller or violate the rule they are adjusted and a warning is written to Patroni logs.</p>
</li>
</ul>
<p><strong>New features</strong></p>
<ul>
<li><p>Failover priority (Mark Pekala)</p>
<p>With the help of <code class="docutils literal notranslate"><span class="pre">tags.failover_priority</span></code> it’s now possible to make a node more preferred during the leader race. More details in the documentation (ref tags).</p>
</li>
<li><p>Implemented <code class="docutils literal notranslate"><span class="pre">patroni</span> <span class="pre">--generate-config</span> <span class="pre">[--dsn</span> <span class="pre">DSN]</span></code> and <code class="docutils literal notranslate"><span class="pre">patroni</span> <span class="pre">--generate-sample-config</span></code> (Polina Bungina)</p>
<p>It allows to generate a config file for the running PostgreSQL cluster or a sample config file for the new Patroni cluster.</p>
</li>
<li><p>Use a dedicated connection to Postgres for Patroni REST API (Alexander Kukushkin)</p>
<p>It helps to avoid blocking the main heartbeat loop if the system is under stress.</p>
</li>
<li><p>Enrich some endpoints with the <code class="docutils literal notranslate"><span class="pre">name</span></code> of the node (sskserk)</p>
<p>For the monitoring endpoint <code class="docutils literal notranslate"><span class="pre">name</span></code> is added next to the <code class="docutils literal notranslate"><span class="pre">scope</span></code> and for metrics endpoint the <code class="docutils literal notranslate"><span class="pre">name</span></code> is added to tags.</p>
</li>
<li><p>Ensure strict failover/switchover difference (Polina Bungina)</p>
<p>Be more precise in log messages and allow failing over to an asynchronous node in a healthy synchronous cluster.</p>
</li>
<li><p>Make permanent physical replication slots behave similarly to permanent logical slots (Alexander Kukushkin)</p>
<p>Create permanent physical replication slots on all nodes that are allowed to become the leader and use <code class="docutils literal notranslate"><span class="pre">pg_replication_slot_advance()</span></code> function to advance <code class="docutils literal notranslate"><span class="pre">restart_lsn</span></code> for slots on standby nodes.</p>
</li>
<li><p>Add capability of specifying namespace through <code class="docutils literal notranslate"><span class="pre">--dcs</span></code> argument in <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> (Israel Barth Rubio)</p>
<p>It could be handy if <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> is used without a configuration file.</p>
</li>
<li><p>Add support for additional parameters in custom bootstrap configuration (Israel Barth Rubio)</p>
<p>Previously it was only possible to add custom arguments to the <code class="docutils literal notranslate"><span class="pre">command</span></code> and now one could list them as a mapping.</p>
</li>
</ul>
<p><strong>Improvements</strong></p>
<ul>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">citus.local_hostname</span></code> GUC to the same value which is used by Patroni to connect to the Postgres (Alexander Kukushkin)</p>
<p>There are cases when Citus wants to have a connection to the local Postgres. By default it uses <code class="docutils literal notranslate"><span class="pre">localhost</span></code>, which is not always available.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Ignore <code class="docutils literal notranslate"><span class="pre">synchronous_mode</span></code> setting in a standby cluster (Polina Bungina)</p>
<p>Postgres doesn’t support cascading synchronous replication and not ignoring <code class="docutils literal notranslate"><span class="pre">synchronous_mode</span></code> was breaking a switchover in a standby cluster.</p>
</li>
<li><p>Handle SIGCHLD for <code class="docutils literal notranslate"><span class="pre">on_reload</span></code> callback (Alexander Kukushkin)</p>
<p>Not doing so results in a zombie process, which is reaped only when the next <code class="docutils literal notranslate"><span class="pre">on_reload</span></code> is executed.</p>
</li>
<li><p>Handle <code class="docutils literal notranslate"><span class="pre">AuthOldRevision</span></code> error when working with Etcd v3 (Alexander Kukushkin, Kenny Do)</p>
<p>The error is raised if Etcd is configured to use JWT and when the user database in Etcd is updated.</p>
</li>
</ul>
</section>
<section id="version-3-1-2">
<h2>Version 3.1.2<a class="headerlink" href="#version-3-1-2" title="Link to this heading"></a></h2>
<p>Released 2023-09-26</p>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Fixed bug with <code class="docutils literal notranslate"><span class="pre">wal_keep_size</span></code> checks (Alexander Kukushkin)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">wal_keep_size</span></code> is a GUC that normally has a unit and Patroni was failing to cast its value to <code class="docutils literal notranslate"><span class="pre">int</span></code>. As a result the value of <code class="docutils literal notranslate"><span class="pre">bootstrap.dcs</span></code> was not written to the <code class="docutils literal notranslate"><span class="pre">/config</span></code> key afterwards.</p>
</li>
<li><p>Detect and resolve inconsistencies between <code class="docutils literal notranslate"><span class="pre">/sync</span></code> key and <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code> (Alexander Kukushkin)</p>
<p>Normally, Patroni updates <code class="docutils literal notranslate"><span class="pre">/sync</span></code> and <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code> in a very specific order, but in case of a bug or when someone manually reset <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code>, Patroni was getting into an inconsistent state. As a result it was possible that the failover happens to an asynchronous node.</p>
</li>
<li><p>Read GUC’s values when joining running Postgres (Alexander Kukushkin)</p>
<p>When restarted in <code class="docutils literal notranslate"><span class="pre">pause</span></code>, Patroni was discarding the <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code> GUC from the <code class="docutils literal notranslate"><span class="pre">postgresql.conf</span></code>. To solve it and avoid similar issues, Patroni will read GUC’s value if it is joining an already running Postgres.</p>
</li>
<li><p>Silenced annoying warnings when checking for node uniqueness (Alexander Kukushkin)</p>
<p><code class="docutils literal notranslate"><span class="pre">WARNING</span></code> messages are produced by <code class="docutils literal notranslate"><span class="pre">urllib3</span></code> if Patroni is quickly restarted.</p>
</li>
</ul>
</section>
<section id="version-3-1-1">
<h2>Version 3.1.1<a class="headerlink" href="#version-3-1-1" title="Link to this heading"></a></h2>
<p>Released 2023-09-20</p>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Reset failsafe state on promote (ChenChangAo)</p>
<p>If switchover/failover happened shortly after failsafe mode had been activated, the newly promoted primary was demoting itself after failsafe becomes inactive.</p>
</li>
<li><p>Silence useless warnings in <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> (Alexander Kukushkin)</p>
<p>If <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> uses the same patroni.yaml file as Patroni and can access <code class="docutils literal notranslate"><span class="pre">PGDATA</span></code> directory it might have been showing annoying warnings about incorrect values in the global configuration.</p>
</li>
<li><p>Explicitly enable synchronous mode for a corner case (Alexander Kukushkin)</p>
<p>Synchronous mode effectively was never activated if there are no replicas streaming from the primary.</p>
</li>
<li><p>Fixed bug with <code class="docutils literal notranslate"><span class="pre">0</span></code> integer values validation (Israel Barth Rubio)</p>
<p>In most cases, it didn’t cause any issues, just warnings.</p>
</li>
<li><p>Don’t return logical slots for standby cluster (Alexander Kukushkin)</p>
<p>Patroni can’t create logical replication slots in the standby cluster, thus they should be ignored if they are defined in the global configuration.</p>
</li>
<li><p>Avoid showing docstring in <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">--help</span></code> output (Israel Barth Rubio)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">click</span></code> module needs to get a special hint for that.</p>
</li>
<li><p>Fixed bug with <code class="docutils literal notranslate"><span class="pre">kubernetes.standby_leader_label_value</span></code> (Alexander Kukushkin)</p>
<p>This feature effectively never worked.</p>
</li>
<li><p>Returned cluster system identifier to the <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">list</span></code> output (Polina Bungina)</p>
<p>The problem was introduced while implementing the support for Citus, where we need to hide the identifier because it is different for coordinator and all workers.</p>
</li>
<li><p>Override <code class="docutils literal notranslate"><span class="pre">write_leader_optime</span></code> method in Kubernetes implementation (Alexander Kukushkin)</p>
<p>The method is supposed to write shutdown LSN to the leader Endpoint/ConfigMap when there are no healthy replicas available to become the new primary.</p>
</li>
<li><p>Don’t start stopped postgres in pause (Alexander Kukushkin)</p>
<p>Due to a race condition, Patroni was falsely assuming that the standby should be restarted because some recovery parameters (<code class="docutils literal notranslate"><span class="pre">primary_conninfo</span></code> or similar) were changed.</p>
</li>
<li><p>Fixed bug in <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">query</span></code> command (Israel Barth Rubio)</p>
<p>It didn’t work when only <code class="docutils literal notranslate"><span class="pre">-m</span></code> argument was provided or when none of <code class="docutils literal notranslate"><span class="pre">-r</span></code> or <code class="docutils literal notranslate"><span class="pre">-m</span></code> were provided.</p>
</li>
<li><p>Properly treat integer parameters that are used in the command line to start postgres (Polina Bungina)</p>
<p>If values are supplied as strings and not casted to integer it was resulting in an incorrect calculation of <code class="docutils literal notranslate"><span class="pre">max_prepared_transactions</span></code> based on <code class="docutils literal notranslate"><span class="pre">max_connections</span></code> for Citus clusters.</p>
</li>
<li><p>Don’t rely on <code class="docutils literal notranslate"><span class="pre">pg_stat_wal_receiver</span></code> when deciding on <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> (Alexander Kukushkin)</p>
<p>It could happen that <code class="docutils literal notranslate"><span class="pre">received_tli</span></code> reported by <code class="docutils literal notranslate"><span class="pre">pg_stat_wal_receiver</span></code> is ahead of the actual replayed timeline, while the timeline reported by <code class="docutils literal notranslate"><span class="pre">DENTIFY_SYSTEM</span></code> via replication connection is always correct.</p>
</li>
</ul>
</section>
<section id="version-3-1-0">
<h2>Version 3.1.0<a class="headerlink" href="#version-3-1-0" title="Link to this heading"></a></h2>
<p>Released 2023-08-03</p>
<p><strong>Breaking changes</strong></p>
<ul>
<li><p>Changed semantic of <code class="docutils literal notranslate"><span class="pre">restapi.keyfile</span></code> and <code class="docutils literal notranslate"><span class="pre">restapi.certfile</span></code> (Alexander Kukushkin)</p>
<p>Previously Patroni was using <code class="docutils literal notranslate"><span class="pre">restapi.keyfile</span></code> and <code class="docutils literal notranslate"><span class="pre">restapi.certfile</span></code> as client certificates as a fallback if there were no respective configuration parameters in the <code class="docutils literal notranslate"><span class="pre">ctl</span></code> section.</p>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you enabled client certificates validation (<code class="docutils literal notranslate"><span class="pre">restapi.verify_client</span></code> is set to <code class="docutils literal notranslate"><span class="pre">required</span></code>), you also <strong>must</strong> provide <strong>valid client certificates</strong> in the <code class="docutils literal notranslate"><span class="pre">ctl.certfile</span></code>, <code class="docutils literal notranslate"><span class="pre">ctl.keyfile</span></code>, <code class="docutils literal notranslate"><span class="pre">ctl.keyfile_password</span></code>. If not provided, Patroni will not work correctly.</p>
</div>
<p><strong>New features</strong></p>
<ul>
<li><p>Make Pod role label configurable (Waynerv)</p>
<p>Values could be customized using <code class="docutils literal notranslate"><span class="pre">kubernetes.leader_label_value</span></code>, <code class="docutils literal notranslate"><span class="pre">kubernetes.follower_label_value</span></code> and <code class="docutils literal notranslate"><span class="pre">kubernetes.standby_leader_label_value</span></code> parameters. This feature will be very useful when we change the <code class="docutils literal notranslate"><span class="pre">master</span></code> role to the <code class="docutils literal notranslate"><span class="pre">primary</span></code>. You can read more about the feature and migration steps <a class="reference internal" href="kubernetes.html#kubernetes-role-values"><span class="std std-ref">here</span></a>.</p>
</li>
</ul>
<p><strong>Improvements</strong></p>
<ul>
<li><p>Various improvements of <code class="docutils literal notranslate"><span class="pre">patroni</span> <span class="pre">--validate-config</span></code> (Alexander Kukushkin)</p>
<p>Improved parameter validation for different DCS, <code class="docutils literal notranslate"><span class="pre">bootstrap.dcs</span></code> , <code class="docutils literal notranslate"><span class="pre">ctl</span></code>, <code class="docutils literal notranslate"><span class="pre">restapi</span></code>, and <code class="docutils literal notranslate"><span class="pre">watchdog</span></code> sections.</p>
</li>
<li><p>Start Postgres not in recovery if it crashed during recovery while Patroni is running (Alexander Kukushkin)</p>
<p>It may reduce recovery time and will help to prevent unnecessary timeline increments.</p>
</li>
<li><p>Avoid unnecessary updates of <code class="docutils literal notranslate"><span class="pre">/status</span></code> key (Alexander Kukushkin)</p>
<p>When there are no permanent logical slots Patroni was updating the <code class="docutils literal notranslate"><span class="pre">/status</span></code> on every heartbeat loop even when LSN on the primary didn’t move forward.</p>
</li>
<li><p>Don’t allow stale primary to win the leader race (Alexander Kukushkin)</p>
<p>If Patroni was hanging during a significant time due to lack of resources it will additionally check that no other nodes promoted Postgres before acquiring the leader lock.</p>
</li>
<li><p>Implemented visibility of certain PostgreSQL parameters validation (Alexander Kukushkin, Feike Steenbergen)</p>
<p>If validation of <code class="docutils literal notranslate"><span class="pre">max_connections</span></code>, <code class="docutils literal notranslate"><span class="pre">max_wal_senders</span></code>, <code class="docutils literal notranslate"><span class="pre">max_prepared_transactions</span></code>, <code class="docutils literal notranslate"><span class="pre">max_locks_per_transaction</span></code>, <code class="docutils literal notranslate"><span class="pre">max_replication_slots</span></code>, or <code class="docutils literal notranslate"><span class="pre">max_worker_processes</span></code> failed Patroni was using some sane default value. Now in addition to that it will also show a warning.</p>
</li>
<li><p>Set permissions for files and directories created in <code class="docutils literal notranslate"><span class="pre">PGDATA</span></code> (Alexander Kukushkin)</p>
<p>All files created by Patroni had only owner read/write permissions. This behaviour was breaking backup tools that run under a different user and relying on group read permissions. Now Patroni honors permissions on <code class="docutils literal notranslate"><span class="pre">PGDATA</span></code> and correctly sets permissions on all directories and files it creates inside <code class="docutils literal notranslate"><span class="pre">PGDATA</span></code>.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">archive_command</span></code> through shell (Waynerv)</p>
<p>Patroni might archive some WAL segments before doing crash recovery in a single-user mode or before <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code>. If the archive_command contains some shell operators, like <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code> it didn’t work with Patroni.</p>
</li>
<li><p>Fixed “on switchover” shutdown checks (Polina Bungina)</p>
<p>It was possible that specified candidate is still streaming and didn’t received shut down checking but the leader key was removed because some other nodes were healthy.</p>
</li>
<li><p>Fixed “is primary” check (Alexander Kukushkin)</p>
<p>During the leader race replicas were not able to recognize that Postgres on the old leader is still running as a primary.</p>
</li>
<li><p>Fixed <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">list</span></code> (Alexander Kukushkin)</p>
<p>The Cluster name field was missing in <code class="docutils literal notranslate"><span class="pre">tsv</span></code>, <code class="docutils literal notranslate"><span class="pre">json</span></code>, and <code class="docutils literal notranslate"><span class="pre">yaml</span></code> output formats.</p>
</li>
<li><p>Fixed <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> behaviour after pause (Alexander Kukushkin)</p>
<p>Under certain conditions, Patroni wasn’t able to join the false primary back to the cluster with <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> after coming out of maintenance mode.</p>
</li>
<li><p>Fixed bug in Etcd v3 implementation (Alexander Kukushkin)</p>
<p>Invalidate internal KV cache if key update performed using <code class="docutils literal notranslate"><span class="pre">create_revision</span></code>/<code class="docutils literal notranslate"><span class="pre">mod_revision</span></code> field due to revision mismatch.</p>
</li>
<li><p>Fixed behaviour of replicas in standby cluster in pause (Alexander Kukushkin)</p>
<p>When the leader key expires replicas in standby cluster will not follow the remote node but keep <code class="docutils literal notranslate"><span class="pre">primary_conninfo</span></code> as it is.</p>
</li>
</ul>
</section>
<section id="version-3-0-4">
<h2>Version 3.0.4<a class="headerlink" href="#version-3-0-4" title="Link to this heading"></a></h2>
<p>Released 2023-07-13</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Make the replication status of standby nodes visible (Alexander Kukushkin)</p>
<p>For PostgreSQL 9.6+ Patroni will report the replication state as <code class="docutils literal notranslate"><span class="pre">streaming</span></code> when the standby is streaming from the other node or <code class="docutils literal notranslate"><span class="pre">in</span> <span class="pre">archive</span> <span class="pre">recovery</span></code> when there is no replication connection and <code class="docutils literal notranslate"><span class="pre">restore_command</span></code> is set. The state is visible in <code class="docutils literal notranslate"><span class="pre">member</span></code> keys in DCS, in the REST API, and in <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">list</span></code> output.</p>
</li>
</ul>
<p><strong>Improvements</strong></p>
<ul>
<li><p>Improved error messages with Etcd v3 (Alexander Kukushkin)</p>
<p>When Etcd v3 cluster isn’t accessible Patroni was reporting that it can’t access <code class="docutils literal notranslate"><span class="pre">/v2</span></code> endpoints.</p>
</li>
<li><p>Use quorum read in <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> if it is possible (Alexander Kukushkin)</p>
<p>Etcd or Consul clusters could be degraded to read-only, but from the <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> view everything was fine. Now it will fail with the error.</p>
</li>
<li><p>Prevent splitbrain from duplicate names in configuration (Mark Pekala)</p>
<p>When starting Patroni will check if node with the same name is registered in DCS, and try to query its REST API. If REST API is accessible Patroni exits with an error. It will help to protect from the human error.</p>
</li>
<li><p>Start Postgres not in recovery if it crashed while Patroni is running (Alexander Kukushkin)</p>
<p>It may reduce recovery time and will help from unnecessary timeline increments.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>REST API SSL certificate were not reloaded upon receiving a SIGHUP (Israel Barth Rubio)</p>
<p>Regression was introduced in 3.0.3.</p>
</li>
<li><p>Fixed integer GUCs validation for parameters like <code class="docutils literal notranslate"><span class="pre">max_connections</span></code> (Feike Steenbergen)</p>
<p>Patroni didn’t like quoted numeric values. Regression was introduced in 3.0.3.</p>
</li>
<li><p>Fix issue with <code class="docutils literal notranslate"><span class="pre">synchronous_mode</span></code> (Alexander Kukushkin)</p>
<p>Execute <code class="docutils literal notranslate"><span class="pre">txid_current()</span></code> with <code class="docutils literal notranslate"><span class="pre">synchronous_commit=off</span></code> so it doesn’t accidentally wait for absent synchronous standbys when <code class="docutils literal notranslate"><span class="pre">synchronous_mode_strict</span></code> is enabled.</p>
</li>
</ul>
</section>
<section id="version-3-0-3">
<h2>Version 3.0.3<a class="headerlink" href="#version-3-0-3" title="Link to this heading"></a></h2>
<p>Released 2023-06-22</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Compatibility with PostgreSQL 16 beta1 (Alexander Kukushkin)</p>
<p>Extended GUC’s validator rules.</p>
</li>
<li><p>Make PostgreSQL GUC’s validator extensible (Israel Barth Rubio)</p>
<p>Validator rules are loaded from YAML files located in <code class="docutils literal notranslate"><span class="pre">patroni/postgresql/available_parameters/</span></code> directory. Files are ordered in alphabetical order and applied one after another. It makes possible to have custom validators for non-standard Postgres distributions.</p>
</li>
<li><p>Added <code class="docutils literal notranslate"><span class="pre">restapi.request_queue_size</span></code> option (Andrey Zhidenkov, Aleksei Sukhov)</p>
<p>Sets request queue size for TCP socket used by Patroni REST API. Once the queue is full, further requests get a “Connection denied” error. The default value is 5.</p>
</li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">initdb</span></code> directly when initializing a new cluster (Matt Baker)</p>
<p>Previously it was called via <code class="docutils literal notranslate"><span class="pre">pg_ctl</span></code>, what required a special quoting of parameters passed to <code class="docutils literal notranslate"><span class="pre">initdb</span></code>.</p>
</li>
<li><p>Added before stop hook (Le Duane)</p>
<p>The hook could be configured via <code class="docutils literal notranslate"><span class="pre">postgresql.before_stop</span></code> and is executed right before <code class="docutils literal notranslate"><span class="pre">pg_ctl</span> <span class="pre">stop</span></code>. The exit code doesn’t impact shutdown process.</p>
</li>
<li><p>Added support for custom Postgres binary names (Israel Barth Rubio, Polina Bungina)</p>
<p>When using a custom Postgres distribution it may be the case that the Postgres binaries are compiled with different names other than the ones used by the community Postgres distribution. Custom binary names could be configured using <code class="docutils literal notranslate"><span class="pre">postgresql.bin_name.*</span></code> and <code class="docutils literal notranslate"><span class="pre">PATRONI_POSTGRESQL_BIN_*</span></code> environment variables.</p>
</li>
</ul>
<p><strong>Improvements</strong></p>
<ul>
<li><p>Various improvements of <code class="docutils literal notranslate"><span class="pre">patroni</span> <span class="pre">--validate-config</span></code> (Polina Bungina)</p>
<ul class="simple">
<li><p>Make <code class="docutils literal notranslate"><span class="pre">bootstrap.initdb</span></code> optional. It is only required for new clusters, but <code class="docutils literal notranslate"><span class="pre">patroni</span> <span class="pre">--validate-config</span></code> was complaining if it was missing in the config.</p></li>
<li><p>Don’t error out when <code class="docutils literal notranslate"><span class="pre">postgresql.bin_dir</span></code> is empty or not set. Try to first find Postgres binaries in the default PATH instead.</p></li>
<li><p>Make <code class="docutils literal notranslate"><span class="pre">postgresql.authentication.rewind</span></code> section optional. If it is missing, Patroni is using the superuser.</p></li>
</ul>
</li>
<li><p>Improved error reporting in <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> (Israel Barth Rubio)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">\n</span></code> symbol was rendered as it is, instead of the actual newline symbol.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Fixed issue in Citus support (Alexander Kukushkin)</p>
<p>If the REST API call from the promoted worker to the coordinator failed during switchover it was leaving the given Citus group blocked during indefinite time.</p>
</li>
<li><p>Allow <cite>etcd3</cite> URL in <cite>–dcs-url</cite> option of <cite>patronictl</cite> (Israel Barth Rubio)</p>
<p>If users attempted to pass a <cite>etcd3</cite> URL through <cite>–dcs-url</cite> option of <cite>patronictl</cite> they would face an exception.</p>
</li>
</ul>
</section>
<section id="version-3-0-2">
<h2>Version 3.0.2<a class="headerlink" href="#version-3-0-2" title="Link to this heading"></a></h2>
<p>Released 2023-03-24</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Version 3.0.2 dropped support of Python older than 3.6.</p>
</div>
<p><strong>New features</strong></p>
<ul>
<li><p>Added sync standby replica status to <code class="docutils literal notranslate"><span class="pre">/metrics</span></code> endpoint (Thomas von Dein, Alexander Kukushkin)</p>
<p>Before were only reporting <code class="docutils literal notranslate"><span class="pre">primary</span></code>/<code class="docutils literal notranslate"><span class="pre">standby_leader</span></code>/<code class="docutils literal notranslate"><span class="pre">replica</span></code>.</p>
</li>
<li><p>User-friendly handling of <code class="docutils literal notranslate"><span class="pre">PAGER</span></code> in <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> (Israel Barth Rubio)</p>
<p>It makes pager configurable via <code class="docutils literal notranslate"><span class="pre">PAGER</span></code> environment variable, which overrides default <code class="docutils literal notranslate"><span class="pre">less</span></code> and <code class="docutils literal notranslate"><span class="pre">more</span></code>.</p>
</li>
<li><p>Make K8s retriable HTTP status code configurable (Alexander Kukushkin)</p>
<p>On some managed platforms it is possible to get status code <code class="docutils literal notranslate"><span class="pre">401</span> <span class="pre">Unauthorized</span></code>, which sometimes gets resolved after a few retries.</p>
</li>
</ul>
<p><strong>Improvements</strong></p>
<ul>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">hot_standby</span></code> to <code class="docutils literal notranslate"><span class="pre">off</span></code> during custom bootstrap only if <code class="docutils literal notranslate"><span class="pre">recovery_target_action</span></code> is set to <code class="docutils literal notranslate"><span class="pre">promote</span></code> (Alexander Kukushkin)</p>
<p>It was necessary to make <code class="docutils literal notranslate"><span class="pre">recovery_target_action=pause</span></code> work correctly.</p>
</li>
<li><p>Don’t allow <code class="docutils literal notranslate"><span class="pre">on_reload</span></code> callback to kill other callbacks (Alexander Kukushkin)</p>
<p><code class="docutils literal notranslate"><span class="pre">on_start</span></code>/<code class="docutils literal notranslate"><span class="pre">on_stop</span></code>/<code class="docutils literal notranslate"><span class="pre">on_role_change</span></code> are usually used to add/remove Virtual IP and <code class="docutils literal notranslate"><span class="pre">on_reload</span></code> should not interfere with them.</p>
</li>
<li><p>Switched to <code class="docutils literal notranslate"><span class="pre">IMDSFetcher</span></code> in aws callback example script (Polina Bungina)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">IMDSv2</span></code> requires a token to work with and the <code class="docutils literal notranslate"><span class="pre">IMDSFetcher</span></code> handles it transparently.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Fixed <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">switchover</span></code> on Citus cluster running on Kubernetes (Lukáš Lalinský)</p>
<p>It didn’t work for namespaces different from <code class="docutils literal notranslate"><span class="pre">default</span></code>.</p>
</li>
<li><p>Don’t write to <code class="docutils literal notranslate"><span class="pre">PGDATA</span></code> if major version is not known (Alexander Kukushkin)</p>
<p>If right after the start <code class="docutils literal notranslate"><span class="pre">PGDATA</span></code> was empty (maybe wasn’t yet mounted), Patroni was making a false assumption about PostgreSQL version and falsely creating <code class="docutils literal notranslate"><span class="pre">recovery.conf</span></code> file even if the actual major version is v10+.</p>
</li>
<li><p>Fixed bug with Citus metadata after coordinator failover (Alexander Kukushkin)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">citus_set_coordinator_host()</span></code> call doesn’t cause metadata sync and the change was invisible on worker nodes. The issue is solved by switching to <code class="docutils literal notranslate"><span class="pre">citus_update_node()</span></code>.</p>
</li>
<li><p>Use etcd hosts listed in the config file as a fallback when all etcd nodes “failed” (Alexander Kukushkin)</p>
<p>The etcd cluster may change topology over time and Patroni tries to follow it. If at some point all nodes became unreachable Patroni will use a combination of nodes from the config plus the last known topology when trying to reconnect.</p>
</li>
</ul>
</section>
<section id="version-3-0-1">
<h2>Version 3.0.1<a class="headerlink" href="#version-3-0-1" title="Link to this heading"></a></h2>
<p>Released 2023-02-16</p>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Pass proper role name to an <code class="docutils literal notranslate"><span class="pre">on_role_change</span></code> callback script’. (Alexander Kukushkin, Polina Bungina)</p>
<p>Patroni used to erroneously pass <code class="docutils literal notranslate"><span class="pre">promoted</span></code> role to an <code class="docutils literal notranslate"><span class="pre">on_role_change</span></code> callback script on promotion. The passed role name changed back to <code class="docutils literal notranslate"><span class="pre">master</span></code>. This regression was introduced in 3.0.0.</p>
</li>
</ul>
</section>
<section id="version-3-0-0">
<h2>Version 3.0.0<a class="headerlink" href="#version-3-0-0" title="Link to this heading"></a></h2>
<p>Released 2023-01-30</p>
<p>This version adds integration with <a class="reference external" href="https://www.citusdata.com">Citus</a> and makes it possible to survive temporary DCS outages without demoting primary.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<ul class="simple">
<li><p>Version 3.0.0 is the last release supporting Python 2.7. Upcoming release will drop support of Python versions older than 3.7.</p></li>
<li><p>The RAFT support is deprecated. We will do our best to maintain it, but take neither guarantee nor responsibility for possible issues.</p></li>
<li><p>This version is the first step in getting rid of the “master”, in favor of “primary”. Upgrading to the next major release will work reliably only if you run at least 3.0.0.</p></li>
</ul>
</div>
<p><strong>New features</strong></p>
<ul>
<li><p>DCS failsafe mode (Alexander Kukushkin, Polina Bungina)</p>
<p>If the feature is enabled it will allow Patroni cluster to survive temporary DCS outages. You can find more details in the <a class="reference internal" href="dcs_failsafe_mode.html#dcs-failsafe-mode"><span class="std std-ref">documentation</span></a>.</p>
</li>
<li><p>Citus support (Alexander Kukushkin, Polina Bungina, Jelte Fennema)</p>
<p>Patroni enables easy deployment and management of <a class="reference external" href="https://www.citusdata.com">Citus</a> clusters with HA. Please check <a class="reference internal" href="citus.html#citus"><span class="std std-ref">here</span></a> page for more information.</p>
</li>
</ul>
<p><strong>Improvements</strong></p>
<ul>
<li><p>Suppress recurring errors when dropping unknown but active replication slots (Michael Banck)</p>
<p>Patroni will still write these logs, but only in DEBUG.</p>
</li>
<li><p>Run only one monitoring query per HA loop (Alexander Kukushkin)</p>
<p>It wasn’t the case if synchronous replication is enabled.</p>
</li>
<li><p>Keep only latest failed data directory (William Albertus Dembo)</p>
<p>If bootstrap failed Patroni used to rename $PGDATA folder with timestamp suffix. From now on the suffix will be <code class="docutils literal notranslate"><span class="pre">.failed</span></code> and if such folder exists it is removed before renaming.</p>
</li>
<li><p>Improved check of synchronous replication connections (Alexander Kukushkin)</p>
<p>When the new host is added to the <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code> it will be set as synchronous in DCS only when it managed to catch up with the primary in addition to <code class="docutils literal notranslate"><span class="pre">pg_stat_replication.sync_state</span> <span class="pre">=</span> <span class="pre">'sync'</span></code>.</p>
</li>
</ul>
<p><strong>Removed functionality</strong></p>
<ul>
<li><p>Remove <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">scaffold</span></code> (Alexander Kukushkin)</p>
<p>The only reason for having it was a hacky way of running standby clusters.</p>
</li>
</ul>
</section>
<section id="version-2-1-7">
<h2>Version 2.1.7<a class="headerlink" href="#version-2-1-7" title="Link to this heading"></a></h2>
<p>Released 2023-01-04</p>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Fixed little incompatibilities with legacy python modules (Alexander Kukushkin)</p>
<p>They prevented from building/running Patroni on Debian buster/Ubuntu bionic.</p>
</li>
</ul>
</section>
<section id="version-2-1-6">
<h2>Version 2.1.6<a class="headerlink" href="#version-2-1-6" title="Link to this heading"></a></h2>
<p>Released 2022-12-30</p>
<p><strong>Improvements</strong></p>
<ul>
<li><p>Fix annoying exceptions on ssl socket shutdown (Alexander Kukushkin)</p>
<p>The HAProxy is closing connections as soon as it got the HTTP Status code leaving no time for Patroni to properly shutdown SSL connection.</p>
</li>
<li><p>Adjust example Dockerfile for arm64 (Polina Bungina)</p>
<p>Remove explicit <code class="docutils literal notranslate"><span class="pre">amd64</span></code> and <code class="docutils literal notranslate"><span class="pre">x86_64</span></code>, don’t remove <code class="docutils literal notranslate"><span class="pre">libnss_files.so.*</span></code>.</p>
</li>
</ul>
<p><strong>Security improvements</strong></p>
<ul>
<li><p>Enforce <code class="docutils literal notranslate"><span class="pre">search_path=pg_catalog</span></code> for non-replication connections (Alexander Kukushkin)</p>
<p>Since Patroni is heavily relying on superuser connections, we want to protect it from the possible attacks carried out using user-defined functions and/or operators in <code class="docutils literal notranslate"><span class="pre">public</span></code> schema with the same name and signature as the corresponding objects in <code class="docutils literal notranslate"><span class="pre">pg_catalog</span></code>. For that, <code class="docutils literal notranslate"><span class="pre">search_path=pg_catalog</span></code> is enforced for all connections created by Patroni (except replication connections).</p>
</li>
<li><p>Prevent passwords from being recorded in <code class="docutils literal notranslate"><span class="pre">pg_stat_statements</span></code> (Feike Steenbergen)</p>
<p>It is achieved by setting <code class="docutils literal notranslate"><span class="pre">pg_stat_statements.track_utility=off</span></code> when creating users.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Declare <code class="docutils literal notranslate"><span class="pre">proxy_address</span></code> as optional (Denis Laxalde)</p>
<p>As it is effectively a non-required option.</p>
</li>
<li><p>Improve behaviour of the insecure option (Alexander Kukushkin)</p>
<p>Ctl’s <code class="docutils literal notranslate"><span class="pre">insecure</span></code> option didn’t work properly when client certificates were used for REST API requests.</p>
</li>
<li><p>Take watchdog configuration from <code class="docutils literal notranslate"><span class="pre">bootstrap.dcs</span></code> when the new cluster is bootstrapped (Matt Baker)</p>
<p>Patroni used to initially configure watchdog with defaults when bootstrapping a new cluster rather than taking configuration used to bootstrap the DCS.</p>
</li>
<li><p>Fix the way file extensions are treated while finding executables in WIN32 (Martín Marqués)</p>
<p>Only add <code class="docutils literal notranslate"><span class="pre">.exe</span></code> to a file name if it has no extension yet.</p>
</li>
<li><p>Fix Consul TTL setup (Alexander Kukushkin)</p>
<p>We used <code class="docutils literal notranslate"><span class="pre">ttl/2.0</span></code> when setting the value on the HTTPClient, but forgot to multiply the current value by 2 in the class’ property. It was resulting in Consul TTL off by twice.</p>
</li>
</ul>
<p><strong>Removed functionality</strong></p>
<ul>
<li><p>Remove <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">configure</span></code> (Polina Bungina)</p>
<p>There is no more need for a separate <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> config creation.</p>
</li>
</ul>
</section>
<section id="version-2-1-5">
<h2>Version 2.1.5<a class="headerlink" href="#version-2-1-5" title="Link to this heading"></a></h2>
<p>Released 2022-11-28</p>
<p>This version enhances compatibility with PostgreSQL 15 and declares Etcd v3 support as production ready. The Patroni on Raft remains in Beta.</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Improve <code class="docutils literal notranslate"><span class="pre">patroni</span> <span class="pre">--validate-config</span></code> (Denis Laxalde)</p>
<p>Exit with code 1 if config is invalid and print errors to stderr.</p>
</li>
<li><p>Don’t drop replication slots in pause (Alexander Kukushkin)</p>
<p>Patroni is automatically creating/removing physical replication slots when members are joining/leaving the cluster. In pause slots will no longer be removed.</p>
</li>
<li><p>Support the <code class="docutils literal notranslate"><span class="pre">HEAD</span></code> request method for monitoring endpoints (Robert Cutajar)</p>
<p>If used instead of <code class="docutils literal notranslate"><span class="pre">GET</span></code> Patroni will return only the HTTP Status Code.</p>
</li>
<li><p>Support behave tests on Windows (Alexander Kukushkin)</p>
<p>Emulate graceful Patroni shutdown (<code class="docutils literal notranslate"><span class="pre">SIGTERM</span></code>) on Windows by introduce the new REST API endpoint <code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/sigterm</span></code>.</p>
</li>
<li><p>Introduce <code class="docutils literal notranslate"><span class="pre">postgresql.proxy_address</span></code> (Alexander Kukushkin)</p>
<p>It will be written to the member key in DCS as the <code class="docutils literal notranslate"><span class="pre">proxy_url</span></code> and could be used/useful for service discovery.</p>
</li>
</ul>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">pg_replication_slot_advance()</span></code> from a thread (Alexander Kukushkin)</p>
<p>On busy clusters with many logical replication slots the <code class="docutils literal notranslate"><span class="pre">pg_replication_slot_advance()</span></code> call was affecting the main HA loop and could result in the member key expiration.</p>
</li>
<li><p>Archive possibly missing WALs before calling <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> on the old primary (Polina Bungina)</p>
<p>If the primary crashed and was down during considerable time, some WAL files could be missing from archive and from the new primary. There is a chance that <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> could remove these WAL files from the old primary making it impossible to start it as a standby. By archiving <code class="docutils literal notranslate"><span class="pre">ready</span></code> WAL files we not only mitigate this problem but in general improving continues archiving experience.</p>
</li>
<li><p>Ignore <code class="docutils literal notranslate"><span class="pre">403</span></code> errors when trying to create Kubernetes Service (Nick Hudson, Polina Bungina)</p>
<p>Patroni was spamming logs by unsuccessful attempts to create the service, which in fact could already exist.</p>
</li>
<li><p>Improve liveness probe (Alexander Kukushkin)</p>
<p>The liveness problem will start failing if the heartbeat loop is running longer than <cite>ttl</cite> on the primary or <cite>2*ttl</cite> on the replica. That will allow us to use it as an alternative for <a class="reference internal" href="watchdog.html#watchdog"><span class="std std-ref">watchdog</span></a> on Kubernetes.</p>
</li>
<li><p>Make sure only sync node tries to grab the lock when switchover (Alexander Kukushkin, Polina Bungina)</p>
<p>Previously there was a slim chance that up-to-date async member could become the leader if the manual switchover was performed without specifying the target.</p>
</li>
<li><p>Avoid cloning while bootstrap is running (Ants Aasma)</p>
<p>Do not allow a create replica method that does not require a leader to be triggered while the cluster bootstrap is running.</p>
</li>
<li><p>Compatibility with kazoo-2.9.0 (Alexander Kukushkin)</p>
<p>Depending on python version the <code class="docutils literal notranslate"><span class="pre">SequentialThreadingHandler.select()</span></code> method may raise <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> and <code class="docutils literal notranslate"><span class="pre">IOError</span></code> exceptions if <code class="docutils literal notranslate"><span class="pre">select()</span></code> is called on the closed socket.</p>
</li>
<li><p>Explicitly shut down SSL connection before socket shutdown (Alexander Kukushkin)</p>
<p>Not doing it resulted in <code class="docutils literal notranslate"><span class="pre">unexpected</span> <span class="pre">eof</span> <span class="pre">while</span> <span class="pre">reading</span></code> errors with OpenSSL 3.0.</p>
</li>
<li><p>Compatibility with <cite>prettytable&gt;=2.2.0</cite> (Alexander Kukushkin)</p>
<p>Due to the internal API changes the cluster name header was shown on the incorrect line.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Handle expired token for Etcd lease_grant (monsterxx03)</p>
<p>In case of error get the new token and retry request.</p>
</li>
<li><p>Fix bug in the <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/read-only-sync</span></code> endpoint (Alexander Kukushkin)</p>
<p>It was introduced in previous release and effectively never worked.</p>
</li>
<li><p>Handle the case when data dir storage disappeared (Alexander Kukushkin)</p>
<p>Patroni is periodically checking that the PGDATA is there and not empty, but in case of issues with storage the <code class="docutils literal notranslate"><span class="pre">os.listdir()</span></code> is raising the <code class="docutils literal notranslate"><span class="pre">OSError</span></code> exception, breaking the heart-beat loop.</p>
</li>
<li><p>Apply <code class="docutils literal notranslate"><span class="pre">master_stop_timeout</span></code> when waiting for user backends to close (Alexander Kukushkin)</p>
<p>Something that looks like user backend could be in fact a background worker (e.g., Citus Maintenance Daemon) that is failing to stop.</p>
</li>
<li><p>Accept <code class="docutils literal notranslate"><span class="pre">*:&lt;port&gt;</span></code> for <code class="docutils literal notranslate"><span class="pre">postgresql.listen</span></code> (Denis Laxalde)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">patroni</span> <span class="pre">--validate-config</span></code> was complaining about it being invalid.</p>
</li>
<li><p>Timeouts fixes in Raft (Alexander Kukushkin)</p>
<p>When Patroni or patronictl are starting they try to get Raft cluster topology from known members. These calls were made without proper timeouts.</p>
</li>
<li><p>Forcefully update consul service if token was changed (John A. Lotoski)</p>
<p>Not doing so results in errors “rpc error making call: rpc error making call: ACL not found”.</p>
</li>
</ul>
</section>
<section id="version-2-1-4">
<h2>Version 2.1.4<a class="headerlink" href="#version-2-1-4" title="Link to this heading"></a></h2>
<p>Released 2022-06-01</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Improve <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> behavior on typical Debian/Ubuntu systems (Gunnar “Nick” Bluth)</p>
<p>On Postgres setups that keep <cite>postgresql.conf</cite> outside of the data directory (e.g. Ubuntu/Debian packages), <code class="docutils literal notranslate"><span class="pre">pg_rewind</span> <span class="pre">--restore-target-wal</span></code>  fails to figure out the value of the <code class="docutils literal notranslate"><span class="pre">restore_command</span></code>.</p>
</li>
<li><p>Allow setting <code class="docutils literal notranslate"><span class="pre">TLSServerName</span></code> on Consul service checks (Michael Gmelin)</p>
<p>Useful when checks are performed by IP and the Consul <code class="docutils literal notranslate"><span class="pre">node_name</span></code> is not a FQDN.</p>
</li>
<li><p>Added <code class="docutils literal notranslate"><span class="pre">ppc64le</span></code> support in watchdog (Jean-Michel Scheiwiler)</p>
<p>And fixed watchdog support on some non-x86 platforms.</p>
</li>
<li><p>Switched aws.py callback from <code class="docutils literal notranslate"><span class="pre">boto</span></code> to <code class="docutils literal notranslate"><span class="pre">boto3</span></code> (Alexander Kukushkin)</p></li>
</ul>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">boto</span></code>  2.x is abandoned since 2018 and fails with python 3.9.</p>
</div></blockquote>
<ul>
<li><p>Periodically refresh service account token on K8s (Haitao Li)</p>
<p>Since Kubernetes v1.21 service account tokens expire in 1 hour.</p>
</li>
<li><p>Added <code class="docutils literal notranslate"><span class="pre">/read-only-sync</span></code> monitoring endpoint (Dennis4b)</p>
<p>It is similar to the <code class="docutils literal notranslate"><span class="pre">/read-only</span></code> but includes only synchronous replicas.</p>
</li>
</ul>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Don’t copy the logical replication slot to a replica if there is a configuration mismatch in the logical decoding setup with the primary (Alexander Kukushkin)</p>
<p>A replica won’t copy a logical replication slot from the primary anymore if the slot doesn’t match the <code class="docutils literal notranslate"><span class="pre">plugin</span></code> or <code class="docutils literal notranslate"><span class="pre">database</span></code> configuration options. Previously, the check for whether the slot matches those configuration options was not performed until after the replica copied the slot and started with it, resulting in unnecessary and repeated restarts.</p>
</li>
<li><p>Special handling of recovery configuration parameters for PostgreSQL v12+ (Alexander Kukushkin)</p>
<p>While starting as replica Patroni should be able to update <code class="docutils literal notranslate"><span class="pre">postgresql.conf</span></code> and restart/reload if the leader address has changed by caching current parameters values instead of querying them from <code class="docutils literal notranslate"><span class="pre">pg_settings</span></code>.</p>
</li>
<li><p>Better handling of IPv6 addresses in the <code class="docutils literal notranslate"><span class="pre">postgresql.listen</span></code> parameters (Alexander Kukushkin)</p>
<p>Since the <code class="docutils literal notranslate"><span class="pre">listen</span></code> parameter has a port, people try to put IPv6 addresses into square brackets, which were not correctly stripped when there is more than one IP in the list.</p>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">replication</span></code> credentials when performing divergence check only on PostgreSQL v10 and older (Alexander Kukushkin)</p>
<p>If <code class="docutils literal notranslate"><span class="pre">rewind</span></code> is enabled, Patroni will again use either <code class="docutils literal notranslate"><span class="pre">superuser</span></code> or <code class="docutils literal notranslate"><span class="pre">rewind</span></code> credentials on newer Postgres versions.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Fixed missing import of <code class="docutils literal notranslate"><span class="pre">dateutil.parser</span></code> (Wesley Mendes)</p>
<p>Tests weren’t failing only because it was also imported from other modules.</p>
</li>
<li><p>Ensure that <code class="docutils literal notranslate"><span class="pre">optime</span></code> annotation is a string (Sebastian Hasler)</p>
<p>In certain cases Patroni was trying to pass it as numeric.</p>
</li>
<li><p>Better handling of failed <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> attempt (Alexander Kukushkin)</p>
<p>If the primary becomes unavailable during <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code>, <code class="docutils literal notranslate"><span class="pre">$PGDATA</span></code> will be left in a broken state. Following that,  Patroni will remove the data directory even if this is not allowed by the configuration.</p>
</li>
<li><p>Don’t remove <code class="docutils literal notranslate"><span class="pre">slots</span></code> annotations from the leader <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code>/<code class="docutils literal notranslate"><span class="pre">Endpoint</span></code> when PostgreSQL isn’t ready (Alexander Kukushkin)</p>
<p>If <code class="docutils literal notranslate"><span class="pre">slots</span></code> value isn’t passed the annotation will keep the current value.</p>
</li>
<li><p>Handle concurrency problem with K8s API watchers (Alexander Kukushkin)</p>
<p>Under certain (unknown) conditions watchers might become stale; as a result, <code class="docutils literal notranslate"><span class="pre">attempt_to_acquire_leader()</span></code> method could fail due to the HTTP status code 409. In that case we reset watchers connections and restart from scratch.</p>
</li>
</ul>
</section>
<section id="version-2-1-3">
<h2>Version 2.1.3<a class="headerlink" href="#version-2-1-3" title="Link to this heading"></a></h2>
<p>Released 2022-02-18</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Added support for encrypted TLS keys for <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> (Alexander Kukushkin)</p>
<p>It could be configured via <code class="docutils literal notranslate"><span class="pre">ctl.keyfile_password</span></code> or the <code class="docutils literal notranslate"><span class="pre">PATRONI_CTL_KEYFILE_PASSWORD</span></code> environment variable.</p>
</li>
<li><p>Added more metrics to the /metrics endpoint (Alexandre Pereira)</p>
<p>Specifically, <code class="docutils literal notranslate"><span class="pre">patroni_pending_restart</span></code> and <code class="docutils literal notranslate"><span class="pre">patroni_is_paused</span></code>.</p>
</li>
<li><p>Make it possible to specify multiple hosts in the standby cluster configuration (Michael Banck)</p>
<p>If the standby cluster is replicating from the Patroni cluster it might be nice to rely on client-side failover which is available in <code class="docutils literal notranslate"><span class="pre">libpq</span></code> since PostgreSQL v10. That is, the <code class="docutils literal notranslate"><span class="pre">primary_conninfo</span></code> on the standby leader and <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> setting <code class="docutils literal notranslate"><span class="pre">target_session_attrs=read-write</span></code> in the connection string. The <code class="docutils literal notranslate"><span class="pre">pgpass</span></code> file will be generated with multiple lines (one line per host), and instead of calling <code class="docutils literal notranslate"><span class="pre">CHECKPOINT</span></code> on the primary cluster nodes the standby cluster will wait for <code class="docutils literal notranslate"><span class="pre">pg_control</span></code> to be updated.</p>
</li>
</ul>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Compatibility with legacy <code class="docutils literal notranslate"><span class="pre">psycopg2</span></code> (Alexander Kukushkin)</p>
<p>For example, the <code class="docutils literal notranslate"><span class="pre">psycopg2</span></code> installed from Ubuntu 18.04 packages doesn’t have the <code class="docutils literal notranslate"><span class="pre">UndefinedFile</span></code> exception yet.</p>
</li>
<li><p>Restart <code class="docutils literal notranslate"><span class="pre">etcd3</span></code> watcher if all Etcd nodes don’t respond (Alexander Kukushkin)</p>
<p>If the watcher is alive the <code class="docutils literal notranslate"><span class="pre">get_cluster()</span></code> method continues returning stale information even if all Etcd nodes are failing.</p>
</li>
<li><p>Don’t remove the leader lock in the standby cluster while paused (Alexander Kukushkin)</p>
<p>Previously the lock was maintained only by the node that was running as a primary and not a standby leader.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Fixed bug in the standby-leader bootstrap (Alexander Kukushkin)</p>
<p>Patroni was considering bootstrap as failed if Postgres didn’t start accepting connections after 60 seconds. The bug was introduced in the 2.1.2 release.</p>
</li>
<li><p>Fixed bug with failover to a cascading standby (Alexander Kukushkin)</p>
<p>When figuring out which slots should be created on cascading standby we forgot to take into account that the leader might be absent.</p>
</li>
<li><p>Fixed small issues in Postgres config validator (Alexander Kukushkin)</p>
<p>Integer parameters introduced in PostgreSQL v14 were failing to validate because min and max values were quoted in the validator.py</p>
</li>
<li><p>Use replication credentials when checking leader status (Alexander Kukushkin)</p>
<p>It could be that the <code class="docutils literal notranslate"><span class="pre">remove_data_directory_on_diverged_timelines</span></code> is set, but there is no <code class="docutils literal notranslate"><span class="pre">rewind_credentials</span></code> defined and superuser access between nodes is not allowed.</p>
</li>
<li><p>Fixed “port in use” error on REST API certificate replacement (Ants Aasma)</p>
<p>When switching certificates there was a race condition with a concurrent API request. If there is one active during the replacement period then the replacement will error out with a port in use error and Patroni gets stuck in a state without an active API server.</p>
</li>
<li><p>Fixed a bug in cluster bootstrap if passwords contain <code class="docutils literal notranslate"><span class="pre">%</span></code> characters (Bastien Wirtz)</p>
<p>The bootstrap method executes the <code class="docutils literal notranslate"><span class="pre">DO</span></code> block, with all parameters properly quoted, but the <code class="docutils literal notranslate"><span class="pre">cursor.execute()</span></code> method didn’t like an empty list with parameters passed.</p>
</li>
<li><p>Fixed the “AttributeError: no attribute ‘leader’” exception (Hrvoje Milković)</p>
<p>It could happen if the synchronous mode is enabled and the DCS content was wiped out.</p>
</li>
<li><p>Fix bug in divergence timeline check (Alexander Kukushkin)</p>
<p>Patroni was falsely assuming that timelines have diverged. For pg_rewind it didn’t create any problem, but if pg_rewind is not allowed and the <code class="docutils literal notranslate"><span class="pre">remove_data_directory_on_diverged_timelines</span></code> is set, it resulted in reinitializing the former leader.</p>
</li>
</ul>
</section>
<section id="version-2-1-2">
<h2>Version 2.1.2<a class="headerlink" href="#version-2-1-2" title="Link to this heading"></a></h2>
<p>Released 2021-12-03</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Compatibility with <code class="docutils literal notranslate"><span class="pre">psycopg&gt;=3.0</span></code> (Alexander Kukushkin)</p>
<p>By default <code class="docutils literal notranslate"><span class="pre">psycopg2</span></code> is preferred. <cite>psycopg&gt;=3.0</cite> will be used only if <code class="docutils literal notranslate"><span class="pre">psycopg2</span></code> is not available or its version is too old.</p>
</li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">dcs_last_seen</span></code> field to the REST API (Michael Banck)</p>
<p>This field notes the last time (as unix epoch) a cluster member has successfully communicated with the DCS. This is useful to identify and/or analyze network partitions.</p>
</li>
<li><p>Release the leader lock when <code class="docutils literal notranslate"><span class="pre">pg_controldata</span></code> reports “shut down” (Alexander Kukushkin)</p>
<p>To solve the problem of slow switchover/shutdown in case <code class="docutils literal notranslate"><span class="pre">archive_command</span></code> is slow/failing, Patroni will remove the leader key immediately after <code class="docutils literal notranslate"><span class="pre">pg_controldata</span></code> started reporting PGDATA as <code class="docutils literal notranslate"><span class="pre">shut</span> <span class="pre">down</span></code> cleanly and it verified that there is at least one replica that received all changes. If there are no replicas that fulfill this condition the leader key is not removed and the old behavior is retained, i.e. Patroni will keep updating the lock.</p>
</li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">sslcrldir</span></code> connection parameter support (Kostiantyn Nemchenko)</p>
<p>The new connection parameter was introduced in the PostgreSQL v14.</p>
</li>
<li><p>Allow setting ACLs for ZNodes in Zookeeper (Alwyn Davis)</p>
<p>Introduce a new configuration option <code class="docutils literal notranslate"><span class="pre">zookeeper.set_acls</span></code> so that Kazoo will apply a default ACL for each ZNode that it creates.</p>
</li>
</ul>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Delay the next attempt of recovery till next HA loop (Alexander Kukushkin)</p>
<p>If Postgres crashed due to out of disk space (for example) and fails to start because of that Patroni is too eagerly trying to recover it flooding logs.</p>
</li>
<li><p>Add log before demoting, which can take some time (Michael Banck)</p>
<p>It can take some time for the demote to finish and it might not be obvious from looking at the logs what exactly is going on.</p>
</li>
<li><p>Improve “I am” status messages (Michael Banck)</p>
<p><code class="docutils literal notranslate"><span class="pre">no</span> <span class="pre">action.</span> <span class="pre">I</span> <span class="pre">am</span> <span class="pre">a</span> <span class="pre">secondary</span> <span class="pre">({0})</span></code> vs <code class="docutils literal notranslate"><span class="pre">no</span> <span class="pre">action.</span> <span class="pre">I</span> <span class="pre">am</span> <span class="pre">({0}),</span> <span class="pre">a</span> <span class="pre">secondary</span></code></p>
</li>
<li><p>Cast to int <code class="docutils literal notranslate"><span class="pre">wal_keep_segments</span></code> when converting to <code class="docutils literal notranslate"><span class="pre">wal_keep_size</span></code> (Jorge Solórzano)</p>
<p>It is possible to specify <code class="docutils literal notranslate"><span class="pre">wal_keep_segments</span></code> as a string in the global <a class="reference internal" href="dynamic_configuration.html#dynamic-configuration"><span class="std std-ref">dynamic configuration</span></a> and due to Python being a dynamically typed language the string was simply multiplied. Example: <code class="docutils literal notranslate"><span class="pre">wal_keep_segments:</span> <span class="pre">&quot;100&quot;</span></code> was converted to <code class="docutils literal notranslate"><span class="pre">100100100100100100100100100100100100100100100100MB</span></code>.</p>
</li>
<li><p>Allow switchover only to sync nodes when synchronous replication is enabled (Alexander Kukushkin)</p>
<p>In addition to that do the leader race only against known synchronous nodes.</p>
</li>
<li><p>Use cached role as a fallback when Postgres is slow (Alexander Kukushkin)</p>
<p>In some extreme cases Postgres could be so slow that the normal monitoring query does not finish in a few seconds. The <code class="docutils literal notranslate"><span class="pre">statement_timeout</span></code> exception not being properly handled could lead to the situation where Postgres was not demoted on time when the leader key expired or the update failed. In case of such exception Patroni will use the cached <code class="docutils literal notranslate"><span class="pre">role</span></code> to determine whether Postgres is running as a primary.</p>
</li>
<li><p>Avoid unnecessary updates of the member ZNode (Alexander Kukushkin)</p>
<p>If no values have changed in the members data, the update should not happen.</p>
</li>
<li><p>Optimize checkpoint after promote (Alexander Kukushkin)</p>
<p>Avoid doing <code class="docutils literal notranslate"><span class="pre">CHECKPOINT</span></code> if the latest timeline is already stored in <code class="docutils literal notranslate"><span class="pre">pg_control</span></code>. It helps to avoid unnecessary <code class="docutils literal notranslate"><span class="pre">CHECKPOINT</span></code> right after initializing the new cluster with <code class="docutils literal notranslate"><span class="pre">initdb</span></code>.</p>
</li>
<li><p>Prefer members without <code class="docutils literal notranslate"><span class="pre">nofailover</span></code> when picking sync nodes (Alexander Kukushkin)</p>
<p>Previously sync nodes were selected only based on the replication lag, hence the node with <code class="docutils literal notranslate"><span class="pre">nofailover</span></code> tag had the same chances to become synchronous as any other node. That behavior was confusing and dangerous at the same time because in case of a failed primary the failover could not happen automatically.</p>
</li>
<li><p>Remove duplicate hosts from the etcd machine cache (Michael Banck)</p>
<p>Advertised client URLs in the etcd cluster could be misconfigured. Removing duplicates in Patroni in this case is a low-hanging fruit.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Skip temporary replication slots while doing slot management (Alexander Kukushkin)</p>
<p>Starting from v10 <code class="docutils literal notranslate"><span class="pre">pg_basebackup</span></code> creates a temporary replication slot for WAL streaming and Patroni was trying to drop it because the slot name looks unknown. In order to fix it, we skip all temporary slots when querying <code class="docutils literal notranslate"><span class="pre">pg_stat_replication_slots</span></code> view.</p>
</li>
<li><p>Ensure <code class="docutils literal notranslate"><span class="pre">pg_replication_slot_advance()</span></code> doesn’t timeout (Alexander Kukushkin)</p>
<p>Patroni was using the default <code class="docutils literal notranslate"><span class="pre">statement_timeout</span></code> in this case and once the call failed there are very high chances that it will never recover, resulting in increased size of <code class="docutils literal notranslate"><span class="pre">pg_wal</span></code> and <code class="docutils literal notranslate"><span class="pre">pg_catalog</span></code> bloat.</p>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">/status</span></code> wasn’t updated on demote (Alexander Kukushkin)</p>
<p>After demoting PostgreSQL the old leader updates the last LSN in DCS. Starting from <code class="docutils literal notranslate"><span class="pre">2.1.0</span></code> the new <code class="docutils literal notranslate"><span class="pre">/status</span></code> key was introduced, but the optime was still written to the <code class="docutils literal notranslate"><span class="pre">/optime/leader</span></code>.</p>
</li>
<li><p>Handle DCS exceptions when demoting (Alexander Kukushkin)</p>
<p>While demoting the master due to failure to update the leader lock it could happen that DCS goes completely down and the <code class="docutils literal notranslate"><span class="pre">get_cluster()</span></code> call raises an exception. Not being handled properly it results in Postgres remaining stopped until DCS recovers.</p>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">use_unix_socket_repl</span></code> didn’t work is some cases (Alexander Kukushkin)</p>
<p>Specifically, if <code class="docutils literal notranslate"><span class="pre">postgresql.unix_socket_directories</span></code> is not set. In this case Patroni is supposed to use the default value from <code class="docutils literal notranslate"><span class="pre">libpq</span></code>.</p>
</li>
<li><p>Fix a few issues with Patroni REST API (Alexander Kukushkin)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">clusters_unlocked</span></code> sometimes could be not defined, what resulted in exceptions in the <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/metrics</span></code> endpoint. In addition to that the error handling method was assuming that the <code class="docutils literal notranslate"><span class="pre">connect_address</span></code> tuple always has two elements, while in fact there could be more in case of IPv6.</p>
</li>
<li><p>Wait for newly promoted node to finish recovery before deciding to rewind (Alexander Kukushkin)</p>
<p>It could take some time before the actual promote happens and the new timeline is created. Without waiting replicas could come to the conclusion that rewind isn’t required.</p>
</li>
<li><p>Handle missing timelines in a history file when deciding to rewind (Alexander Kukushkin)</p>
<p>If the current replica timeline is missing in the history file on the primary the replica was falsely assuming that rewind isn’t required.</p>
</li>
</ul>
</section>
<section id="version-2-1-1">
<h2>Version 2.1.1<a class="headerlink" href="#version-2-1-1" title="Link to this heading"></a></h2>
<p>Released 2021-08-19</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Support for ETCD SRV name suffix (David Pavlicek)</p>
<p>Etcd allows to differentiate between multiple Etcd clusters under the same domain and from now on Patroni also supports it.</p>
</li>
<li><p>Enrich history with the new leader (huiyalin525)</p>
<p>It adds the new column to the <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">history</span></code> output.</p>
</li>
<li><p>Make the CA bundle configurable for in-cluster Kubernetes config (Aron Parsons)</p>
<p>By default Patroni is using <code class="docutils literal notranslate"><span class="pre">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></code> and this new feature allows specifying the custom <code class="docutils literal notranslate"><span class="pre">kubernetes.cacert</span></code>.</p>
</li>
<li><p>Support dynamically registering/deregistering as a Consul service and changing tags (Tommy Li)</p>
<p>Previously it required Patroni restart.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Avoid unnecessary reload of REST API (Alexander Kukushkin)</p>
<p>The previous release added a feature of reloading REST API certificates if changed on disk. Unfortunately, the reload was happening unconditionally right after the start.</p>
</li>
<li><p>Don’t resolve cluster members when <code class="docutils literal notranslate"><span class="pre">etcd.use_proxies</span></code> is set (Alexander Kukushkin)</p>
<p>When starting up Patroni checks the healthiness of Etcd cluster by querying the list of members. In addition to that, it also tried to resolve their hostnames, which is not necessary when working with Etcd via proxy and was causing unnecessary warnings.</p>
</li>
<li><p>Skip rows with NULL values in the <code class="docutils literal notranslate"><span class="pre">pg_stat_replication</span></code> (Alexander Kukushkin)</p>
<p>It seems that the <code class="docutils literal notranslate"><span class="pre">pg_stat_replication</span></code> view could contain NULL values in the <code class="docutils literal notranslate"><span class="pre">replay_lsn</span></code>, <code class="docutils literal notranslate"><span class="pre">flush_lsn</span></code>, or <code class="docutils literal notranslate"><span class="pre">write_lsn</span></code> fields even when <code class="docutils literal notranslate"><span class="pre">state</span> <span class="pre">=</span> <span class="pre">'streaming'</span></code>.</p>
</li>
</ul>
</section>
<section id="version-2-1-0">
<h2>Version 2.1.0<a class="headerlink" href="#version-2-1-0" title="Link to this heading"></a></h2>
<p>Released 2021-07-06</p>
<p>This version adds compatibility with PostgreSQL v14, makes logical replication slots to survive failover/switchover, implements support of allowlist for REST API, and also reducing the number of logs to one line per heart-beat.</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Compatibility with PostgreSQL v14 (Alexander Kukushkin)</p>
<p>Unpause WAL replay if Patroni is not in a “pause” mode itself. It could be “paused” due to the change of certain parameters like for example <code class="docutils literal notranslate"><span class="pre">max_connections</span></code> on the primary.</p>
</li>
<li><p>Failover logical slots (Alexander Kukushkin)</p>
<p>Make logical replication slots survive failover/switchover on PostgreSQL v11+. The replication slot if copied from the primary to the replica with restart and later the <a class="reference external" href="https://www.postgresql.org/docs/11/functions-admin.html#id-1.5.8.31.8.5.2.2.8.1.1">pg_replication_slot_advance()</a> function is used to move it forward. As a result, the slot will already exist before the failover and no events should be lost, but, there is a chance that some events could be delivered more than once.</p>
</li>
<li><p>Implemented allowlist for Patroni REST API (Alexander Kukushkin)</p>
<p>If configured, only IP’s that matching rules would be allowed to call unsafe endpoints. In addition to that, it is possible to automatically include IP’s of members of the cluster to the list.</p>
</li>
<li><p>Added support of replication connections via unix socket (Mohamad El-Rifai)</p>
<p>Previously Patroni was always using TCP for replication connection what could cause some issues with SSL verification. Using unix sockets allows exempt replication user from SSL verification.</p>
</li>
<li><p>Health check on user-defined tags (Arman Jafari Tehrani)</p>
<p>Along with <a class="reference internal" href="yaml_configuration.html#tags-settings"><span class="std std-ref">predefined tags:</span></a> it is possible to specify any number of custom tags that become visible in the <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">list</span></code> output and in the REST API. From now on it is possible to use custom tags in health checks.</p>
</li>
<li><p>Added Prometheus <code class="docutils literal notranslate"><span class="pre">/metrics</span></code> endpoint (Mark Mercado, Michael Banck)</p>
<p>The endpoint exposing the same metrics as <code class="docutils literal notranslate"><span class="pre">/patroni</span></code>.</p>
</li>
<li><p>Reduced chattiness of Patroni logs (Alexander Kukushkin)</p>
<p>When everything goes normal, only one line will be written for every run of HA loop.</p>
</li>
</ul>
<p><strong>Breaking changes</strong></p>
<ul>
<li><p>The old <code class="docutils literal notranslate"><span class="pre">permanent</span> <span class="pre">logical</span> <span class="pre">replication</span> <span class="pre">slots</span></code> feature will no longer work with PostgreSQL v10 and older (Alexander Kukushkin)</p>
<p>The strategy of creating the logical slots after performing a promotion can’t guaranty that no logical events are lost and therefore disabled.</p>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">/leader</span></code> endpoint always returns 200 if the node holds the lock (Alexander Kukushkin)</p>
<p>Promoting the standby cluster requires updating load-balancer health checks, which is not very convenient and easy to forget. To solve it, we change the behavior of the <code class="docutils literal notranslate"><span class="pre">/leader</span></code> health check endpoint. It will return 200 without taking into account whether the cluster is normal or the <code class="docutils literal notranslate"><span class="pre">standby_cluster</span></code>.</p>
</li>
</ul>
<p><strong>Improvements in Raft support</strong></p>
<ul>
<li><p>Reliable support of Raft traffic encryption (Alexander Kukushkin)</p>
<p>Due to the different issues in the <code class="docutils literal notranslate"><span class="pre">PySyncObj</span></code> the encryption support was very unstable</p>
</li>
<li><p>Handle DNS issues in Raft implementation (Alexander Kukushkin)</p>
<p>If <code class="docutils literal notranslate"><span class="pre">self_addr</span></code> and/or <code class="docutils literal notranslate"><span class="pre">partner_addrs</span></code> are configured using the DNS name instead of IP’s the <code class="docutils literal notranslate"><span class="pre">PySyncObj</span></code> was effectively doing resolve only once when the object is created. It was causing problems when the same node was coming back online with a different IP.</p>
</li>
</ul>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Compatibility with <code class="docutils literal notranslate"><span class="pre">psycopg2-2.9+</span></code> (Alexander Kukushkin)</p>
<p>In <code class="docutils literal notranslate"><span class="pre">psycopg2</span></code> the <code class="docutils literal notranslate"><span class="pre">autocommit</span> <span class="pre">=</span> <span class="pre">True</span></code> is ignored in the <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">connection</span></code> block, which breaks replication protocol connections.</p>
</li>
<li><p>Fix excessive HA loop runs with Zookeeper (Alexander Kukushkin)</p>
<p>Update of member ZNodes was causing a chain reaction and resulted in running the HA loops multiple times in a row.</p>
</li>
<li><p>Reload if REST API certificate is changed on disk (Michael Todorovic)</p>
<p>If the REST API certificate file was updated in place Patroni didn’t perform a reload.</p>
</li>
<li><p>Don’t create pgpass dir if kerberos auth is used (Kostiantyn Nemchenko)</p>
<p>Kerberos and password authentication are mutually exclusive.</p>
</li>
<li><p>Fixed little issues with custom bootstrap (Alexander Kukushkin)</p>
<p>Start Postgres with <code class="docutils literal notranslate"><span class="pre">hot_standby=off</span></code> only when we do a PITR and restart it after PITR is done.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Compatibility with <code class="docutils literal notranslate"><span class="pre">kazoo-2.7+</span></code> (Alexander Kukushkin)</p>
<p>Since Patroni is handling retries on its own, it is relying on the old behavior of <code class="docutils literal notranslate"><span class="pre">kazoo</span></code> that requests to a Zookeeper cluster are immediately discarded when there are no connections available.</p>
</li>
<li><p>Explicitly request the version of Etcd v3 cluster when it is known that we are connecting via proxy (Alexander Kukushkin)</p>
<p>Patroni is working with Etcd v3 cluster via gPRC-gateway and it depending on the cluster version different endpoints (<code class="docutils literal notranslate"><span class="pre">/v3</span></code>, <code class="docutils literal notranslate"><span class="pre">/v3beta</span></code>, or <code class="docutils literal notranslate"><span class="pre">/v3alpha</span></code>) must be used. The version was resolved only together with the cluster topology, but since the latter was never done when connecting via proxy.</p>
</li>
</ul>
</section>
<section id="version-2-0-2">
<h2>Version 2.0.2<a class="headerlink" href="#version-2-0-2" title="Link to this heading"></a></h2>
<p>Released 2021-02-22</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Ability to ignore externally managed replication slots (James Coleman)</p>
<p>Patroni is trying to remove any replication slot which is unknown to it, but there are certainly cases when replication slots should be managed externally. From now on it is possible to configure slots that should not be removed.</p>
</li>
<li><p>Added support for cipher suite limitation for REST API (Gunnar “Nick” Bluth)</p>
<p>It could be configured via <code class="docutils literal notranslate"><span class="pre">restapi.ciphers</span></code> or the <code class="docutils literal notranslate"><span class="pre">PATRONI_RESTAPI_CIPHERS</span></code> environment variable.</p>
</li>
<li><p>Added support for encrypted TLS keys for REST API (Jonathan S. Katz)</p>
<p>It could be configured via <code class="docutils literal notranslate"><span class="pre">restapi.keyfile_password</span></code> or the <code class="docutils literal notranslate"><span class="pre">PATRONI_RESTAPI_KEYFILE_PASSWORD</span></code> environment variable.</p>
</li>
<li><p>Constant time comparison of REST API authentication credentials (Alex Brasetvik)</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">hmac.compare_digest()</span></code> instead of <code class="docutils literal notranslate"><span class="pre">==</span></code>, which is vulnerable to timing attack.</p>
</li>
<li><p>Choose synchronous nodes based on replication lag (Krishna Sarabu)</p>
<p>If the replication lag on the synchronous node starts exceeding the configured threshold it could be demoted to asynchronous and/or replaced by the other node. Behaviour is controlled with <code class="docutils literal notranslate"><span class="pre">maximum_lag_on_syncnode</span></code>.</p>
</li>
</ul>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Start postgres with <code class="docutils literal notranslate"><span class="pre">hot_standby</span> <span class="pre">=</span> <span class="pre">off</span></code> when doing custom bootstrap (Igor Yanchenko)</p>
<p>During custom bootstrap Patroni is restoring the basebackup, starting Postgres up, and waiting until recovery finishes. Some PostgreSQL parameters on the standby can’t be smaller than on the primary and if the new value (restored from WAL) is higher than the configured one, Postgres panics and stops. In order to avoid such behavior we will do custom bootstrap without <code class="docutils literal notranslate"><span class="pre">hot_standby</span></code> mode.</p>
</li>
<li><p>Warn the user if the required watchdog is not healthy (Nicolas Thauvin)</p>
<p>When the watchdog device is not writable or missing in required mode, the member cannot be promoted. Added a warning to show the user where to search for this misconfiguration.</p>
</li>
<li><p>Better verbosity for single-user mode recovery (Alexander Kukushkin)</p>
<p>If Patroni notices that PostgreSQL wasn’t shutdown clearly, in certain cases the crash-recovery is executed by starting Postgres in single-user mode. It could happen that the recovery failed (for example due to the lack of space on disk) but errors were swallowed.</p>
</li>
<li><p>Added compatibility with <code class="docutils literal notranslate"><span class="pre">python-consul2</span></code> module (Alexander Kukushkin, Wilfried Roset)</p>
<p>The good old <code class="docutils literal notranslate"><span class="pre">python-consul</span></code> is not maintained since a few years, therefore someone created a fork with new features and bug-fixes.</p>
</li>
<li><p>Don’t use <code class="docutils literal notranslate"><span class="pre">bypass_api_service</span></code> when running <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> (Alexander Kukushkin)</p>
<p>When a K8s pod is running in a non-<code class="docutils literal notranslate"><span class="pre">default</span></code> namespace it does not necessarily have enough permissions to query the <code class="docutils literal notranslate"><span class="pre">kubernetes</span></code> endpoint. In this case Patroni shows the warning and ignores the <code class="docutils literal notranslate"><span class="pre">bypass_api_service</span></code> setting. In case of <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> the warning was a bit annoying.</p>
</li>
<li><p>Create <code class="docutils literal notranslate"><span class="pre">raft.data_dir</span></code> if it doesn’t exists or make sure that it is writable (Mark Mercado)</p>
<p>Improves user-friendliness and usability.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Don’t interrupt restart or promote if lost leader lock in pause (Alexander Kukushkin)</p>
<p>In pause it is allowed to run postgres as primary without lock.</p>
</li>
<li><p>Fixed issue with <code class="docutils literal notranslate"><span class="pre">shutdown_request()</span></code> in the REST API (Nicolas Limage)</p>
<p>In order to improve handling of SSL connections and delay the handshake until thread is started Patroni overrides a few methods in the <code class="docutils literal notranslate"><span class="pre">HTTPServer</span></code>. The <code class="docutils literal notranslate"><span class="pre">shutdown_request()</span></code> method was forgotten.</p>
</li>
<li><p>Fixed issue with sleep time when using Zookeeper (Alexander Kukushkin)</p>
<p>There were chances that Patroni was sleeping up to twice longer between running HA code.</p>
</li>
<li><p>Fixed invalid <code class="docutils literal notranslate"><span class="pre">os.symlink()</span></code> calls when moving data directory after failed bootstrap (Andrew L’Ecuyer)</p>
<p>If the bootstrap failed Patroni is renaming data directory, pg_wal, and all tablespaces. After that it updates symlinks so filesystem remains consistent. The symlink creation was failing due to the <code class="docutils literal notranslate"><span class="pre">src</span></code> and <code class="docutils literal notranslate"><span class="pre">dst</span></code> arguments being swapped.</p>
</li>
<li><p>Fixed bug in the post_bootstrap() method (Alexander Kukushkin)</p>
<p>If the superuser password wasn’t configured Patroni was failing to call the <code class="docutils literal notranslate"><span class="pre">post_init</span></code> script and therefore the whole bootstrap was failing.</p>
</li>
<li><p>Fixed an issues with pg_rewind in the standby cluster (Alexander Kukushkin)</p>
<p>If the superuser name is different from Postgres, the <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> in the standby cluster was failing because the connection string didn’t contain the database name.</p>
</li>
<li><p>Exit only if authentication with Etcd v3 explicitly failed (Alexander Kukushkin)</p>
<p>On start Patroni performs discovery of Etcd cluster topology and authenticates if it is necessarily. It could happen that one of etcd servers is not accessible, Patroni was trying to perform authentication on this server and failing instead of retrying with the next node.</p>
</li>
<li><p>Handle case with psutil cmdline() returning empty list (Alexander Kukushkin)</p>
<p>Zombie processes are still postmasters children, but they don’t have cmdline()</p>
</li>
<li><p>Treat <code class="docutils literal notranslate"><span class="pre">PATRONI_KUBERNETES_USE_ENDPOINTS</span></code> environment variable as boolean (Alexander Kukushkin)</p>
<p>Not doing so was making impossible disabling <code class="docutils literal notranslate"><span class="pre">kubernetes.use_endpoints</span></code> via environment.</p>
</li>
<li><p>Improve handling of concurrent endpoint update errors (Alexander Kukushkin)</p>
<p>Patroni will explicitly query the current endpoint object, verify that the current pod still holds the leader lock and repeat the update.</p>
</li>
</ul>
</section>
<section id="version-2-0-1">
<h2>Version 2.0.1<a class="headerlink" href="#version-2-0-1" title="Link to this heading"></a></h2>
<p>Released 2020-10-01</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">more</span></code> as pager in <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">edit-config</span></code> if <code class="docutils literal notranslate"><span class="pre">less</span></code> is not available (Pavel Golub)</p>
<p>On Windows it would be the <code class="docutils literal notranslate"><span class="pre">more.com</span></code>. In addition to that, <code class="docutils literal notranslate"><span class="pre">cdiff</span></code> was changed to <code class="docutils literal notranslate"><span class="pre">ydiff</span></code> in <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code>, but <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> still supports both for compatibility.</p>
</li>
<li><p>Added support of <code class="docutils literal notranslate"><span class="pre">raft</span></code> <code class="docutils literal notranslate"><span class="pre">bind_addr</span></code> and <code class="docutils literal notranslate"><span class="pre">password</span></code> (Alexander Kukushkin)</p>
<p><code class="docutils literal notranslate"><span class="pre">raft.bind_addr</span></code> might be useful when running behind NAT. <code class="docutils literal notranslate"><span class="pre">raft.password</span></code> enables traffic encryption (requires the <code class="docutils literal notranslate"><span class="pre">cryptography</span></code> module).</p>
</li>
<li><p>Added <code class="docutils literal notranslate"><span class="pre">sslpassword</span></code> connection parameter support (Kostiantyn Nemchenko)</p>
<p>The connection parameter was introduced in PostgreSQL 13.</p>
</li>
</ul>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Changed the behavior in pause (Alexander Kukushkin)</p>
<ol class="arabic simple">
<li><p>Patroni will not call the <code class="docutils literal notranslate"><span class="pre">bootstrap</span></code> method if the <code class="docutils literal notranslate"><span class="pre">PGDATA</span></code> directory is missing/empty.</p></li>
<li><p>Patroni will not exit on sysid mismatch in pause, only log a warning.</p></li>
<li><p>The node will not try to grab the leader key in pause mode if Postgres is running not in recovery (accepting writes) but the sysid doesn’t match with the initialize key.</p></li>
</ol>
</li>
<li><p>Apply <code class="docutils literal notranslate"><span class="pre">master_start_timeout</span></code> when executing crash recovery (Alexander Kukushkin)</p>
<p>If Postgres crashed on the leader node, Patroni does a crash-recovery by starting Postgres in single-user mode. During the crash-recovery the leader lock is being updated. If the crash-recovery didn’t finish in <code class="docutils literal notranslate"><span class="pre">master_start_timeout</span></code> seconds, Patroni will stop it forcefully and release the leader lock.</p>
</li>
<li><p>Removed the <code class="docutils literal notranslate"><span class="pre">secure</span></code> extra from the <code class="docutils literal notranslate"><span class="pre">urllib3</span></code> requirements (Alexander Kukushkin)</p>
<p>The only reason for adding it there was the <code class="docutils literal notranslate"><span class="pre">ipaddress</span></code> dependency for python 2.7.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Fixed a bug in the <code class="docutils literal notranslate"><span class="pre">Kubernetes.update_leader()</span></code> (Alexander Kukushkin)</p>
<p>An unhandled exception was preventing demoting the primary when the update of the leader object failed.</p>
</li>
<li><p>Fixed hanging <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> when RAFT is being used (Alexander Kukushkin)</p>
<p>When using <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> with Patroni config, <code class="docutils literal notranslate"><span class="pre">self_addr</span></code> should be added to the <code class="docutils literal notranslate"><span class="pre">partner_addrs</span></code>.</p>
</li>
<li><p>Fixed bug in <code class="docutils literal notranslate"><span class="pre">get_guc_value()</span></code> (Alexander Kukushkin)</p>
<p>Patroni was failing to get the value of <code class="docutils literal notranslate"><span class="pre">restore_command</span></code> on PostgreSQL 12, therefore fetching missing WALs for <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> didn’t work.</p>
</li>
</ul>
</section>
<section id="version-2-0-0">
<h2>Version 2.0.0<a class="headerlink" href="#version-2-0-0" title="Link to this heading"></a></h2>
<p>Released 2020-09-02</p>
<p>This version enhances compatibility with PostgreSQL 13, adds support of multiple synchronous standbys, has significant improvements in handling of <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code>, adds support of Etcd v3 and Patroni on pure RAFT (without Etcd, Consul, or Zookeeper), and makes it possible to optionally call the <code class="docutils literal notranslate"><span class="pre">pre_promote</span></code> (fencing) script.</p>
<p><strong>PostgreSQL 13 support</strong></p>
<ul>
<li><p>Don’t fire <code class="docutils literal notranslate"><span class="pre">on_reload</span></code> when promoting to <code class="docutils literal notranslate"><span class="pre">standby_leader</span></code> on PostgreSQL 13+ (Alexander Kukushkin)</p>
<p>When promoting to <code class="docutils literal notranslate"><span class="pre">standby_leader</span></code> we change <code class="docutils literal notranslate"><span class="pre">primary_conninfo</span></code>, update the role and reload Postgres. Since <code class="docutils literal notranslate"><span class="pre">on_role_change</span></code> and <code class="docutils literal notranslate"><span class="pre">on_reload</span></code> effectively duplicate each other, Patroni will call only <code class="docutils literal notranslate"><span class="pre">on_role_change</span></code>.</p>
</li>
<li><p>Added support for <code class="docutils literal notranslate"><span class="pre">gssencmode</span></code> and <code class="docutils literal notranslate"><span class="pre">channel_binding</span></code> connection parameters (Alexander Kukushkin)</p>
<p>PostgreSQL 12 introduced <code class="docutils literal notranslate"><span class="pre">gssencmode</span></code> and 13 <code class="docutils literal notranslate"><span class="pre">channel_binding</span></code> connection parameters and now they can be used if defined in the <code class="docutils literal notranslate"><span class="pre">postgresql.authentication</span></code> section.</p>
</li>
<li><p>Handle renaming of <code class="docutils literal notranslate"><span class="pre">wal_keep_segments</span></code> to <code class="docutils literal notranslate"><span class="pre">wal_keep_size</span></code> (Alexander Kukushkin)</p>
<p>In case of misconfiguration (<code class="docutils literal notranslate"><span class="pre">wal_keep_segments</span></code> on 13 and <code class="docutils literal notranslate"><span class="pre">wal_keep_size</span></code> on older versions) Patroni will automatically adjust the configuration.</p>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> with <code class="docutils literal notranslate"><span class="pre">--restore-target-wal</span></code> on 13 if possible (Alexander Kukushkin)</p>
<p>On PostgreSQL 13 Patroni checks if <code class="docutils literal notranslate"><span class="pre">restore_command</span></code> is configured and tells <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> to use it.</p>
</li>
</ul>
<p><strong>New features</strong></p>
<ul>
<li><p>[BETA] Implemented support of Patroni on pure RAFT (Alexander Kukushkin)</p>
<p>This makes it possible to run Patroni without 3rd party dependencies, like Etcd, Consul, or Zookeeper. For HA you will have to run either three Patroni nodes or two nodes with Patroni and one node with <code class="docutils literal notranslate"><span class="pre">patroni_raft_controller</span></code>. For more information please check the <a class="reference internal" href="yaml_configuration.html#raft-settings"><span class="std std-ref">documentation</span></a>.</p>
</li>
<li><p>[BETA] Implemented support for Etcd v3 protocol via gPRC-gateway (Alexander Kukushkin)</p>
<p>Etcd 3.0 was released more than four years ago and Etcd 3.4 has v2 disabled by default. There are also chances that v2 will be completely removed from Etcd, therefore we implemented support of Etcd v3 in Patroni. In order to start using it you have to explicitly create the <code class="docutils literal notranslate"><span class="pre">etcd3</span></code> section is the Patroni configuration file.</p>
</li>
<li><p>Supporting multiple synchronous standbys (Krishna Sarabu)</p>
<p>It allows running a cluster with more than one synchronous replicas. The maximum number of synchronous replicas is controlled by the new parameter <code class="docutils literal notranslate"><span class="pre">synchronous_node_count</span></code>. It is set to 1 by default and has no effect when the <code class="docutils literal notranslate"><span class="pre">synchronous_mode</span></code> is set to <code class="docutils literal notranslate"><span class="pre">off</span></code>.</p>
</li>
<li><p>Added possibility to call the <code class="docutils literal notranslate"><span class="pre">pre_promote</span></code> script (Sergey Dudoladov)</p>
<p>Unlike callbacks, the <code class="docutils literal notranslate"><span class="pre">pre_promote</span></code> script is called synchronously after acquiring the leader lock, but before promoting Postgres. If the script fails or exits with a non-zero exitcode, the current node will release the leader lock.</p>
</li>
<li><p>Added support for configuration directories (Floris van Nee)</p>
<p>YAML files in the directory loaded and applied in alphabetical order.</p>
</li>
<li><p>Advanced validation of PostgreSQL parameters (Alexander Kukushkin)</p>
<p>In case the specific parameter is not supported by the current PostgreSQL version or when its value is incorrect, Patroni will remove the parameter completely or try to fix the value.</p>
</li>
<li><p>Wake up the main thread when the forced checkpoint after promote completed (Alexander Kukushkin)</p>
<p>Replicas are waiting for checkpoint indication via member key of the leader in DCS. The key is normally updated only once per HA loop. Without waking the main thread up, replicas will have to wait up to <code class="docutils literal notranslate"><span class="pre">loop_wait</span></code> seconds longer than necessary.</p>
</li>
<li><p>Use of <code class="docutils literal notranslate"><span class="pre">pg_stat_wal_receiver</span></code> view on 9.6+ (Alexander Kukushkin)</p>
<p>The view contains up-to-date values of <code class="docutils literal notranslate"><span class="pre">primary_conninfo</span></code> and <code class="docutils literal notranslate"><span class="pre">primary_slot_name</span></code>, while the contents of <code class="docutils literal notranslate"><span class="pre">recovery.conf</span></code> could be stale.</p>
</li>
<li><p>Improved handing of IPv6 addresses in the Patroni config file (Mateusz Kowalski)</p>
<p>The IPv6 address is supposed to be enclosed into square brackets, but Patroni was expecting to get it plain. Now both formats are supported.</p>
</li>
<li><p>Added Consul <code class="docutils literal notranslate"><span class="pre">service_tags</span></code> configuration parameter (Robert Edström)</p>
<p>They are useful for dynamic service discovery, for example by load balancers.</p>
</li>
<li><p>Implemented SSL support for Zookeeper (Kostiantyn Nemchenko)</p>
<p>It requires <code class="docutils literal notranslate"><span class="pre">kazoo&gt;=2.6.0</span></code>.</p>
</li>
<li><p>Implemented <code class="docutils literal notranslate"><span class="pre">no_params</span></code> option for custom bootstrap method (Kostiantyn Nemchenko)</p>
<p>It allows calling <code class="docutils literal notranslate"><span class="pre">wal-g</span></code>, <code class="docutils literal notranslate"><span class="pre">pgBackRest</span></code> and other backup tools without wrapping them into shell scripts.</p>
</li>
<li><p>Move WAL and tablespaces after a failed init (Feike Steenbergen)</p>
<p>When doing <code class="docutils literal notranslate"><span class="pre">reinit</span></code>, Patroni was already removing not only <code class="docutils literal notranslate"><span class="pre">PGDATA</span></code> but also the symlinked WAL directory and tablespaces. Now the <code class="docutils literal notranslate"><span class="pre">move_data_directory()</span></code> method will do a similar job, i.e. rename WAL directory and tablespaces and update symlinks in PGDATA.</p>
</li>
</ul>
<p><strong>Improved in pg_rewind support</strong></p>
<ul>
<li><p>Improved timeline divergence check (Alexander Kukushkin)</p>
<p>We don’t need to rewind when the replayed location on the replica is not ahead of the switchpoint or the end of the checkpoint record on the former primary is the same as the switchpoint. In order to get the end of the checkpoint record we use <code class="docutils literal notranslate"><span class="pre">pg_waldump</span></code> and parse its output.</p>
</li>
<li><p>Try to fetch missing WAL if <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> complains about it (Alexander Kukushkin)</p>
<p>It could happen that the WAL segment required for <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> doesn’t exist in the <code class="docutils literal notranslate"><span class="pre">pg_wal</span></code> directory anymore and therefore <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> can’t find the checkpoint location before the divergence point. Starting from PostgreSQL 13 <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> could use <code class="docutils literal notranslate"><span class="pre">restore_command</span></code> for fetching missing WALs. For older PostgreSQL versions Patroni parses the errors of a failed rewind attempt and tries to fetch the missing WAL by calling the <code class="docutils literal notranslate"><span class="pre">restore_command</span></code> on its own.</p>
</li>
<li><p>Detect a new timeline in the standby cluster and trigger rewind/reinitialize if necessary (Alexander Kukushkin)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">standby_cluster</span></code> is decoupled from the primary cluster and therefore doesn’t immediately know about leader elections and timeline switches. In order to detect the fact, the <code class="docutils literal notranslate"><span class="pre">standby_leader</span></code> periodically checks for new history files in <code class="docutils literal notranslate"><span class="pre">pg_wal</span></code>.</p>
</li>
<li><p>Shorten and beautify history log output (Alexander Kukushkin)</p>
<p>When Patroni is trying to figure out the necessity of <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code>, it could write the content of the history file from the primary into the log. The history file is growing with every failover/switchover and eventually starts taking up too many lines, most of which are not so useful. Instead of showing the raw data, Patroni will show only 3 lines before the current replica timeline and 2 lines after.</p>
</li>
</ul>
<p><strong>Improvements on K8s</strong></p>
<ul>
<li><p>Get rid of <code class="docutils literal notranslate"><span class="pre">kubernetes</span></code> python module (Alexander Kukushkin)</p>
<p>The official python kubernetes client contains a lot of auto-generated code and therefore very heavy. Patroni uses only a small fraction of K8s API endpoints and implementing support for them wasn’t hard.</p>
</li>
<li><p>Make it possible to bypass the <code class="docutils literal notranslate"><span class="pre">kubernetes</span></code> service (Alexander Kukushkin)</p>
<p>When running on K8s, Patroni is usually communicating with the K8s API via the <code class="docutils literal notranslate"><span class="pre">kubernetes</span></code> service, the address of which is exposed in the <code class="docutils literal notranslate"><span class="pre">KUBERNETES_SERVICE_HOST</span></code> environment variable. Like any other service, the <code class="docutils literal notranslate"><span class="pre">kubernetes</span></code> service is handled by <code class="docutils literal notranslate"><span class="pre">kube-proxy</span></code>, which in turn, depending on the configuration, is either relying on a userspace program or <code class="docutils literal notranslate"><span class="pre">iptables</span></code> for traffic routing. Skipping the intermediate component and connecting directly to the K8s master nodes allows us to implement a better retry strategy and mitigate risks of demoting Postgres when K8s master nodes are upgraded.</p>
</li>
<li><p>Sync HA loops of all pods of a Patroni cluster (Alexander Kukushkin)</p>
<p>Not doing so was increasing failure detection time from <code class="docutils literal notranslate"><span class="pre">ttl</span></code> to <code class="docutils literal notranslate"><span class="pre">ttl</span> <span class="pre">+</span> <span class="pre">loop_wait</span></code>.</p>
</li>
<li><p>Populate <code class="docutils literal notranslate"><span class="pre">references</span></code> and <code class="docutils literal notranslate"><span class="pre">nodename</span></code> in the subsets addresses on K8s (Alexander Kukushkin)</p>
<p>Some load-balancers are relying on this information.</p>
</li>
<li><p>Fix possible race conditions in the <code class="docutils literal notranslate"><span class="pre">update_leader()</span></code> (Alexander Kukushkin)</p>
<p>The concurrent update of the leader configmap or endpoint happening outside of Patroni might cause the <code class="docutils literal notranslate"><span class="pre">update_leader()</span></code> call to fail. In this case Patroni rechecks that the current node is still owning the leader lock and repeats the update.</p>
</li>
<li><p>Explicitly disallow patching non-existent config (Alexander Kukushkin)</p>
<p>For DCS other than <code class="docutils literal notranslate"><span class="pre">kubernetes</span></code> the PATCH call is failing with an exception due to <code class="docutils literal notranslate"><span class="pre">cluster.config</span></code> being <code class="docutils literal notranslate"><span class="pre">None</span></code>, but on Kubernetes it was happily creating the config annotation and preventing writing bootstrap configuration after the bootstrap finished.</p>
</li>
<li><p>Fix bug in <code class="docutils literal notranslate"><span class="pre">pause</span></code> (Alexander Kukushkin)</p>
<p>Replicas were removing <code class="docutils literal notranslate"><span class="pre">primary_conninfo</span></code> and restarting Postgres when the leader key was absent, but they should do nothing.</p>
</li>
</ul>
<p><strong>Improvements in REST API</strong></p>
<ul>
<li><p>Defer TLS handshake until worker thread has started (Alexander Kukushkin, Ben Harris)</p>
<p>If the TLS handshake was done in the API thread and the client-side didn’t send any data, the API thread was blocked (risking DoS).</p>
</li>
<li><p>Check <code class="docutils literal notranslate"><span class="pre">basic-auth</span></code> independently from client certificate in REST API (Alexander Kukushkin)</p>
<p>Previously only the client certificate was validated. Doing two checks independently is an absolutely valid use-case.</p>
</li>
<li><p>Write double <code class="docutils literal notranslate"><span class="pre">CRLF</span></code> after HTTP headers of the <code class="docutils literal notranslate"><span class="pre">OPTIONS</span></code> request (Sergey Burladyan)</p>
<p>HAProxy was happy with a single <code class="docutils literal notranslate"><span class="pre">CRLF</span></code>, while Consul health-check complained about broken connection and unexpected EOF.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/cluster</span></code> was showing stale members info for Zookeeper (Alexander Kukushkin)</p>
<p>The endpoint was using the Patroni internal cluster view. For Patroni itself it didn’t cause any issues, but when exposed to the outside world we need to show up-to-date information, especially replication lag.</p>
</li>
<li><p>Fixed health-checks for standby cluster (Alexander Kukushkin)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/standby-leader</span></code> for a master and <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/master</span></code> for a <code class="docutils literal notranslate"><span class="pre">standby_leader</span></code> were incorrectly responding with 200.</p>
</li>
<li><p>Implemented <code class="docutils literal notranslate"><span class="pre">DELETE</span> <span class="pre">/switchover</span></code> (Alexander Kukushkin)</p>
<p>The REST API call deletes the scheduled switchover.</p>
</li>
<li><p>Created <code class="docutils literal notranslate"><span class="pre">/readiness</span></code> and <code class="docutils literal notranslate"><span class="pre">/liveness</span></code> endpoints (Alexander Kukushkin)</p>
<p>They could be useful to eliminate “unhealthy” pods from subsets addresses when the K8s service is used with label selectors.</p>
</li>
<li><p>Enhanced <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/replica</span></code> and <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/async</span></code> REST API health-checks (Krishna Sarabu, Alexander Kukushkin)</p>
<p>Checks now support optional keyword <code class="docutils literal notranslate"><span class="pre">?lag=&lt;max-lag&gt;</span></code> and will respond with 200 only if the lag is smaller than the supplied value. If relying on this feature please keep in mind that information about WAL position on the leader is updated only every <code class="docutils literal notranslate"><span class="pre">loop_wait</span></code> seconds!</p>
</li>
<li><p>Added support for user defined HTTP headers in the REST API response (Yogesh Sharma)</p>
<p>This feature might be useful if requests are made from a browser.</p>
</li>
</ul>
<p><strong>Improvements in patronictl</strong></p>
<ul>
<li><p>Don’t try to call non-existing leader in <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">pause</span></code> (Alexander Kukushkin)</p>
<p>While pausing a cluster without a leader on K8s, <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> was showing warnings that member “None” could not be accessed.</p>
</li>
<li><p>Handle the case when member <code class="docutils literal notranslate"><span class="pre">conn_url</span></code> is missing (Alexander Kukushkin)</p>
<p>On K8s it is possible that the pod doesn’t have the necessary annotations because Patroni is not yet running. It was making <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> to fail.</p>
</li>
<li><p>Added ability to print ASCII cluster topology (Maxim Fedotov, Alexander Kukushkin)</p>
<p>It is very useful to get overview of the cluster with cascading replication.</p>
</li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">flush</span> <span class="pre">switchover</span></code> (Alexander Kukushkin)</p>
<p>Before that <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">flush</span></code> only supported cancelling scheduled restarts.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Attribute error during bootstrap of the cluster with existing PGDATA (Krishna Sarabu)</p>
<p>When trying to create/update the <code class="docutils literal notranslate"><span class="pre">/history</span></code> key, Patroni was accessing the <code class="docutils literal notranslate"><span class="pre">ClusterConfig</span></code> object which wasn’t created in DCS yet.</p>
</li>
<li><p>Improved exception handling in Consul (Alexander Kukushkin)</p>
<p>Unhandled exception in the <code class="docutils literal notranslate"><span class="pre">touch_member()</span></code> method caused the whole Patroni process to crash.</p>
</li>
<li><p>Enforce <code class="docutils literal notranslate"><span class="pre">synchronous_commit=local</span></code> for the <code class="docutils literal notranslate"><span class="pre">post_init</span></code> script (Alexander Kukushkin)</p>
<p>Patroni was already doing that when creating users (<code class="docutils literal notranslate"><span class="pre">replication</span></code>, <code class="docutils literal notranslate"><span class="pre">rewind</span></code>), but missing it in the case of <code class="docutils literal notranslate"><span class="pre">post_init</span></code> was an oversight. As a result, if the script wasn’t doing it internally on it’s own the bootstrap in <code class="docutils literal notranslate"><span class="pre">synchronous_mode</span></code> wasn’t able to finish.</p>
</li>
<li><p>Increased <code class="docutils literal notranslate"><span class="pre">maxsize</span></code> in the Consul pool manager (ponvenkates)</p>
<p>With the default <code class="docutils literal notranslate"><span class="pre">size=1</span></code> some warnings were generated.</p>
</li>
<li><p>Patroni was wrongly reporting Postgres as running (Alexander Kukushkin)</p>
<p>The state wasn’t updated when for example Postgres crashed due to an out-of-disk error.</p>
</li>
<li><p>Put <code class="docutils literal notranslate"><span class="pre">*</span></code> into <code class="docutils literal notranslate"><span class="pre">pgpass</span></code> instead of missing or empty values (Alexander Kukushkin)</p>
<p>If for example the <code class="docutils literal notranslate"><span class="pre">standby_cluster.port</span></code> is not specified, the <code class="docutils literal notranslate"><span class="pre">pgpass</span></code> file was incorrectly generated.</p>
</li>
<li><p>Skip physical replication slot creation on the leader node with special characters (Krishna Sarabu)</p>
<p>Patroni appeared to be creating a dormant slot (when <code class="docutils literal notranslate"><span class="pre">slots</span></code> defined) for the leader node when the name contained special chars such as ‘-’  (for e.g. “abc-us-1”).</p>
</li>
<li><p>Avoid removing non-existent <code class="docutils literal notranslate"><span class="pre">pg_hba.conf</span></code> in the custom bootstrap (Krishna Sarabu)</p>
<p>Patroni was failing if <code class="docutils literal notranslate"><span class="pre">pg_hba.conf</span></code> happened to be located outside of the <code class="docutils literal notranslate"><span class="pre">pgdata</span></code> dir after custom bootstrap.</p>
</li>
</ul>
</section>
<section id="version-1-6-5">
<h2>Version 1.6.5<a class="headerlink" href="#version-1-6-5" title="Link to this heading"></a></h2>
<p>Released 2020-08-23</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Master stop timeout (Krishna Sarabu)</p>
<p>The number of seconds Patroni is allowed to wait when stopping Postgres. Effective only when <code class="docutils literal notranslate"><span class="pre">synchronous_mode</span></code> is enabled. When set to value greater than 0 and the <code class="docutils literal notranslate"><span class="pre">synchronous_mode</span></code> is enabled, Patroni sends <code class="docutils literal notranslate"><span class="pre">SIGKILL</span></code> to the postmaster if the stop operation is running for more than the value set by <code class="docutils literal notranslate"><span class="pre">master_stop_timeout</span></code>. Set the value according to your durability/availability tradeoff. If the parameter is not set or set to non-positive value, <code class="docutils literal notranslate"><span class="pre">master_stop_timeout</span></code> does not have an effect.</p>
</li>
<li><p>Don’t create permanent physical slot with name of the primary (Alexander Kukushkin)</p>
<p>It is a common problem that the primary recycles WAL segments while the replica is down. Now we have a good solution for static clusters, with a fixed number of nodes and names that never change. You just need to list the names of all nodes in the <code class="docutils literal notranslate"><span class="pre">slots</span></code> so the primary will not remove the slot when the node is down (not registered in DCS).</p>
</li>
<li><p>First draft of Config Validator (Igor Yanchenko)</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">patroni</span> <span class="pre">--validate-config</span> <span class="pre">patroni.yaml</span></code> in order to validate Patroni configuration.</p>
</li>
<li><p>Possibility to configure max length of timelines history (Krishna Sarabu)</p>
<p>Patroni writes the history of failovers/switchovers into the <code class="docutils literal notranslate"><span class="pre">/history</span></code> key in DCS. Over time the size of this key becomes big, but in most cases only the last few lines are interesting. The <code class="docutils literal notranslate"><span class="pre">max_timelines_history</span></code> parameter allows to specify the maximum number of timeline history items to be kept in DCS.</p>
</li>
<li><p>Kazoo 2.7.0 compatibility (Danyal Prout)</p>
<p>Some non-public methods in Kazoo changed their signatures, but Patroni was relying on them.</p>
</li>
</ul>
<p><strong>Improvements in patronictl</strong></p>
<ul>
<li><p>Show member tags (Kostiantyn Nemchenko, Alexander Kukushkin)</p>
<p>Tags are configured individually for every node and there was no easy way to get an overview of them</p>
</li>
<li><p>Improve members output (Alexander Kukushkin)</p>
<p>The redundant cluster name won’t be shown anymore on every line, only in the table header.</p>
</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>patronictl<span class="w"> </span>list
+<span class="w"> </span>Cluster:<span class="w"> </span>batman<span class="w"> </span><span class="o">(</span><span class="m">6813309862653668387</span><span class="o">)</span><span class="w"> </span>+---------+----+-----------+---------------------+
<span class="p">|</span><span class="w">    </span>Member<span class="w">   </span><span class="p">|</span><span class="w">      </span>Host<span class="w">      </span><span class="p">|</span><span class="w">  </span>Role<span class="w">  </span><span class="p">|</span><span class="w">  </span>State<span class="w">  </span><span class="p">|</span><span class="w"> </span>TL<span class="w"> </span><span class="p">|</span><span class="w"> </span>Lag<span class="w"> </span><span class="k">in</span><span class="w"> </span>MB<span class="w"> </span><span class="p">|</span><span class="w"> </span>Tags<span class="w">                </span><span class="p">|</span>
+-------------+----------------+--------+---------+----+-----------+---------------------+
<span class="p">|</span><span class="w"> </span>postgresql0<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">127</span>.0.0.1:5432<span class="w"> </span><span class="p">|</span><span class="w"> </span>Leader<span class="w"> </span><span class="p">|</span><span class="w"> </span>running<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="p">|</span><span class="w">           </span><span class="p">|</span><span class="w"> </span>clonefrom:<span class="w"> </span><span class="nb">true</span><span class="w">     </span><span class="p">|</span>
<span class="p">|</span><span class="w">             </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">        </span><span class="p">|</span><span class="w">         </span><span class="p">|</span><span class="w">    </span><span class="p">|</span><span class="w">           </span><span class="p">|</span><span class="w"> </span>noloadbalance:<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">             </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">        </span><span class="p">|</span><span class="w">         </span><span class="p">|</span><span class="w">    </span><span class="p">|</span><span class="w">           </span><span class="p">|</span><span class="w"> </span>nosync:<span class="w"> </span><span class="nb">true</span><span class="w">        </span><span class="p">|</span>
+-------------+----------------+--------+---------+----+-----------+---------------------+
<span class="p">|</span><span class="w"> </span>postgresql1<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">127</span>.0.0.1:5433<span class="w"> </span><span class="p">|</span><span class="w">        </span><span class="p">|</span><span class="w"> </span>running<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">3</span><span class="w"> </span><span class="p">|</span><span class="w">       </span><span class="m">0</span>.0<span class="w"> </span><span class="p">|</span><span class="w">                     </span><span class="p">|</span>
+-------------+----------------+--------+---------+----+-----------+---------------------+
</pre></div>
</div>
<ul>
<li><p>Fail if a config file is specified explicitly but not found (Kaarel Moppel)</p>
<p>Previously <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> was only reporting a <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> message.</p>
</li>
<li><p>Solved the problem of not initialized K8s pod breaking patronictl (Alexander Kukushkin)</p>
<p>Patroni is relying on certain pod annotations on K8s. When one of the Patroni pods is stopping or starting there is no valid annotation yet and <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> was failing with an exception.</p>
</li>
</ul>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Apply 1 second backoff if LIST call to K8s API server failed (Alexander Kukushkin)</p>
<p>It is mostly necessary to avoid flooding logs, but also helps to prevent starvation of the main thread.</p>
</li>
<li><p>Retry if the <code class="docutils literal notranslate"><span class="pre">retry-after</span></code> HTTP header is returned by K8s API (Alexander Kukushkin)</p>
<p>If the K8s API server is overwhelmed with requests it might ask to retry.</p>
</li>
<li><p>Scrub <code class="docutils literal notranslate"><span class="pre">KUBERNETES_</span></code> environment from the postmaster (Feike Steenbergen)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">KUBERNETES_</span></code> environment variables are not required for PostgreSQL, yet having them exposed to the postmaster will also expose them to backends and to regular database users (using pl/perl for example).</p>
</li>
<li><p>Clean up tablespaces on reinitialize (Krishna Sarabu)</p>
<p>During reinit, Patroni was removing only <code class="docutils literal notranslate"><span class="pre">PGDATA</span></code> and leaving user-defined tablespace directories. This is causing Patroni to loop in reinit. The previous workarond for the problem was implementing the <a class="reference internal" href="replica_bootstrap.html#custom-bootstrap"><span class="std std-ref">custom bootstrap</span></a> script.</p>
</li>
<li><p>Explicitly execute <code class="docutils literal notranslate"><span class="pre">CHECKPOINT</span></code> after promote happened (Alexander Kukushkin)</p>
<p>It helps to reduce the time before the new primary is usable for <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code>.</p>
</li>
<li><p>Smart refresh of Etcd members (Alexander Kukushkin)</p>
<p>In case Patroni failed to execute a request on all members of the Etcd cluster, Patroni will re-check <code class="docutils literal notranslate"><span class="pre">A</span></code> or <code class="docutils literal notranslate"><span class="pre">SRV</span></code> records for changes of IPs/hosts before retrying the next time.</p>
</li>
<li><p>Skip missing values from <code class="docutils literal notranslate"><span class="pre">pg_controldata</span></code> (Feike Steenbergen)</p>
<p>Values are missing when trying to use binaries of a version that doesn’t match PGDATA. Patroni will try to start Postgres anyway, and Postgres will complain that the major version doesn’t match and abort with an error.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Disable SSL verification for Consul when required (Julien Riou)</p>
<p>Starting from a certain version of <code class="docutils literal notranslate"><span class="pre">urllib3</span></code>, the <code class="docutils literal notranslate"><span class="pre">cert_reqs</span></code> must be explicitly set to <code class="docutils literal notranslate"><span class="pre">ssl.CERT_NONE</span></code> in order to effectively disable SSL verification.</p>
</li>
<li><p>Avoid opening replication connection on every cycle of HA loop (Alexander Kukushkin)</p>
<p>Regression was introduced in 1.6.4.</p>
</li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">on_role_change</span></code> callback on failed primary (Alexander Kukushkin)</p>
<p>In certain cases it could lead to the virtual IP remaining attached to the old primary. Regression was introduced in 1.4.5.</p>
</li>
<li><p>Reset rewind state if postgres started after successful pg_rewind (Alexander Kukushkin)</p>
<p>As a result of this bug Patroni was starting up manually shut down postgres in the pause mode.</p>
</li>
<li><p>Convert <code class="docutils literal notranslate"><span class="pre">recovery_min_apply_delay</span></code> to <code class="docutils literal notranslate"><span class="pre">ms</span></code> when checking <code class="docutils literal notranslate"><span class="pre">recovery.conf</span></code></p>
<p>Patroni was indefinitely restarting replica if <code class="docutils literal notranslate"><span class="pre">recovery_min_apply_delay</span></code> was configured on PostgreSQL older than 12.</p>
</li>
<li><p>PyInstaller compatibility (Alexander Kukushkin)</p>
<p>PyInstaller freezes (packages) Python applications into stand-alone executables. The compatibility was broken when we switched to the <code class="docutils literal notranslate"><span class="pre">spawn</span></code> method instead of <code class="docutils literal notranslate"><span class="pre">fork</span></code> for <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code>.</p>
</li>
</ul>
</section>
<section id="version-1-6-4">
<h2>Version 1.6.4<a class="headerlink" href="#version-1-6-4" title="Link to this heading"></a></h2>
<p>Released 2020-01-27</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Implemented <code class="docutils literal notranslate"><span class="pre">--wait</span></code> option for <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">reinit</span></code> (Igor Yanchenko)</p>
<p>Patronictl will wait for <code class="docutils literal notranslate"><span class="pre">reinit</span></code> to finish is the <code class="docutils literal notranslate"><span class="pre">--wait</span></code> option is used.</p>
</li>
<li><p>Further improvements of Windows support (Igor Yanchenko, Alexander Kukushkin)</p>
<ol class="arabic simple">
<li><p>All shell scripts which are used for integration testing are rewritten in python</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">pg_ctl</span> <span class="pre">kill</span></code> will be used to stop postgres on non posix systems</p></li>
<li><p>Don’t try to use unix-domain sockets</p></li>
</ol>
</li>
</ul>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Make sure <code class="docutils literal notranslate"><span class="pre">unix_socket_directories</span></code> and <code class="docutils literal notranslate"><span class="pre">stats_temp_directory</span></code> exist (Igor Yanchenko)</p>
<p>Upon the start of Patroni and Postgres make sure that <code class="docutils literal notranslate"><span class="pre">unix_socket_directories</span></code> and <code class="docutils literal notranslate"><span class="pre">stats_temp_directory</span></code> exist or try to create them. Patroni will exit if failed to create them.</p>
</li>
<li><p>Make sure <code class="docutils literal notranslate"><span class="pre">postgresql.pgpass</span></code> is located in the place where Patroni has write access (Igor Yanchenko)</p>
<p>In case if it doesn’t have a write access Patroni will exit with exception.</p>
</li>
<li><p>Disable Consul <code class="docutils literal notranslate"><span class="pre">serfHealth</span></code> check by default (Kostiantyn Nemchenko)</p>
<p>Even in case of little network problems the failing <code class="docutils literal notranslate"><span class="pre">serfHealth</span></code> leads to invalidation of all sessions associated with the node. Therefore, the leader key is lost much earlier than <code class="docutils literal notranslate"><span class="pre">ttl</span></code> which causes unwanted restarts of replicas and maybe demotion of the primary.</p>
</li>
<li><p>Configure tcp keepalives for connections to K8s API (Alexander Kukushkin)</p>
<p>In case if we get nothing from the socket after TTL seconds it can be considered dead.</p>
</li>
<li><p>Avoid logging of passwords on user creation (Alexander Kukushkin)</p>
<p>If the password is rejected or logging is configured to verbose or not configured at all it might happen that the password is written into postgres logs. In order to avoid it Patroni will change <code class="docutils literal notranslate"><span class="pre">log_statement</span></code>, <code class="docutils literal notranslate"><span class="pre">log_min_duration_statement</span></code>, and <code class="docutils literal notranslate"><span class="pre">log_min_error_statement</span></code> to some safe values before doing the attempt to create/update user.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">restore_command</span></code> from the <code class="docutils literal notranslate"><span class="pre">standby_cluster</span></code> config on cascading replicas (Alexander Kukushkin)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">standby_leader</span></code> was already doing it from the beginning the feature existed. Not doing the same on replicas might prevent them from catching up with standby leader.</p>
</li>
<li><p>Update timeline reported by the standby cluster (Alexander Kukushkin)</p>
<p>In case of timeline switch the standby cluster was correctly replicating from the primary but <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> was reporting the old timeline.</p>
</li>
<li><p>Allow certain recovery parameters be defined in the custom_conf (Alexander Kukushkin)</p>
<p>When doing validation of recovery parameters on replica Patroni will skip <code class="docutils literal notranslate"><span class="pre">archive_cleanup_command</span></code>, <code class="docutils literal notranslate"><span class="pre">promote_trigger_file</span></code>, <code class="docutils literal notranslate"><span class="pre">recovery_end_command</span></code>, <code class="docutils literal notranslate"><span class="pre">recovery_min_apply_delay</span></code>, and <code class="docutils literal notranslate"><span class="pre">restore_command</span></code> if they are not defined in the patroni config but in files other than <code class="docutils literal notranslate"><span class="pre">postgresql.auto.conf</span></code> or <code class="docutils literal notranslate"><span class="pre">postgresql.conf</span></code>.</p>
</li>
<li><p>Improve handling of postgresql parameters with period in its name (Alexander Kukushkin)</p>
<p>Such parameters could be defined by extensions where the unit is not necessarily a string. Changing the value might require a restart (for example <code class="docutils literal notranslate"><span class="pre">pg_stat_statements.max</span></code>).</p>
</li>
<li><p>Improve exception handling during shutdown (Alexander Kukushkin)</p>
<p>During shutdown Patroni is trying to update its status in the DCS. If the DCS is inaccessible an exception might be raised. Lack of exception handling was preventing logger thread from stopping.</p>
</li>
</ul>
</section>
<section id="version-1-6-3">
<h2>Version 1.6.3<a class="headerlink" href="#version-1-6-3" title="Link to this heading"></a></h2>
<p>Released 2019-12-05</p>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Don’t expose password when running <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> (Alexander Kukushkin)</p>
<p>Bug was introduced in the <a class="reference external" href="https://github.com/patroni/patroni/pull/1301">#1301</a></p>
</li>
<li><p>Apply connection parameters specified in the <code class="docutils literal notranslate"><span class="pre">postgresql.authentication</span></code> to <code class="docutils literal notranslate"><span class="pre">pg_basebackup</span></code> and custom replica creation methods (Alexander Kukushkin)</p>
<p>They were relying on url-like connection string and therefore parameters never applied.</p>
</li>
</ul>
</section>
<section id="version-1-6-2">
<h2>Version 1.6.2<a class="headerlink" href="#version-1-6-2" title="Link to this heading"></a></h2>
<p>Released 2019-12-05</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Implemented <code class="docutils literal notranslate"><span class="pre">patroni</span> <span class="pre">--version</span></code> (Igor Yanchenko)</p>
<p>It prints the current version of Patroni and exits.</p>
</li>
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">user-agent</span></code> http header for all http requests (Alexander Kukushkin)</p>
<p>Patroni is communicating with Consul, Etcd, and Kubernetes API via the http protocol. Having a specifically crafted <code class="docutils literal notranslate"><span class="pre">user-agent</span></code> (example: <code class="docutils literal notranslate"><span class="pre">Patroni/1.6.2</span> <span class="pre">Python/3.6.8</span> <span class="pre">Linux</span></code>) might be useful for debugging and monitoring.</p>
</li>
<li><p>Make it possible to configure log level for exception tracebacks (Igor Yanchenko)</p>
<p>If you set <code class="docutils literal notranslate"><span class="pre">log.traceback_level=DEBUG</span></code> the tracebacks will be visible only when <code class="docutils literal notranslate"><span class="pre">log.level=DEBUG</span></code>. The default behavior remains the same.</p>
</li>
</ul>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Avoid importing all DCS modules when searching for the module required by the config file (Alexander Kukushkin)</p>
<p>There is no need to import modules for Etcd, Consul, and Kubernetes if we need only e.g. Zookeeper. It helps to reduce memory usage and solves the problem of having INFO messages <code class="docutils literal notranslate"><span class="pre">Failed</span> <span class="pre">to</span> <span class="pre">import</span> <span class="pre">smth</span></code>.</p>
</li>
<li><p>Removed python <code class="docutils literal notranslate"><span class="pre">requests</span></code> module from explicit requirements (Alexander Kukushkin)</p>
<p>It wasn’t used for anything critical, but causing a lot of problems when the new version of <code class="docutils literal notranslate"><span class="pre">urllib3</span></code> is released.</p>
</li>
<li><p>Improve handling of <code class="docutils literal notranslate"><span class="pre">etcd.hosts</span></code> written as a comma-separated string instead of YAML array (Igor Yanchenko)</p>
<p>Previously it was failing when written in format <code class="docutils literal notranslate"><span class="pre">host1:port1,</span> <span class="pre">host2:port2</span></code> (the space character after the comma).</p>
</li>
</ul>
<p><strong>Usability improvements</strong></p>
<ul>
<li><p>Don’t force users to choose members from an empty list in <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> (Igor Yanchenko)</p>
<p>If the user provides a wrong cluster name, we will raise an exception rather than ask to choose a member from an empty list.</p>
</li>
<li><p>Make the error message more helpful if the REST API cannot bind (Igor Yanchenko)</p>
<p>For an inexperienced user it might be hard to figure out what is wrong from the Python stacktrace.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Fix calculation of <code class="docutils literal notranslate"><span class="pre">wal_buffers</span></code> (Alexander Kukushkin)</p>
<p>The base unit has been changed from 8 kB blocks to bytes in PostgreSQL 11.</p>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">passfile</span></code> in <code class="docutils literal notranslate"><span class="pre">primary_conninfo</span></code> only on PostgreSQL 10+ (Alexander Kukushkin)</p>
<p>On older versions there is no guarantee that <code class="docutils literal notranslate"><span class="pre">passfile</span></code> will work, unless the latest version of <code class="docutils literal notranslate"><span class="pre">libpq</span></code> is installed.</p>
</li>
</ul>
</section>
<section id="version-1-6-1">
<h2>Version 1.6.1<a class="headerlink" href="#version-1-6-1" title="Link to this heading"></a></h2>
<p>Released 2019-11-15</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Added <code class="docutils literal notranslate"><span class="pre">PATRONICTL_CONFIG_FILE</span></code> environment variable (msvechla)</p>
<p>It allows configuring the <code class="docutils literal notranslate"><span class="pre">--config-file</span></code> argument for <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> from the environment.</p>
</li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">history</span></code> (Alexander Kukushkin)</p>
<p>It shows the history of failovers/switchovers.</p>
</li>
<li><p>Pass <code class="docutils literal notranslate"><span class="pre">-c</span> <span class="pre">statement_timeout=0</span></code> in <code class="docutils literal notranslate"><span class="pre">PGOPTIONS</span></code> when doing <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> (Alexander Kukushkin)</p>
<p>It protects from the case when <code class="docutils literal notranslate"><span class="pre">statement_timeout</span></code> on the server is set to some small value and one of the statements executed by pg_rewind is canceled.</p>
</li>
<li><p>Allow lower values for PostgreSQL configuration (Soulou)</p>
<p>Patroni didn’t allow some of the PostgreSQL configuration parameters be set smaller than some hardcoded values. Now the minimal allowed values are smaller, default values have not been changed.</p>
</li>
<li><p>Allow for certificate-based authentication (Jonathan S. Katz)</p>
<p>This feature enables certificate-based authentication for superuser, replication, rewind accounts and allows the user to specify the <code class="docutils literal notranslate"><span class="pre">sslmode</span></code> they wish to connect with.</p>
</li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">passfile</span></code> in the <code class="docutils literal notranslate"><span class="pre">primary_conninfo</span></code> instead of password (Alexander Kukushkin)</p>
<p>It allows to avoid setting <code class="docutils literal notranslate"><span class="pre">600</span></code> permissions on postgresql.conf</p>
</li>
<li><p>Perform <code class="docutils literal notranslate"><span class="pre">pg_ctl</span> <span class="pre">reload</span></code> regardless of config changes (Alexander Kukushkin)</p>
<p>It is possible that some config files are not controlled by Patroni. When somebody is doing a reload via the REST API or by sending SIGHUP to the Patroni process, the usual expectation is that Postgres will also be reloaded. Previously it didn’t happen when there were no changes in the <code class="docutils literal notranslate"><span class="pre">postgresql</span></code> section of Patroni config.</p>
</li>
<li><p>Compare all recovery parameters, not only <code class="docutils literal notranslate"><span class="pre">primary_conninfo</span></code> (Alexander Kukushkin)</p>
<p>Previously the <code class="docutils literal notranslate"><span class="pre">check_recovery_conf()</span></code> method was only checking whether <code class="docutils literal notranslate"><span class="pre">primary_conninfo</span></code> has changed, never taking into account all other recovery parameters.</p>
</li>
<li><p>Make it possible to apply some recovery parameters without restart (Alexander Kukushkin)</p>
<p>Starting from PostgreSQL 12 the following recovery parameters could be changed without restart: <code class="docutils literal notranslate"><span class="pre">archive_cleanup_command</span></code>, <code class="docutils literal notranslate"><span class="pre">promote_trigger_file</span></code>, <code class="docutils literal notranslate"><span class="pre">recovery_end_command</span></code>, and <code class="docutils literal notranslate"><span class="pre">recovery_min_apply_delay</span></code>. In future Postgres releases this list will be extended and Patroni will support it automatically.</p>
</li>
<li><p>Make it possible to change <code class="docutils literal notranslate"><span class="pre">use_slots</span></code> online (Alexander Kukushkin)</p>
<p>Previously it required restarting Patroni and removing slots manually.</p>
</li>
<li><p>Remove only <code class="docutils literal notranslate"><span class="pre">PATRONI_</span></code> prefixed environment variables when starting up Postgres (Cody Coons)</p>
<p>It will solve a lot of problems with running different Foreign Data Wrappers.</p>
</li>
</ul>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Use LIST + WATCH when working with K8s API (Alexander Kukushkin)</p>
<p>It allows to efficiently receive object changes (pods, endpoints/configmaps) and makes less stress on K8s master nodes.</p>
</li>
<li><p>Improve the workflow when PGDATA is not empty during bootstrap (Alexander Kukushkin)</p>
<p>According to the <code class="docutils literal notranslate"><span class="pre">initdb</span></code> source code it might consider a PGDATA empty when there are only <code class="docutils literal notranslate"><span class="pre">lost+found</span></code> and <code class="docutils literal notranslate"><span class="pre">.dotfiles</span></code> in it. Now Patroni does the same. If <code class="docutils literal notranslate"><span class="pre">PGDATA</span></code> happens to be non-empty, and at the same time not valid from the <code class="docutils literal notranslate"><span class="pre">pg_controldata</span></code> point of view, Patroni will complain and exit.</p>
</li>
<li><p>Avoid calling expensive <code class="docutils literal notranslate"><span class="pre">os.listdir()</span></code> on every HA loop (Alexander Kukushkin)</p>
<p>When the system is under IO stress, <code class="docutils literal notranslate"><span class="pre">os.listdir()</span></code> could take a few seconds (or even minutes) to execute, badly affecting the HA loop of Patroni. This could even cause the leader key to disappear from DCS due to the lack of updates. There is a better and less expensive way to check that the PGDATA is not empty. Now we check the presence of the <code class="docutils literal notranslate"><span class="pre">global/pg_control</span></code> file in the PGDATA.</p>
</li>
<li><p>Some improvements in logging infrastructure (Alexander Kukushkin)</p>
<p>Previously there was a possibility to loose the last few log lines on shutdown because the logging thread was a <code class="docutils literal notranslate"><span class="pre">daemon</span></code> thread.</p>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">spawn</span></code> multiprocessing start method on python 3.4+ (Maciej Kowalczyk)</p>
<p>It is a known <a class="reference external" href="https://bugs.python.org/issue6721">issue</a> in Python that threading and multiprocessing do not mix well. Switching from the default method <code class="docutils literal notranslate"><span class="pre">fork</span></code> to the <code class="docutils literal notranslate"><span class="pre">spawn</span></code> is a recommended workaround. Not doing so might result in the Postmaster starting process hanging and Patroni indefinitely reporting <code class="docutils literal notranslate"><span class="pre">INFO:</span> <span class="pre">restarting</span> <span class="pre">after</span> <span class="pre">failure</span> <span class="pre">in</span> <span class="pre">progress</span></code>, while  Postgres is actually up and running.</p>
</li>
</ul>
<p><strong>Improvements in REST API</strong></p>
<ul>
<li><p>Make it possible to check client certificates in the REST API (Alexander Kukushkin)</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">verify_client</span></code> is set to <code class="docutils literal notranslate"><span class="pre">required</span></code>, Patroni will check client certificates for all REST API calls. When it is set to <code class="docutils literal notranslate"><span class="pre">optional</span></code>, client certificates are checked for all unsafe REST API endpoints.</p>
</li>
<li><p>Return the response code 503 for the <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/replica</span></code> health check request if Postgres is not running (Alexander Anikin)</p>
<p>Postgres might spend significant time in recovery before it starts accepting client connections.</p>
</li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">/history</span></code> and <code class="docutils literal notranslate"><span class="pre">/cluster</span></code> endpoints (Alexander Kukushkin)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">/history</span></code> endpoint shows the content of the <code class="docutils literal notranslate"><span class="pre">history</span></code> key in DCS. The <code class="docutils literal notranslate"><span class="pre">/cluster</span></code> endpoint shows all cluster members and some service info like pending and scheduled restarts or switchovers.</p>
</li>
</ul>
<p><strong>Improvements in Etcd support</strong></p>
<ul>
<li><p>Retry on Etcd RAFT internal error (Alexander Kukushkin)</p>
<p>When the Etcd node is being shut down, it sends <code class="docutils literal notranslate"><span class="pre">response</span> <span class="pre">code=300,</span> <span class="pre">data='etcdserver:</span> <span class="pre">server</span> <span class="pre">stopped'</span></code>, which was causing Patroni to demote the primary.</p>
</li>
<li><p>Don’t give up on Etcd request retry too early (Alexander Kukushkin)</p>
<p>When there were some network problems, Patroni was quickly exhausting the list of Etcd nodes and giving up without using the whole <code class="docutils literal notranslate"><span class="pre">retry_timeout</span></code>, potentially resulting in demoting the primary.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Disable <code class="docutils literal notranslate"><span class="pre">synchronous_commit</span></code> when granting execute permissions to the <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> user (kremius)</p>
<p>If the bootstrap is done with <code class="docutils literal notranslate"><span class="pre">synchronous_mode_strict:</span> <span class="pre">true</span></code> the <cite>GRANT EXECUTE</cite> statement was waiting indefinitely due to the non-synchronous nodes being available.</p>
</li>
<li><p>Fix memory leak on python 3.7 (Alexander Kukushkin)</p>
<p>Patroni is using <code class="docutils literal notranslate"><span class="pre">ThreadingMixIn</span></code> to process REST API requests and python 3.7 made threads spawn for every request non-daemon by default.</p>
</li>
<li><p>Fix race conditions in asynchronous actions (Alexander Kukushkin)</p>
<p>There was a chance that <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">reinit</span> <span class="pre">--force</span></code> could be overwritten by the attempt to recover stopped Postgres. This ended up in a situation when Patroni was trying to start Postgres while basebackup was running.</p>
</li>
<li><p>Fix race condition in <code class="docutils literal notranslate"><span class="pre">postmaster_start_time()</span></code> method (Alexander Kukushkin)</p>
<p>If the method is executed from the REST API thread, it requires a separate cursor object to be created.</p>
</li>
<li><p>Fix the problem of not promoting the sync standby that had a name containing upper case letters (Alexander Kukushkin)</p>
<p>We converted the name to the lower case because Postgres was doing the same while comparing the <code class="docutils literal notranslate"><span class="pre">application_name</span></code> with the value in <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code>.</p>
</li>
<li><p>Kill all children along with the callback process before starting the new one (Alexander Kukushkin)</p>
<p>Not doing so makes it hard to implement callbacks in bash and eventually can lead to the situation when two callbacks are running at the same time.</p>
</li>
<li><p>Fix ‘start failed’ issue (Alexander Kukushkin)</p>
<p>Under certain conditions the Postgres state might be set to ‘start failed’ despite Postgres being up and running.</p>
</li>
</ul>
</section>
<section id="version-1-6-0">
<h2>Version 1.6.0<a class="headerlink" href="#version-1-6-0" title="Link to this heading"></a></h2>
<p>Released 2019-08-05</p>
<p>This version adds compatibility with PostgreSQL 12, makes is possible to run pg_rewind without superuser on PostgreSQL 11 and newer, and enables IPv6 support.</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Psycopg2 was removed from requirements and must be installed independently (Alexander Kukushkin)</p>
<p>Starting from 2.8.0 <code class="docutils literal notranslate"><span class="pre">psycopg2</span></code> was split into two different packages, <code class="docutils literal notranslate"><span class="pre">psycopg2</span></code>, and <code class="docutils literal notranslate"><span class="pre">psycopg2-binary</span></code>, which could be installed at the same time into the same place on the filesystem. In order to decrease dependency hell problem, we let a user choose how to install it. There are a few options available, please consult the <a class="reference internal" href="installation.html#psycopg2-install-options"><span class="std std-ref">documentation</span></a>.</p>
</li>
<li><p>Compatibility with PostgreSQL 12 (Alexander Kukushkin)</p>
<p>Starting from PostgreSQL 12 there is no <code class="docutils literal notranslate"><span class="pre">recovery.conf</span></code> anymore and all former recovery parameters are converted into <a class="reference external" href="https://www.enterprisedb.com/blog/what-is-a-guc-variable">GUC</a>. In order to protect from <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">SYSTEM</span> <span class="pre">SET</span> <span class="pre">primary_conninfo</span></code> or similar, Patroni will parse <code class="docutils literal notranslate"><span class="pre">postgresql.auto.conf</span></code> and remove all standby and recovery parameters from there. Patroni config remains backward compatible. For example despite <code class="docutils literal notranslate"><span class="pre">restore_command</span></code> being a GUC, one can still specify it in the <code class="docutils literal notranslate"><span class="pre">postgresql.recovery_conf.restore_command</span></code> section and Patroni will write it into <code class="docutils literal notranslate"><span class="pre">postgresql.conf</span></code> for PostgreSQL 12.</p>
</li>
<li><p>Make it possible to use <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> without superuser on PostgreSQL 11 and newer (Alexander Kukushkin)</p>
<p>If you want to use this feature please define <code class="docutils literal notranslate"><span class="pre">username</span></code> and <code class="docutils literal notranslate"><span class="pre">password</span></code> in the <code class="docutils literal notranslate"><span class="pre">postgresql.authentication.rewind</span></code> section of Patroni configuration file. For an already existing cluster you will have to create the user manually and <code class="docutils literal notranslate"><span class="pre">GRANT</span> <span class="pre">EXECUTE</span></code> permission on a few functions. You can find more details in the PostgreSQL <a class="reference external" href="https://www.postgresql.org/docs/11/app-pgrewind.html#id-1.9.5.8.8">documentation</a>.</p>
</li>
<li><p>Do a smart comparison of actual and desired <code class="docutils literal notranslate"><span class="pre">primary_conninfo</span></code> values on replicas (Alexander Kukushkin)</p>
<p>It might help to avoid replica restart when you are converting an already existing primary-standby cluster to one managed by Patroni</p>
</li>
<li><p>IPv6 support (Alexander Kukushkin)</p>
<p>There were two major issues. Patroni REST API service was listening only on <code class="docutils literal notranslate"><span class="pre">0.0.0.0</span></code> and IPv6 IP addresses used in the <code class="docutils literal notranslate"><span class="pre">api_url</span></code> and <code class="docutils literal notranslate"><span class="pre">conn_url</span></code> were not properly quoted.</p>
</li>
<li><p>Kerberos support (Ajith Vilas, Alexander Kukushkin)</p>
<p>It makes possible using Kerberos authentication between Postgres nodes instead of defining passwords in Patroni configuration file</p>
</li>
<li><p>Manage <code class="docutils literal notranslate"><span class="pre">pg_ident.conf</span></code> (Alexander Kukushkin)</p>
<p>This functionality works similarly to <code class="docutils literal notranslate"><span class="pre">pg_hba.conf</span></code>: if the <code class="docutils literal notranslate"><span class="pre">postgresql.pg_ident</span></code> is defined in the config file or DCS, Patroni will write its value to <code class="docutils literal notranslate"><span class="pre">pg_ident.conf</span></code>, however, if <code class="docutils literal notranslate"><span class="pre">postgresql.parameters.ident_file</span></code> is defined, Patroni will assume that <code class="docutils literal notranslate"><span class="pre">pg_ident</span></code> is managed from outside and not update the file.</p>
</li>
</ul>
<p><strong>Improvements in REST API</strong></p>
<ul>
<li><p>Added <code class="docutils literal notranslate"><span class="pre">/health</span></code> endpoint (Wilfried Roset)</p>
<p>It will return an HTTP status code only if PostgreSQL is running</p>
</li>
<li><p>Added <code class="docutils literal notranslate"><span class="pre">/read-only</span></code> and <code class="docutils literal notranslate"><span class="pre">/read-write</span></code> endpoints (Julien Riou)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">/read-only</span></code> endpoint enables reads balanced across replicas and the primary. The <code class="docutils literal notranslate"><span class="pre">/read-write</span></code> endpoint is an alias for <code class="docutils literal notranslate"><span class="pre">/primary</span></code>, <code class="docutils literal notranslate"><span class="pre">/leader</span></code> and <code class="docutils literal notranslate"><span class="pre">/master</span></code>.</p>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">SSLContext</span></code> to wrap the REST API socket (Julien Riou)</p>
<p>Usage of <code class="docutils literal notranslate"><span class="pre">ssl.wrap_socket()</span></code> is deprecated and was still allowing soon-to-be-deprecated protocols like TLS 1.1.</p>
</li>
</ul>
<p><strong>Logging improvements</strong></p>
<ul>
<li><p>Two-step logging (Alexander Kukushkin)</p>
<p>All log messages are first written into the in-memory queue and later they are asynchronously flushed into the stderr or file from a separate thread. The maximum queue size is limited (configurable). If the limit is reached, Patroni will start losing logs, which is still better than blocking the HA loop.</p>
</li>
<li><p>Enable debug logging for GET/OPTIONS API calls together with latency (Jan Tomsa)</p>
<p>It will help with debugging of health-checks performed by HAProxy, Consul or other tooling that decides which node is the primary/replica.</p>
</li>
<li><p>Log exceptions caught in Retry (Daniel Kucera)</p>
<p>Log the final exception when either the number of attempts or the timeout were reached. It will hopefully help to debug some issues when communication to DCS fails.</p>
</li>
</ul>
<p><strong>Improvements in patronictl</strong></p>
<ul>
<li><p>Enhance dialogues for scheduled switchover and restart (Rafia Sabih)</p>
<p>Previously dialogues did not take into account scheduled actions and therefore were misleading.</p>
</li>
<li><p>Check if config file exists (Wilfried Roset)</p>
<p>Be verbose about configuration file when the given filename does not exists, instead of ignoring silently (which can lead to misunderstanding).</p>
</li>
<li><p>Add fallback value for <code class="docutils literal notranslate"><span class="pre">EDITOR</span></code> (Wilfried Roset)</p>
<p>When the <code class="docutils literal notranslate"><span class="pre">EDITOR</span></code> environment variable was not defined, <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">edit-config</span></code> was failing with <cite>PatroniCtlException</cite>. The new strategy is to try <code class="docutils literal notranslate"><span class="pre">editor</span></code> and than <code class="docutils literal notranslate"><span class="pre">vi</span></code>, which should be available on most systems.</p>
</li>
</ul>
<p><strong>Improvements in Consul support</strong></p>
<ul>
<li><p>Allow to specify Consul consistency mode (Jan Tomsa)</p>
<p>You can read more about consistency mode <a class="reference external" href="https://www.consul.io/api/features/consistency.html">here</a>.</p>
</li>
<li><p>Reload Consul config on SIGHUP (Cameron Daniel Kucera, Alexander Kukushkin)</p>
<p>It is especially useful when somebody is changing the value of <code class="docutils literal notranslate"><span class="pre">token</span></code>.</p>
</li>
</ul>
<p><strong>Bugfixes</strong></p>
<ul>
<li><p>Fix corner case in switchover/failover (Sharoon Thomas)</p>
<p>The variable <code class="docutils literal notranslate"><span class="pre">scheduled_at</span></code> may be undefined if REST API is not accessible and we are using DCS as a fallback.</p>
</li>
<li><p>Open trust to localhost in <code class="docutils literal notranslate"><span class="pre">pg_hba.conf</span></code> during custom bootstrap (Alexander Kukushkin)</p>
<p>Previously it was open only to unix_socket, which was causing a lot of errors: <code class="docutils literal notranslate"><span class="pre">FATAL:</span>&#160; <span class="pre">no</span> <span class="pre">pg_hba.conf</span> <span class="pre">entry</span> <span class="pre">for</span> <span class="pre">replication</span> <span class="pre">connection</span> <span class="pre">from</span> <span class="pre">host</span> <span class="pre">&quot;127.0.0.1&quot;,</span> <span class="pre">user</span> <span class="pre">&quot;replicator&quot;</span></code></p>
</li>
<li><p>Consider synchronous node as healthy even when the former leader is ahead (Alexander Kukushkin)</p>
<p>If the primary loses access to the DCS, it restarts Postgres in read-only, but it might happen that other nodes can still access the old primary via the REST API. Such a situation was causing the synchronous standby not to promote because the old primary was reporting WAL position ahead of the synchronous standby.</p>
</li>
<li><p>Standby cluster bugfixes (Alexander Kukushkin)</p>
<p>Make it possible to bootstrap a replica in a standby cluster when the standby_leader is not accessible and a few other minor fixes.</p>
</li>
</ul>
</section>
<section id="version-1-5-6">
<h2>Version 1.5.6<a class="headerlink" href="#version-1-5-6" title="Link to this heading"></a></h2>
<p>Released 2019-08-03</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Support work with etcd cluster via set of proxies (Alexander Kukushkin)</p>
<p>It might happen that etcd cluster is not accessible directly but via set of proxies. In this case Patroni will not perform etcd topology discovery but just round-robin via proxy hosts. Behavior is controlled by <cite>etcd.use_proxies</cite>.</p>
</li>
<li><p>Changed callbacks behavior when role on the node is changed (Alexander Kukushkin)</p>
<p>If the role was changed from <cite>master</cite> or <cite>standby_leader</cite> to <cite>replica</cite> or from <cite>replica</cite> to <cite>standby_leader</cite>, <cite>on_restart</cite> callback will not be called anymore in favor of <cite>on_role_change</cite> callback.</p>
</li>
<li><p>Change the way how we start postgres (Alexander Kukushkin)</p>
<p>Use <cite>multiprocessing.Process</cite> instead of executing itself and <cite>multiprocessing.Pipe</cite> to transmit the postmaster pid to the Patroni process. Before that we were using pipes, what was leaving postmaster process with stdin closed.</p>
</li>
</ul>
<p><strong>Bug fixes</strong></p>
<ul>
<li><p>Fix role returned by REST API for the standby leader (Alexander Kukushkin)</p>
<p>It was incorrectly returning <cite>replica</cite> instead of <cite>standby_leader</cite></p>
</li>
<li><p>Wait for callback end if it could not be killed (Julien Tachoires)</p>
<p>Patroni doesn’t have enough privileges to terminate the callback script running under <cite>sudo</cite> what was cancelling the new callback. If the running script could not be killed, Patroni will wait until it finishes and then run the next callback.</p>
</li>
<li><p>Reduce lock time taken by dcs.get_cluster method (Alexander Kukushkin)</p>
<p>Due to the lock being held DCS slowness was affecting the REST API health checks causing false positives.</p>
</li>
<li><p>Improve cleaning of PGDATA when <cite>pg_wal</cite>/<cite>pg_xlog</cite> is a symlink (Julien Tachoires)</p>
<p>In this case Patroni will explicitly remove files from the target directory.</p>
</li>
<li><p>Remove unnecessary usage of os.path.relpath (Ants Aasma)</p>
<p>It depends on being able to resolve the working directory, what will fail if Patroni is started in a directory that is later unlinked from the filesystem.</p>
</li>
<li><p>Do not enforce ssl version when communicating with Etcd (Alexander Kukushkin)</p>
<p>For some unknown reason python3-etcd on debian and ubuntu are not based on the latest version of the package and therefore it enforces TLSv1 which is not supported by Etcd v3. We solved this problem on Patroni side.</p>
</li>
</ul>
</section>
<section id="version-1-5-5">
<h2>Version 1.5.5<a class="headerlink" href="#version-1-5-5" title="Link to this heading"></a></h2>
<p>Released 2019-02-15</p>
<p>This version introduces the possibility of automatic reinit of the former master, improves patronictl list output and fixes a number of bugs.</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Add support of <cite>PATRONI_ETCD_PROTOCOL</cite>, <cite>PATRONI_ETCD_USERNAME</cite> and <cite>PATRONI_ETCD_PASSWORD</cite> environment variables (Étienne M)</p>
<p>Before it was possible to configure them only in the config file or as a part of <cite>PATRONI_ETCD_URL</cite>, which is not always convenient.</p>
</li>
<li><p>Make it possible to automatically reinit the former master (Alexander Kukushkin)</p>
<p>If the pg_rewind is disabled or can’t be used, the former master could fail to start as a new replica due to diverged timelines. In this case, the only way to fix it is wiping the data directory and reinitializing. This behavior could be changed by setting <cite>postgresql.remove_data_directory_on_diverged_timelines</cite>. When it is set, Patroni will wipe the data directory and reinitialize the former master automatically.</p>
</li>
<li><p>Show information about timelines in patronictl list (Alexander Kukushkin)</p>
<p>It helps to detect stale replicas. In addition to that, <cite>Host</cite> will include ‘:{port}’ if the port value isn’t default or there is more than one member running on the same host.</p>
</li>
<li><p>Create a headless service associated with the $SCOPE-config endpoint (Alexander Kukushkin)</p>
<p>The “config” endpoint keeps information about the cluster-wide Patroni and Postgres configuration, history file, and last but the most important, it holds the <cite>initialize</cite> key. When the Kubernetes master node is restarted or upgraded, it removes endpoints without services. The headless service will prevent it from being removed.</p>
</li>
</ul>
<p><strong>Bug fixes</strong></p>
<ul>
<li><p>Adjust the read timeout for the leader watch blocking query (Alexander Kukushkin)</p>
<p>According to the Consul documentation, the actual response timeout is increased by a small random amount of additional wait time added to the supplied maximum wait time to spread out the wake up time of any concurrent requests. It adds up to <cite>wait / 16</cite> additional time to the maximum duration. In our case we are adding <cite>wait / 15</cite> or 1 second depending on what is bigger.</p>
</li>
<li><p>Always use replication=1 when connecting via replication protocol to the postgres (Alexander Kukushkin)</p>
<p>Starting from Postgres 10 the line in the pg_hba.conf with database=replication doesn’t accept connections with the parameter replication=database.</p>
</li>
<li><p>Don’t write primary_conninfo into recovery.conf for wal-only standby cluster (Alexander Kukushkin)</p>
<p>Despite not having neither <cite>host</cite> nor <cite>port</cite> defined in the <cite>standby_cluster</cite> config, Patroni was putting the <cite>primary_conninfo</cite> into the <cite>recovery.conf</cite>, which is useless and generating a lot of errors.</p>
</li>
</ul>
</section>
<section id="version-1-5-4">
<h2>Version 1.5.4<a class="headerlink" href="#version-1-5-4" title="Link to this heading"></a></h2>
<p>Released 2019-01-15</p>
<p>This version implements flexible logging and fixes a number of bugs.</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Improvements in logging infrastructure (Alexander Kukushkin, Lucas Capistrant, Alexander Anikin)</p>
<p>Logging configuration could be configured not only from environment variables but also from Patroni config file. It makes it possible to change logging configuration in runtime by updating config and doing reload or sending SIGHUP to the Patroni process. By default Patroni writes logs to stderr, but now it becomes possible to write logs directly into the file and rotate when it reaches a certain size. In addition to that added support of custom dateformat and the possibility to fine-tune log level for each python module.</p>
</li>
<li><p>Make it possible to take into account the current timeline during leader elections (Alexander Kukushkin)</p>
<p>It could happen that the node is considering itself as a healthiest one although it is currently not on the latest known timeline. In some cases we want to avoid promoting of such node, which could be achieved by setting <cite>check_timeline</cite> parameter to <cite>true</cite> (default behavior remains unchanged).</p>
</li>
<li><p>Relaxed requirements on superuser credentials</p>
<p>Libpq allows opening connections without explicitly specifying neither username nor password. Depending on situation it relies either on pgpass file or trust authentication method in pg_hba.conf. Since pg_rewind is also using libpq, it will work the same way.</p>
</li>
<li><p>Implemented possibility to configure Consul Service registration and check interval via environment variables (Alexander Kukushkin)</p>
<p>Registration of service in Consul was added in the 1.5.0, but so far it was only possible to turn it on via patroni.yaml.</p>
</li>
</ul>
<p><strong>Stability Improvements</strong></p>
<ul>
<li><p>Set archive_mode to off during the custom bootstrap (Alexander Kukushkin)</p>
<p>We want to avoid archiving wals and history files until the cluster is fully functional.  It really helps if the custom bootstrap involves pg_upgrade.</p>
</li>
<li><p>Apply five seconds backoff when loading global config on start (Alexander Kukushkin)</p>
<p>It helps to avoid hammering DCS when Patroni just starting up.</p>
</li>
<li><p>Reduce amount of error messages generated on shutdown (Alexander Kukushkin)</p>
<p>They were harmless but rather annoying and sometimes scary.</p>
</li>
<li><p>Explicitly secure rw perms for recovery.conf at creation time (Lucas Capistrant)</p>
<p>We don’t want anybody except patroni/postgres user reading this file, because it contains replication user and password.</p>
</li>
<li><p>Redirect HTTPServer exceptions to logger (Julien Riou)</p>
<p>By default, such exceptions were logged on standard output messing with regular logs.</p>
</li>
</ul>
<p><strong>Bug fixes</strong></p>
<ul>
<li><p>Removed stderr pipe to stdout on pg_ctl process (Cody Coons)</p>
<p>Inheriting stderr from the main Patroni process allows all Postgres logs to be seen along with all patroni logs. This is very useful in a container environment as Patroni and Postgres logs may be consumed using standard tools (docker logs, kubectl, etc). In addition to that, this change fixes a bug with Patroni not being able to catch postmaster pid when postgres writing some warnings into stderr.</p>
</li>
<li><p>Set Consul service check deregister timeout in Go time format (Pavel Kirillov)</p>
<p>Without explicitly mentioned time unit registration was failing.</p>
</li>
<li><p>Relax checks of standby_cluster cluster configuration (Dmitry Dolgov, Alexander Kukushkin)</p>
<p>It was accepting only strings as valid values and therefore it was not possible to specify the port as integer and create_replica_methods as a list.</p>
</li>
</ul>
</section>
<section id="version-1-5-3">
<h2>Version 1.5.3<a class="headerlink" href="#version-1-5-3" title="Link to this heading"></a></h2>
<p>Released 2018-12-03</p>
<p>Compatibility and bugfix release.</p>
<ul>
<li><p>Improve stability when running with python3 against zookeeper (Alexander Kukushkin)</p>
<p>Change of <cite>loop_wait</cite> was causing Patroni to disconnect from zookeeper and never reconnect back.</p>
</li>
<li><p>Fix broken compatibility with postgres 9.3 (Alexander Kukushkin)</p>
<p>When opening a replication connection we should specify replication=1, because 9.3 does not understand replication=’database’</p>
</li>
<li><p>Make sure we refresh Consul session at least once per HA loop and improve handling of consul sessions exceptions (Alexander Kukushkin)</p>
<p>Restart of local consul agent invalidates all sessions related to the node. Not calling session refresh on time and not doing proper handling of session errors was causing demote of the primary.</p>
</li>
</ul>
</section>
<section id="version-1-5-2">
<h2>Version 1.5.2<a class="headerlink" href="#version-1-5-2" title="Link to this heading"></a></h2>
<p>Released 2018-11-26</p>
<p>Compatibility and bugfix release.</p>
<ul>
<li><p>Compatibility with kazoo-2.6.0 (Alexander Kukushkin)</p>
<p>In order to make sure that requests are performed with an appropriate timeout, Patroni redefines create_connection method from python-kazoo module. The last release of kazoo slightly changed the way how create_connection method is called.</p>
</li>
<li><p>Fix Patroni crash when Consul cluster loses the leader (Alexander Kukushkin)</p>
<p>The crash was happening due to incorrect implementation of touch_member method, it should return boolean and not raise any exceptions.</p>
</li>
</ul>
</section>
<section id="version-1-5-1">
<h2>Version 1.5.1<a class="headerlink" href="#version-1-5-1" title="Link to this heading"></a></h2>
<p>Released 2018-11-01</p>
<p>This version implements support of permanent replication slots, adds support of pgBackRest and fixes number of bugs.</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Permanent replication slots (Alexander Kukushkin)</p>
<p>Permanent replication slots are preserved on failover/switchover, that is, Patroni on the new primary will create configured replication slots right after doing promote. Slots could be configured with the help of <cite>patronictl edit-config</cite>. The initial configuration could be also done in the <a class="reference internal" href="yaml_configuration.html#yaml-configuration"><span class="std std-ref">bootstrap.dcs</span></a>.</p>
</li>
<li><p>Add pgbackrest support (Yogesh Sharma)</p>
<p>pgBackrest can restore in existing $PGDATA folder, this allows speedy restore as files which have not changed since last backup are skipped, to support this feature new parameter <cite>keep_data</cite> has been introduced. See <a class="reference internal" href="replica_bootstrap.html#custom-replica-creation"><span class="std std-ref">replica creation method</span></a> section for additional examples.</p>
</li>
</ul>
<p><strong>Bug fixes</strong></p>
<ul>
<li><p>A few bugfixes in the “standby cluster” workflow (Alexander Kukushkin)</p>
<p>Please see <a class="reference external" href="https://github.com/patroni/patroni/pull/823">https://github.com/patroni/patroni/pull/823</a> for more details.</p>
</li>
<li><p>Fix REST API health check when cluster management is paused and DCS is not accessible (Alexander Kukushkin)</p>
<p>Regression was introduced in <a class="reference external" href="https://github.com/patroni/patroni/commit/90cf930036a9d5249265af15d2b787ec7517cf57">https://github.com/patroni/patroni/commit/90cf930036a9d5249265af15d2b787ec7517cf57</a></p>
</li>
</ul>
</section>
<section id="version-1-5-0">
<h2>Version 1.5.0<a class="headerlink" href="#version-1-5-0" title="Link to this heading"></a></h2>
<p>Released 2018-09-20</p>
<p>This version enables Patroni HA cluster to operate in a standby mode, introduces experimental support for running on Windows, and provides a new configuration parameter to register PostgreSQL service in Consul.</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Standby cluster (Dmitry Dolgov)</p>
<p>One or more Patroni nodes can form a standby cluster that runs alongside the primary one (i.e. in another datacenter) and consists of standby nodes that replicate from the master in the primary cluster. All PostgreSQL nodes in the standby cluster are replicas; one of those replicas elects itself to replicate directly from the remote master, while the others replicate from it in a cascading manner. More detailed description of this feature and some configuration examples can be found at <a class="reference internal" href="standby_cluster.html#standby-cluster"><span class="std std-ref">here</span></a>.</p>
</li>
<li><p>Register Services in Consul (Pavel Kirillov, Alexander Kukushkin)</p>
<p>If <cite>register_service</cite> parameter in the consul <a class="reference internal" href="yaml_configuration.html#consul-settings"><span class="std std-ref">configuration</span></a> is enabled, the node will register a service with the name <cite>scope</cite> and the tag <cite>master</cite>, <cite>replica</cite> or <cite>standby-leader</cite>.</p>
</li>
<li><p>Experimental Windows support (Pavel Golub)</p>
<p>From now on it is possible to run Patroni on Windows, although Windows support is brand-new and hasn’t received as much real-world testing as its Linux counterpart. We welcome your feedback!</p>
</li>
</ul>
<p><strong>Improvements in patronictl</strong></p>
<ul>
<li><p>Add patronictl -k/–insecure flag and support for restapi cert (Wilfried Roset)</p>
<p>In the past if the REST API was protected by the self-signed certificates <cite>patronictl</cite> would fail to verify them. There was no way to  disable that verification. It is now possible to configure <cite>patronictl</cite> to skip the certificate verification altogether or provide CA and client certificates in the <a class="reference internal" href="yaml_configuration.html#patronictl-settings"><span class="std std-ref">ctl:</span></a> section of configuration.</p>
</li>
<li><p>Exclude members with nofailover tag from patronictl switchover/failover output (Alexander Anikin)</p>
<p>Previously, those members were incorrectly proposed as candidates when performing interactive switchover or failover via patronictl.</p>
</li>
</ul>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Avoid parsing non-key-value output lines of pg_controldata (Alexander Anikin)</p>
<p>Under certain circuimstances pg_controldata outputs lines without a colon character. That would trigger an error in Patroni code that parsed pg_controldata output, hiding the actual problem; often such lines are emitted in a warning shown by pg_controldata before the regular output, i.e. when the binary major version does not match the one of the PostgreSQL data directory.</p>
</li>
<li><p>Add member name to the error message during the leader election (Jan Mussler)</p>
<p>During the leader election, Patroni connects to all known members of the cluster and requests their status. Such status is written to the Patroni log and includes the name of the member. Previously, if the member was not accessible, the error message did not indicate its name, containing only the URL.</p>
</li>
<li><p>Immediately reserve the WAL position upon creation of the replication slot (Alexander Kukushkin)</p>
<p>Starting from 9.6, <cite>pg_create_physical_replication_slot</cite> function provides an additional boolean parameter <cite>immediately_reserve</cite>. When it is set to <cite>false</cite>, which is also the default, the slot doesn’t reserve the WAL position until it receives the first client connection, potentially losing some segments required by the client in a time window between the slot creation and the initial client connection.</p>
</li>
<li><p>Fix bug in strict synchronous replication (Alexander Kukushkin)</p>
<p>When running with <cite>synchronous_mode_strict: true</cite>, in some cases Patroni puts <cite>*</cite> into the <cite>synchronous_standby_names</cite>, changing the sync state for most of the replication connections to <cite>potential</cite>. Previously, Patroni couldn’t pick a synchronous candidate under such curcuimstances, as it only considered those with the state <cite>async</cite>.</p>
</li>
</ul>
</section>
<section id="version-1-4-6">
<h2>Version 1.4.6<a class="headerlink" href="#version-1-4-6" title="Link to this heading"></a></h2>
<p>Released 2018-08-14</p>
<p><strong>Bug fixes and stability improvements</strong></p>
<p>This release fixes a critical issue with Patroni API /master endpoint returning 200 for the non-master node. This is a
reporting issue, no actual split-brain, but under certain circumstances clients might be directed to the read-only node.</p>
<ul>
<li><p>Reset is_leader status on demote (Alexander Kukushkin, Oleksii Kliukin)</p>
<p>Make sure demoted cluster member stops responding with code 200 on the /master API call.</p>
</li>
<li><p>Add new “cluster_unlocked” field to the API output (Dmitry Dolgov)</p>
<p>This field indicates whether the cluster has the master running. It can be used when it is not possible to query any
other node but one of the replicas.</p>
</li>
</ul>
</section>
<section id="version-1-4-5">
<h2>Version 1.4.5<a class="headerlink" href="#version-1-4-5" title="Link to this heading"></a></h2>
<p>Released 2018-08-03</p>
<p><strong>New features</strong></p>
<ul>
<li><p>Improve logging when applying new postgres configuration (Don Seiler)</p>
<p>Patroni logs changed parameter names and values.</p>
</li>
<li><p>Python 3.7 compatibility (Christoph Berg)</p>
<p>async is a reserved keyword in python3.7</p>
</li>
<li><p>Set state to “stopped” in the DCS when a member is shut down (Tony Sorrentino)</p>
<p>This shows the member state as “stopped” in “patronictl list” command.</p>
</li>
<li><p>Improve the message logged when stale postmaster.pid matches a running process (Ants Aasma)</p>
<p>The previous one was beyond confusing.</p>
</li>
<li><p>Implement patronictl reload functionality (Don Seiler)</p>
<p>Before that it was only possible to reload configuration by either calling REST API or by sending SIGHUP signal to the Patroni process.</p>
</li>
<li><p>Take and apply some parameters from controldata when starting as a replica (Alexander Kukushkin)</p>
<p>The value of <cite>max_connections</cite> and some other parameters set in the global configuration may be lower than the one actually used by the primary; when this happens, the replica cannot start and should be fixed manually. Patroni takes care of that now by reading and applying the value from  <cite>pg_controldata</cite>, starting postgres and setting <cite>pending_restart</cite> flag.</p>
</li>
<li><p>If set, use LD_LIBRARY_PATH when starting postgres (Chris Fraser)</p>
<p>When starting up Postgres, Patroni was passing along PATH, LC_ALL and LANG env vars if they are set. Now it is doing the same with LD_LIBRARY_PATH. It should help if somebody installed PostgreSQL to non-standard place.</p>
</li>
<li><p>Rename create_replica_method to create_replica_methods (Dmitry Dolgov)</p>
<p>To make it clear that it’s actually an array. The old name is still supported for backward compatibility.</p>
</li>
</ul>
<p><strong>Bug fixes and stability improvements</strong></p>
<ul>
<li><p>Fix condition for the replica start due to pg_rewind in paused state (Oleksii Kliukin)</p>
<p>Avoid starting the replica that had already executed pg_rewind before.</p>
</li>
<li><p>Respond 200 to the master health-check only if update_lock has been successful (Alexander Kukushkin)</p>
<p>Prevent Patroni from reporting itself a master on the former (demoted) master if DCS is partitioned.</p>
</li>
<li><p>Fix compatibility with the new consul module (Alexander Kukushkin)</p>
<p>Starting from v1.1.0 python-consul changed internal API and started using <cite>list</cite> instead of <cite>dict</cite> to pass query parameters.</p>
</li>
<li><p>Catch exceptions from Patroni REST API thread during shutdown (Alexander Kukushkin)</p>
<p>Those uncaught exceptions kept PostgreSQL running at shutdown.</p>
</li>
<li><p>Do crash recovery only when Postgres runs as the master (Alexander Kukushkin)</p>
<p>Require <cite>pg_controldata</cite> to report  ‘in production’ or ‘shutting down’ or ‘in crash recovery’. In all other cases no crash recovery is necessary.</p>
</li>
<li><p>Improve handling of configuration errors (Henning Jacobs, Alexander Kukushkin)</p>
<p>It is possible to change a lot of parameters in runtime (including <cite>restapi.listen</cite>) by updating Patroni config file and sending SIGHUP to Patroni process. This fix eliminates obscure exceptions from the ‘restapi’ thread when some of the parameters receive invalid values.</p>
</li>
</ul>
</section>
<section id="version-1-4-4">
<h2>Version 1.4.4<a class="headerlink" href="#version-1-4-4" title="Link to this heading"></a></h2>
<p>Released 2018-05-22</p>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Fix race condition in poll_failover_result (Alexander Kukushkin)</p>
<p>It didn’t affect directly neither failover nor switchover, but in some rare cases it was reporting success too early, when the former leader released the lock, producing a ‘Failed over to “None”’ instead of ‘Failed over to “desired-node”’ message.</p>
</li>
<li><p>Treat Postgres parameter names as case insensitive (Alexander Kukushkin)</p>
<p>Most of the Postgres parameters have snake_case names, but there are three exceptions from this rule: DateStyle, IntervalStyle and TimeZone. Postgres accepts those parameters when written in a different case (e.g. timezone = ‘some/tzn’); however, Patroni was unable to find case-insensitive matches of those parameter names in pg_settings and ignored such parameters as a result.</p>
</li>
<li><p>Abort start if attaching to running postgres and cluster not initialized (Alexander Kukushkin)</p>
<p>Patroni can attach itself to an already running Postgres instance. It is imperative to start running Patroni on the master node before getting to the replicas.</p>
</li>
<li><p>Fix behavior of patronictl scaffold (Alexander Kukushkin)</p>
<p>Pass dict object to touch_member instead of json encoded string, DCS implementation will take care of encoding it.</p>
</li>
<li><p>Don’t demote master if failed to update leader key in pause (Alexander Kukushkin)</p>
<p>During maintenance a DCS may start failing write requests while continuing to responds to read ones. In that case, Patroni used to put the Postgres master node to a read-only mode after failing to update the leader lock in DCS.</p>
</li>
<li><p>Sync replication slots when Patroni notices a new postmaster process (Alexander Kukushkin)</p>
<p>If Postgres has been restarted, Patroni has to make sure that list of replication slots matches its expectations.</p>
</li>
<li><p>Verify sysid and sync replication slots after coming out of pause (Alexander Kukushkin)</p>
<p>During the <cite>maintenance</cite> mode it may happen that data directory was completely rewritten and therefore we have to make sure that <cite>Database system identifier</cite> still belongs to our cluster and replication slots are in sync with Patroni expectations.</p>
</li>
<li><p>Fix a possible failure to start not running Postgres on a data directory with postmaster lock file present (Alexander Kukushkin)</p>
<p>Detect reuse of PID from the postmaster lock file. More likely to hit such problem if you run Patroni and Postgres in the docker container.</p>
</li>
<li><p>Improve protection of DCS being accidentally wiped (Alexander Kukushkin)</p>
<p>Patroni has a lot of logic in place to prevent failover in such case; it can also restore all keys back; however, until this change an accidental removal of /config key was switching off pause mode for 1 cycle of HA loop.</p>
</li>
<li><p>Do not exit when encountering invalid system ID (Oleksii Kliukin)</p>
<p>Do not exit when the cluster system ID is empty or the one that doesn’t pass the validation check. In that case, the cluster most likely needs a reinit; mention it in the result message. Avoid terminating Patroni, as otherwise reinit cannot happen.</p>
</li>
</ul>
<p><strong>Compatibility with Kubernetes 1.10+</strong></p>
<ul>
<li><p>Added check for empty subsets (Cody Coons)</p>
<p>Kubernetes 1.10.0+ started returning <cite>Endpoints.subsets</cite> set to <cite>None</cite> instead of <cite>[]</cite>.</p>
</li>
</ul>
<p><strong>Bootstrap improvements</strong></p>
<ul>
<li><p>Make deleting recovery.conf optional (Brad Nicholson)</p>
<p>If <cite>bootstrap.&lt;custom_bootstrap_method_name&gt;.keep_existing_recovery_conf</cite> is defined and set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, Patroni will not remove the existing <code class="docutils literal notranslate"><span class="pre">recovery.conf</span></code> file. This is useful when bootstrapping from a backup with tools like pgBackRest that generate the appropriate <cite>recovery.conf</cite> for you.</p>
</li>
<li><p>Allow options to the basebackup built-in method (Oleksii Kliukin)</p>
<p>It is now possible to supply options to the built-in basebackup method by defining the <cite>basebackup</cite> section in the configuration, similar to how those are defined for custom replica creation methods. The difference is in the format accepted by the <cite>basebackup</cite> section: since pg_basebackup accepts both <cite>–key=value</cite> and <cite>–key</cite> options, the contents of the section could be either a dictionary of key-value pairs, or a list of either one-element dictionaries or just keys (for the options that don’t accept values). See <a class="reference internal" href="replica_bootstrap.html#custom-replica-creation"><span class="std std-ref">replica creation method</span></a> section for additional examples.</p>
</li>
</ul>
</section>
<section id="version-1-4-3">
<h2>Version 1.4.3<a class="headerlink" href="#version-1-4-3" title="Link to this heading"></a></h2>
<p>Released 2018-03-05</p>
<p><strong>Improvements in logging</strong></p>
<ul>
<li><p>Make log level configurable from environment variables (Andy Newton, Keyvan Hedayati)</p>
<p><cite>PATRONI_LOGLEVEL</cite> - sets the general logging level
<cite>PATRONI_REQUESTS_LOGLEVEL</cite> - sets the logging level for all HTTP requests e.g. Kubernetes API calls
See <cite>the docs for Python logging &lt;https://docs.python.org/3.6/library/logging.html#levels&gt;</cite> to get the names of possible log levels</p>
</li>
</ul>
<p><strong>Stability improvements and bug fixes</strong></p>
<ul>
<li><p>Don’t rediscover etcd cluster topology when watch timed out (Alexander Kukushkin)</p>
<p>If we have only one host in etcd configuration and exactly this host is not accessible, Patroni was starting discovery of cluster topology and never succeeding. Instead it should just switch to the next available node.</p>
</li>
<li><p>Write content of bootstrap.pg_hba into a pg_hba.conf after custom bootstrap (Alexander Kukushkin)</p>
<p>Now it behaves similarly to the usual bootstrap with <cite>initdb</cite></p>
</li>
<li><p>Single user mode was waiting for user input and never finish (Alexander Kukushkin)</p>
<p>Regression was introduced in <a class="reference external" href="https://github.com/patroni/patroni/pull/576">https://github.com/patroni/patroni/pull/576</a></p>
</li>
</ul>
</section>
<section id="version-1-4-2">
<h2>Version 1.4.2<a class="headerlink" href="#version-1-4-2" title="Link to this heading"></a></h2>
<p>Released 2018-01-30</p>
<p><strong>Improvements in patronictl</strong></p>
<ul>
<li><p>Rename scheduled failover to scheduled switchover (Alexander Kukushkin)</p>
<p>Failover and switchover functions were separated in version 1.4, but <cite>patronictl list</cite> was still reporting <cite>Scheduled failover</cite> instead of <cite>Scheduled switchover</cite>.</p>
</li>
<li><p>Show information about pending restarts (Alexander Kukushkin)</p>
<p>In order to apply some configuration changes sometimes it is necessary to restart postgres. Patroni was already giving a hint about that in the REST API and when writing node status into DCS, but there were no easy way to display it.</p>
</li>
<li><p>Make show-config to work with cluster_name from config file (Alexander Kukushkin)</p>
<p>It works similar to the <cite>patronictl edit-config</cite></p>
</li>
</ul>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Avoid calling pg_controldata during bootstrap (Alexander Kukushkin)</p>
<p>During initdb or custom bootstrap there is a time window when pgdata is not empty but pg_controldata has not been written yet. In such case pg_controldata call was failing with error messages.</p>
</li>
<li><p>Handle exceptions raised from psutil (Alexander Kukushkin)</p>
<p>cmdline is read and parsed every time when <cite>cmdline()</cite> method is called. It could happen that the process being examined
has already disappeared, in that case <cite>NoSuchProcess</cite> is raised.</p>
</li>
</ul>
<p><strong>Kubernetes support improvements</strong></p>
<ul>
<li><p>Don’t swallow errors from k8s API (Alexander Kukushkin)</p>
<p>A call to Kubernetes API could fail for a different number of reasons. In some cases such call should be retried, in some other cases we should log the error message and the exception stack trace. The change here will help debug Kubernetes permission issues.</p>
</li>
<li><p>Update Kubernetes example Dockerfile to install Patroni from the master branch (Maciej Szulik)</p>
<p>Before that it was using <cite>feature/k8s</cite>, which became outdated.</p>
</li>
<li><p>Add proper RBAC to run patroni on k8s (Maciej Szulik)</p>
<p>Add the Service account that is assigned to the pods of the cluster, the role that holds only the necessary permissions, and the rolebinding that connects the Service account and the Role.</p>
</li>
</ul>
</section>
<section id="version-1-4-1">
<h2>Version 1.4.1<a class="headerlink" href="#version-1-4-1" title="Link to this heading"></a></h2>
<p>Released 2018-01-17</p>
<p><strong>Fixes in patronictl</strong></p>
<ul>
<li><p>Don’t show current leader in suggested list of members to failover to. (Alexander Kukushkin)</p>
<p>patronictl failover could still work when there is leader in the cluster and it should be excluded from the list of member where it is possible to failover to.</p>
</li>
<li><p>Make patronictl switchover compatible with the old Patroni api (Alexander Kukushkin)</p>
<p>In case if POST /switchover REST API call has failed with status code 501 it will do it once again, but to /failover endpoint.</p>
</li>
</ul>
</section>
<section id="version-1-4">
<h2>Version 1.4<a class="headerlink" href="#version-1-4" title="Link to this heading"></a></h2>
<p>Released 2018-01-10</p>
<p>This version adds support for using Kubernetes as a DCS, allowing to run Patroni as a cloud-native agent in Kubernetes without any additional deployments of Etcd, Zookeeper or Consul.</p>
<p><strong>Upgrade notice</strong></p>
<p>Installing Patroni via pip will no longer bring in dependencies for (such as libraries for Etcd, Zookeper, Consul or Kubernetes, or support for AWS). In order to enable them one need to list them in pip install command explicitly, for instance <cite>pip install patroni[etcd,kubernetes]</cite>.</p>
<p><strong>Kubernetes support</strong></p>
<p>Implement Kubernetes-based DCS. The endpoints meta-data is used in order to store the configuration and the leader key. The meta-data field inside the pods definition is used to store the member-related data.
In addition to using Endpoints, Patroni supports ConfigMaps. You can find more information about this feature in the <a class="reference internal" href="kubernetes.html#kubernetes"><span class="std std-ref">Kubernetes chapter of the documentation</span></a></p>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Factor out postmaster process into a separate object (Ants Aasma)</p>
<p>This object identifies a running postmaster process via pid and start time and simplifies detection (and resolution) of situations when the postmaster was restarted behind our back or when postgres directory disappeared from the file system.</p>
</li>
<li><p>Minimize the amount of SELECT’s issued by Patroni on every loop of HA cycle (Alexander Kukushkin)</p>
<p>On every iteration of HA loop Patroni needs to know recovery status and absolute wal position. From now on Patroni will run only single SELECT to get this information instead of two on the replica and three on the master.</p>
</li>
<li><p>Remove leader key on shutdown only when we have the lock (Ants Aasma)</p>
<p>Unconditional removal was generating unnecessary and misleading exceptions.</p>
</li>
</ul>
<p><strong>Improvements in patronictl</strong></p>
<ul>
<li><p>Add version command to patronictl (Ants Aasma)</p>
<p>It will show the version of installed Patroni and versions of running Patroni instances (if the cluster name is specified).</p>
</li>
<li><p>Make optional specifying cluster_name argument for some of patronictl commands (Alexander Kukushkin, Ants Aasma)</p>
<p>It will work if patronictl is using usual Patroni configuration file with the <code class="docutils literal notranslate"><span class="pre">scope</span></code> defined.</p>
</li>
<li><p>Show information about scheduled switchover and maintenance mode (Alexander Kukushkin)</p>
<p>Before that it was possible to get this information only from Patroni logs or directly from DCS.</p>
</li>
<li><p>Improve <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">reinit</span></code> (Alexander Kukushkin)</p>
<p>Sometimes <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">reinit</span></code> refused to proceed when Patroni was busy with other actions, namely trying to start postgres. <cite>patronictl</cite> didn’t provide any commands to cancel such long running actions and the only (dangerous) workarond was removing a data directory manually. The new implementation of <cite>reinit</cite> forcefully cancels other long-running actions before proceeding with reinit.</p>
</li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">--wait</span></code> flag in <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">pause</span></code> and <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">resume</span></code> (Alexander Kukushkin)</p>
<p>It will make <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> wait until the requested action is acknowledged by all nodes in the cluster.
Such behaviour is achieved by exposing the <code class="docutils literal notranslate"><span class="pre">pause</span></code> flag for every node in DCS and via the REST API.</p>
</li>
<li><p>Rename <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">failover</span></code> into <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">switchover</span></code> (Alexander Kukushkin)</p>
<p>The previous <code class="docutils literal notranslate"><span class="pre">failover</span></code> was actually only capable of doing a switchover; it refused to proceed in a cluster without the leader.</p>
</li>
<li><p>Alter the behavior of <code class="docutils literal notranslate"><span class="pre">patronictl</span> <span class="pre">failover</span></code> (Alexander Kukushkin)</p>
<p>It will work even if there is no leader, but in that case you will have to explicitly specify a node which should become the new leader.</p>
</li>
</ul>
<p><strong>Expose information about timeline and history</strong></p>
<ul>
<li><p>Expose current timeline in DCS and via API (Alexander Kukushkin)</p>
<p>Store information about the current timeline for each member of the cluster. This information is accessible via the API and is stored in the DCS</p>
</li>
<li><p>Store promotion history in the /history key in DCS (Alexander Kukushkin)</p>
<p>In addition, store the timeline history enriched with the timestamp of the corresponding promotion in the /history key in DCS and update it with each promote.</p>
</li>
</ul>
<p><strong>Add endpoints for getting synchronous and asynchronous replicas</strong></p>
<ul class="simple">
<li><p>Add new /sync and /async endpoints (Alexander Kukushkin, Oleksii Kliukin)</p></li>
</ul>
<blockquote>
<div><p>Those endpoints (also accessible as /synchronous and /asynchronous) return 200 only for synchronous and asynchronous replicas correspondingly (excluding those marked as <cite>noloadbalance</cite>).</p>
</div></blockquote>
<p><strong>Allow multiple hosts for Etcd</strong></p>
<ul>
<li><p>Add a new <cite>hosts</cite> parameter to Etcd configuration (Alexander Kukushkin)</p>
<p>This parameter should contain the initial list of hosts that will be used to discover and populate the list of the running etcd cluster members. If for some reason during work this list of discovered hosts is exhausted (no available hosts from that list), Patroni will return to the initial list from the <cite>hosts</cite> parameter.</p>
</li>
</ul>
</section>
<section id="version-1-3-6">
<h2>Version 1.3.6<a class="headerlink" href="#version-1-3-6" title="Link to this heading"></a></h2>
<p>Released 2017-11-10</p>
<p><strong>Stability improvements</strong></p>
<ul>
<li><p>Verify process start time when checking if postgres is running. (Ants Aasma)</p>
<p>After a crash that doesn’t clean up postmaster.pid there could be a new process with the same pid, resulting in a false positive for is_running(), which will lead to all kinds of bad behavior.</p>
</li>
<li><p>Shutdown postgresql before bootstrap when we lost data directory (ainlolcat)</p>
<p>When data directory on the master is forcefully removed, postgres process can still stay alive for some time and prevent the replica created in place of that former master from starting or replicating.
The fix makes Patroni cache the postmaster pid and its start time and let it terminate the old postmaster in case it is still running after the corresponding data directory has been removed.</p>
</li>
<li><p>Perform crash recovery in a single user mode if postgres master dies (Alexander Kukushkin)</p>
<p>It is unsafe to start immediately as a standby and not possible to run <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> if postgres hasn’t been shut down cleanly.
The single user crash recovery only kicks in if <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> is enabled or there is no master at the moment.</p>
</li>
</ul>
<p><strong>Consul improvements</strong></p>
<ul>
<li><p>Make it possible to provide datacenter configuration for Consul (Vilius Okockis, Alexander Kukushkin)</p>
<p>Before that Patroni was always communicating with datacenter of the host it runs on.</p>
</li>
<li><p>Always send a token in X-Consul-Token http header (Alexander Kukushkin)</p>
<p>If <code class="docutils literal notranslate"><span class="pre">consul.token</span></code> is defined in Patroni configuration, we will always send it in the ‘X-Consul-Token’ http header.
python-consul module tries to be “consistent” with Consul REST API, which doesn’t accept token as a query parameter for <a class="reference external" href="https://www.consul.io/api/session.html">session API</a>, but it still works with ‘X-Consul-Token’ header.</p>
</li>
<li><p>Adjust session TTL if supplied value is smaller than the minimum possible (Stas Fomin, Alexander Kukushkin)</p>
<p>It could happen that the TTL provided in the Patroni configuration is smaller than the minimum one supported by Consul. In that case, Consul agent fails to create a new session.
Without a session Patroni cannot create member and leader keys in the Consul KV store, resulting in an unhealthy cluster.</p>
</li>
</ul>
<p><strong>Other improvements</strong></p>
<ul>
<li><p>Define custom log format via environment variable <code class="docutils literal notranslate"><span class="pre">PATRONI_LOGFORMAT</span></code> (Stas Fomin)</p>
<p>Allow disabling timestamps and other similar fields in Patroni logs if they are already added by the system logger (usually when Patroni runs as a service).</p>
</li>
</ul>
</section>
<section id="version-1-3-5">
<h2>Version 1.3.5<a class="headerlink" href="#version-1-3-5" title="Link to this heading"></a></h2>
<p>Released 2017-10-12</p>
<p><strong>Bugfix</strong></p>
<ul>
<li><p>Set role to ‘uninitialized’ if data directory was removed (Alexander Kukushkin)</p>
<p>If the node was running as a master it was preventing from failover.</p>
</li>
</ul>
<p><strong>Stability improvement</strong></p>
<ul>
<li><p>Try to run postmaster in a single-user mode if we tried and failed to start postgres (Alexander Kukushkin)</p>
<p>Usually such problem happens when node running as a master was terminated and timelines were diverged.
If <code class="docutils literal notranslate"><span class="pre">recovery.conf</span></code> has <code class="docutils literal notranslate"><span class="pre">restore_command</span></code> defined, there are really high chances that postgres will abort startup and leave controldata unchanged.
It makes impossible to use <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code>, which requires a clean shutdown.</p>
</li>
</ul>
<p><strong>Consul improvements</strong></p>
<ul>
<li><p>Make it possible to specify health checks when creating session (Alexander Kukushkin)</p>
<p>If not specified, Consul will use “serfHealth”. From one side it allows fast detection of isolated master, but from another side it makes it impossible for Patroni to tolerate short network lags.</p>
</li>
</ul>
<p><strong>Bugfix</strong></p>
<ul>
<li><p>Fix watchdog on Python 3 (Ants Aasma)</p>
<p>A misunderstanding of the ioctl() call interface. If mutable=False then fcntl.ioctl() actually returns the arg buffer back.
This accidentally worked on Python2 because int and str comparison did not return an error.
Error reporting is actually done by raising IOError on Python2 and OSError on Python3.</p>
</li>
</ul>
</section>
<section id="version-1-3-4">
<h2>Version 1.3.4<a class="headerlink" href="#version-1-3-4" title="Link to this heading"></a></h2>
<p>Released 2017-09-08</p>
<p><strong>Different Consul improvements</strong></p>
<ul>
<li><p>Pass the consul token as a header (Andrew Colin Kissa)</p>
<p>Headers are now the preferred way to pass the token to the consul <a class="reference external" href="https://www.consul.io/api/index.html#authentication">API</a>.</p>
</li>
<li><p>Advanced configuration for Consul (Alexander Kukushkin)</p>
<p>possibility to specify <code class="docutils literal notranslate"><span class="pre">scheme</span></code>, <code class="docutils literal notranslate"><span class="pre">token</span></code>, client and ca certificates <a class="reference internal" href="yaml_configuration.html#consul-settings"><span class="std std-ref">details</span></a>.</p>
</li>
<li><p>compatibility with python-consul-0.7.1 and above (Alexander Kukushkin)</p>
<p>new python-consul module has changed signature of some methods</p>
</li>
<li><p>“Could not take out TTL lock” message was never logged (Alexander Kukushkin)</p>
<p>Not a critical bug, but lack of proper logging complicates investigation in case of problems.</p>
</li>
</ul>
<p><strong>Quote synchronous_standby_names using quote_ident</strong></p>
<ul>
<li><p>When writing <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code> into the <code class="docutils literal notranslate"><span class="pre">postgresql.conf</span></code> its value must be quoted (Alexander Kukushkin)</p>
<p>If it is not quoted properly, PostgreSQL will effectively disable synchronous replication and continue to work.</p>
</li>
</ul>
<p><strong>Different bugfixes around pause state, mostly related to watchdog</strong> (Alexander Kukushkin)</p>
<ul class="simple">
<li><p>Do not send keepalives if watchdog is not active</p></li>
<li><p>Avoid activating watchdog in a pause mode</p></li>
<li><p>Set correct postgres state in pause mode</p></li>
<li><p>Do not try to run queries from API if postgres is stopped</p></li>
</ul>
</section>
<section id="version-1-3-3">
<h2>Version 1.3.3<a class="headerlink" href="#version-1-3-3" title="Link to this heading"></a></h2>
<p>Released 2017-08-04</p>
<p><strong>Bugfixes</strong></p>
<ul class="simple">
<li><p>synchronous replication was disabled shortly after promotion even when synchronous_mode_strict was turned on (Alexander Kukushkin)</p></li>
<li><p>create empty <code class="docutils literal notranslate"><span class="pre">pg_ident.conf</span></code> file if it is missing after restoring from the backup (Alexander Kukushkin)</p></li>
<li><p>open access in <code class="docutils literal notranslate"><span class="pre">pg_hba.conf</span></code> to all databases, not only postgres (Franco Bellagamba)</p></li>
</ul>
</section>
<section id="version-1-3-2">
<h2>Version 1.3.2<a class="headerlink" href="#version-1-3-2" title="Link to this heading"></a></h2>
<p>Released 2017-07-31</p>
<p><strong>Bugfix</strong></p>
<ul class="simple">
<li><p>patronictl edit-config didn’t work with ZooKeeper (Alexander Kukushkin)</p></li>
</ul>
</section>
<section id="version-1-3-1">
<h2>Version 1.3.1<a class="headerlink" href="#version-1-3-1" title="Link to this heading"></a></h2>
<p>Released 2017-07-28</p>
<p><strong>Bugfix</strong></p>
<ul class="simple">
<li><p>failover via API was broken due to change in <code class="docutils literal notranslate"><span class="pre">_MemberStatus</span></code> (Alexander Kukushkin)</p></li>
</ul>
</section>
<section id="version-1-3">
<h2>Version 1.3<a class="headerlink" href="#version-1-3" title="Link to this heading"></a></h2>
<p>Released 2017-07-27</p>
<p>Version 1.3 adds custom bootstrap possibility, significantly improves support for pg_rewind, enhances the
synchronous mode support, adds configuration editing to patronictl and implements watchdog support on Linux.
In addition, this is the first version to work correctly with PostgreSQL 10.</p>
<p><strong>Upgrade notice</strong></p>
<p>There are no known compatibility issues with the new version of Patroni. Configuration from version 1.2 should work
without any changes. It is possible to upgrade by installing new packages and either  restarting Patroni (will cause
PostgreSQL restart), or by putting Patroni into a <a class="reference internal" href="pause.html#pause"><span class="std std-ref">pause mode</span></a> first and then restarting Patroni on all
nodes in the cluster (Patroni in a pause mode will not attempt to stop/start PostgreSQL), resuming from the pause mode
at the end.</p>
<p><strong>Custom bootstrap</strong></p>
<ul>
<li><p>Make the process of bootstrapping the cluster configurable (Alexander Kukushkin)</p>
<p>Allow custom bootstrap scripts instead of <code class="docutils literal notranslate"><span class="pre">initdb</span></code> when initializing the very first node in the cluster.
The bootstrap command receives the name of the cluster and the path to the data directory. The resulting cluster can
be configured to perform recovery, making it possible to bootstrap from a backup and do point in time recovery. Refer
to the <a class="reference internal" href="replica_bootstrap.html#custom-bootstrap"><span class="std std-ref">documentation page</span></a> for more detailed description of this feature.</p>
</li>
</ul>
<p><strong>Smarter pg_rewind support</strong></p>
<ul>
<li><p>Decide on whether to run pg_rewind by looking at the timeline differences from the current master (Alexander Kukushkin)</p>
<p>Previously, Patroni had a fixed set of conditions to trigger pg_rewind, namely when starting a former master, when
doing a switchover to the designated node for every other node in the cluster or when there is a replica with the
nofailover tag. All those cases have in common a chance that some replica may be ahead of the new master. In some cases,
pg_rewind did nothing, in some other ones it was not running when necessary. Instead of relying on this limited list
of rules make Patroni compare the master and the replica WAL positions (using the streaming replication protocol)
in order to reliably decide if rewind is necessary for the replica.</p>
</li>
</ul>
<p><strong>Synchronous replication mode strict</strong></p>
<ul>
<li><p>Enhance synchronous replication support by adding the strict mode (James Sewell, Alexander Kukushkin)</p>
<p>Normally, when <code class="docutils literal notranslate"><span class="pre">synchronous_mode</span></code> is enabled and there are no replicas attached to the master, Patroni will disable
synchronous replication in order to keep the master available for writes. The <code class="docutils literal notranslate"><span class="pre">synchronous_mode_strict</span></code> option
changes that, when it is set Patroni will not disable the synchronous replication in a lack of replicas, effectively
blocking all clients writing data to the master. In addition to the synchronous mode guarantee of preventing any data
loss due to automatic failover, the strict mode ensures that each write is either durably stored on two nodes or not
happening altogether if there is only one node in the cluster.</p>
</li>
</ul>
<p><strong>Configuration editing with patronictl</strong></p>
<ul>
<li><p>Add configuration editing to patronictl (Ants Aasma, Alexander Kukushkin)</p>
<p>Add the ability to patronictl of editing dynamic cluster configuration stored in DCS. Support either specifying the
parameter/values from the command-line, invoking the $EDITOR, or applying configuration from the yaml file.</p>
</li>
</ul>
<p><strong>Linux watchdog support</strong></p>
<ul>
<li><p>Implement watchdog support for Linux (Ants Aasma)</p>
<p>Support Linux software watchdog in order to reboot the node where Patroni is not running or not responding (e.g because
of the high load) The Linux software watchdog reboots the non-responsive node. It is possible to configure the watchdog
device to use (<cite>/dev/watchdog</cite> by default) and the mode (on, automatic, off) from the watchdog section of the Patroni
configuration. You can get more information from the <a class="reference internal" href="watchdog.html#watchdog"><span class="std std-ref">watchdog documentation</span></a>.</p>
</li>
</ul>
<p><strong>Add support for PostgreSQL 10</strong></p>
<ul class="simple">
<li><p>Patroni is compatible with all beta versions of PostgreSQL 10 released so far and we expect it to be compatible with
the PostgreSQL 10 when it will be released.</p></li>
</ul>
<p><strong>PostgreSQL-related minor improvements</strong></p>
<ul>
<li><p>Define pg_hba.conf via the Patroni configuration file or the dynamic configuration in DCS (Alexander Kukushkin)</p>
<p>Allow to define the contents of <code class="docutils literal notranslate"><span class="pre">pg_hba.conf</span></code> in the <code class="docutils literal notranslate"><span class="pre">pg_hba</span></code> sub-section of the <code class="docutils literal notranslate"><span class="pre">postgresql</span></code> section of the
configuration. This simplifies managing <code class="docutils literal notranslate"><span class="pre">pg_hba.conf</span></code> on multiple nodes, as one needs to define it only ones in DCS
instead of logging to every node, changing it manually and reload the configuration.</p>
<p>When defined, the contents of this section will replace the current <code class="docutils literal notranslate"><span class="pre">pg_hba.conf</span></code> completely. Patroni ignores it
if <code class="docutils literal notranslate"><span class="pre">hba_file</span></code> PostgreSQL parameter is set.</p>
</li>
<li><p>Support connecting via a UNIX socket to the local PostgreSQL cluster (Alexander Kukushkin)</p>
<p>Add the <code class="docutils literal notranslate"><span class="pre">use_unix_socket</span></code> option to the <code class="docutils literal notranslate"><span class="pre">postgresql</span></code> section of Patroni configuration. When set to true and the
PostgreSQL <code class="docutils literal notranslate"><span class="pre">unix_socket_directories</span></code> option is not empty, enables Patroni to use the first value from it to connect
to the local PostgreSQL cluster. If <code class="docutils literal notranslate"><span class="pre">unix_socket_directories</span></code> is not defined, Patroni will assume its default value
and omit the <code class="docutils literal notranslate"><span class="pre">host</span></code> parameter in the PostgreSQL connection string altogether.</p>
</li>
<li><p>Support change of superuser and replication credentials on reload (Alexander Kukushkin)</p></li>
<li><p>Support storing of configuration files outside of PostgreSQL data directory (&#64;jouir)</p>
<p>Add the new configuration <code class="docutils literal notranslate"><span class="pre">postgresql</span></code> configuration directive <code class="docutils literal notranslate"><span class="pre">config_dir</span></code>.
It defaults to the data directory and must be writable by Patroni.</p>
</li>
</ul>
<p><strong>Bug fixes and stability improvements</strong></p>
<ul>
<li><p>Handle EtcdEventIndexCleared and EtcdWatcherCleared exceptions (Alexander Kukushkin)</p>
<p>Faster recovery when the watch operation is ended by Etcd by avoiding useless retries.</p>
</li>
<li><p>Remove error spinning on Etcd failure and reduce log spam (Ants Aasma)</p>
<p>Avoid immediate retrying and emitting stack traces in the log on the second and subsequent Etcd connection failures.</p>
</li>
<li><p>Export locale variables when forking PostgreSQL processes (Oleksii Kliukin)</p>
<p>Avoid the <cite>postmaster became multithreaded during startup</cite> fatal error on non-English locales for PostgreSQL built with NLS.</p>
</li>
<li><p>Extra checks when dropping the replication slot (Alexander Kukushkin)</p>
<p>In some cases Patroni is prevented from dropping the replication slot by the WAL sender.</p>
</li>
<li><p>Truncate the replication slot name to 63  (NAMEDATALEN - 1) characters to comply with PostgreSQL naming rules (Nick Scott)</p></li>
<li><p>Fix a race condition resulting in extra connections being opened to the PostgreSQL cluster from Patroni (Alexander Kukushkin)</p></li>
<li><p>Release the leader key when the node restarts with an empty data directory (Alex Kerney)</p></li>
<li><p>Set asynchronous executor busy when running bootstrap without a leader (Alexander Kukushkin)</p>
<p>Failure to do so could have resulted in errors stating the node belonged to a different cluster, as Patroni proceeded with
the normal business while being bootstrapped by a bootstrap method that doesn’t require a leader to be present in the
cluster.</p>
</li>
<li><p>Improve WAL-E replica creation method (Joar Wandborg, Alexander Kukushkin).</p>
<ul class="simple">
<li><p>Use csv.DictReader when parsing WAL-E base backup, accepting ISO dates with space-delimited date and time.</p></li>
<li><p>Support fetching current WAL position from the replica to estimate the amount of WAL to restore. Previously, the code used to call system information functions that were available only on the master node.</p></li>
</ul>
</li>
</ul>
</section>
<section id="version-1-2">
<h2>Version 1.2<a class="headerlink" href="#version-1-2" title="Link to this heading"></a></h2>
<p>Released 2016-12-13</p>
<p>This version introduces significant improvements over the handling of synchronous replication, makes the startup process and failover more reliable, adds PostgreSQL 9.6 support and fixes plenty of bugs.
In addition, the documentation, including these release notes, has been moved to <a class="reference external" href="https://patroni.readthedocs.io">https://patroni.readthedocs.io</a>.</p>
<p><strong>Synchronous replication</strong></p>
<ul>
<li><p>Add synchronous replication support. (Ants Aasma)</p>
<p>Adds a new configuration variable <code class="docutils literal notranslate"><span class="pre">synchronous_mode</span></code>. When enabled, Patroni will manage <code class="docutils literal notranslate"><span class="pre">synchronous_standby_names</span></code> to enable synchronous replication whenever there are healthy standbys available. When synchronous mode is enabled, Patroni will automatically fail over only to a standby that was synchronously replicating at the time of the master failure. This effectively means that no user visible transaction gets lost in such a case. See the
<a class="reference internal" href="replication_modes.html#synchronous-mode"><span class="std std-ref">feature documentation</span></a> for the detailed description and implementation details.</p>
</li>
</ul>
<p><strong>Reliability improvements</strong></p>
<ul>
<li><p>Do not try to update the leader position stored in the <code class="docutils literal notranslate"><span class="pre">leader</span> <span class="pre">optime</span></code> key when PostgreSQL is not 100% healthy. Demote immediately when the update of the leader key failed. (Alexander Kukushkin)</p></li>
<li><p>Exclude unhealthy nodes from the list of targets to clone the new replica from. (Alexander Kukushkin)</p></li>
<li><p>Implement retry and timeout strategy for Consul similar to how it is done for Etcd. (Alexander Kukushkin)</p></li>
<li><p>Make <code class="docutils literal notranslate"><span class="pre">--dcs</span></code> and <code class="docutils literal notranslate"><span class="pre">--config-file</span></code> apply to all options in <code class="docutils literal notranslate"><span class="pre">patronictl</span></code>. (Alexander Kukushkin)</p></li>
<li><p>Write all postgres parameters into postgresql.conf. (Alexander Kukushkin)</p>
<p>It allows starting PostgreSQL configured by Patroni with just <code class="docutils literal notranslate"><span class="pre">pg_ctl</span></code>.</p>
</li>
<li><p>Avoid exceptions when there are no users in the config. (Kirill Pushkin)</p></li>
<li><p>Allow pausing an unhealthy cluster. Before this fix, <code class="docutils literal notranslate"><span class="pre">patronictl</span></code> would bail out if the node it tries to execute pause on is unhealthy. (Alexander Kukushkin)</p></li>
<li><p>Improve the leader watch functionality. (Alexander Kukushkin)</p>
<p>Previously the replicas were always watching the leader key (sleeping until the timeout or the leader key changes). With this change, they only watch
when the replica’s PostgreSQL is in the <code class="docutils literal notranslate"><span class="pre">running</span></code> state and not when it is stopped/starting or restarting PostgreSQL.</p>
</li>
<li><p>Avoid running into race conditions when handling SIGCHILD as a PID 1. (Alexander Kukushkin)</p>
<p>Previously a race condition could occur when running inside the Docker containers, since the same process inside Patroni both spawned new processes
and handled SIGCHILD from them. This change uses fork/execs for Patroni and leaves the original PID 1 process responsible for handling signals from children.</p>
</li>
<li><p>Fix WAL-E restore. (Oleksii Kliukin)</p>
<p>Previously WAL-E restore used the <code class="docutils literal notranslate"><span class="pre">no_master</span></code> flag to avoid consulting with the master altogether, making Patroni always choose restoring
from WAL over the <code class="docutils literal notranslate"><span class="pre">pg_basebackup</span></code>. This change reverts it to the original meaning of <code class="docutils literal notranslate"><span class="pre">no_master</span></code>, namely Patroni WAL-E restore may be selected as a replication method if the master is not running.
The latter is checked by examining the connection string passed to the method. In addition, it makes the retry mechanism more robust and handles other minutia.</p>
</li>
<li><p>Implement asynchronous DNS resolver cache. (Alexander Kukushkin)</p>
<p>Avoid failing when DNS is temporary unavailable (for instance, due to an excessive traffic received by the node).</p>
</li>
<li><p>Implement starting state and master start timeout. (Ants Aasma, Alexander Kukushkin)</p>
<p>Previously <code class="docutils literal notranslate"><span class="pre">pg_ctl</span></code> waited for a timeout and then happily trodded on considering PostgreSQL to be running. This caused PostgreSQL to show up in listings as running when it was actually not and caused a race condition that   resulted in either a failover, or a crash recovery, or a crash recovery interrupted by failover and a missed rewind.
This change adds a <code class="docutils literal notranslate"><span class="pre">master_start_timeout</span></code> parameter and introduces a new state for the main HA loop: <code class="docutils literal notranslate"><span class="pre">starting</span></code>. When <code class="docutils literal notranslate"><span class="pre">master_start_timeout</span></code> is 0 we will failover immediately when the master crashes as soon as there is a failover candidate. Otherwise, Patroni will wait after attempting to start PostgreSQL on the master for the duration of the timeout; when it expires, it will failover if possible. Manual failover requests will be honored during the crash of the master even before the timeout expiration.</p>
<p>Introduce the <code class="docutils literal notranslate"><span class="pre">timeout</span></code> parameter to the <code class="docutils literal notranslate"><span class="pre">restart</span></code> API endpoint and <code class="docutils literal notranslate"><span class="pre">patronictl</span></code>. When it is set and restart takes longer than the timeout, PostgreSQL is considered unhealthy and the other nodes becomes eligible to take the leader lock.</p>
</li>
<li><p>Fix <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> behavior in a pause mode. (Ants Aasma)</p>
<p>Avoid unnecessary restart in a pause mode when Patroni thinks it needs to rewind but rewind is not possible (i.e. <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> is not present). Fallback to default <code class="docutils literal notranslate"><span class="pre">libpq</span></code> values for the <code class="docutils literal notranslate"><span class="pre">superuser</span></code> (default OS user) if <code class="docutils literal notranslate"><span class="pre">superuser</span></code> authentication is missing from the <code class="docutils literal notranslate"><span class="pre">pg_rewind</span></code> related Patroni configuration section.</p>
</li>
<li><p>Serialize callback execution. Kill the previous callback of the same type when the new one is about to run. Fix the issue of spawning zombie processes when running callbacks. (Alexander Kukushkin)</p></li>
<li><p>Avoid promoting a former master when the leader key is set in DCS but update to this leader key fails. (Alexander Kukushkin)</p>
<p>This avoids the issue of a current master continuing to keep its role when it is partitioned together with the minority of nodes in Etcd and other DCSs that allow “inconsistent reads”.</p>
</li>
</ul>
<p><strong>Miscellaneous</strong></p>
<ul>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">post_init</span></code> configuration option on bootstrap. (Alejandro Martínez)</p>
<p>Patroni will call the script argument of this option right after running <code class="docutils literal notranslate"><span class="pre">initdb</span></code> and starting up PostgreSQL for a new cluster. The script receives a connection URL with <code class="docutils literal notranslate"><span class="pre">superuser</span></code>
and sets <code class="docutils literal notranslate"><span class="pre">PGPASSFILE</span></code> to point to the <code class="docutils literal notranslate"><span class="pre">.pgpass</span></code> file containing the password. If the script fails, Patroni initialization fails as well. It is useful for adding
new users or creating extensions in the new cluster.</p>
</li>
<li><p>Implement PostgreSQL 9.6 support. (Alexander Kukushkin)</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">wal_level</span> <span class="pre">=</span> <span class="pre">replica</span></code> as a synonym for <code class="docutils literal notranslate"><span class="pre">hot_standby</span></code>, avoiding pending_restart flag when it changes from one to another. (Alexander Kukushkin)</p>
</li>
</ul>
<p><strong>Documentation improvements</strong></p>
<ul>
<li><p>Add a Patroni main <a class="reference external" href="https://raw.githubusercontent.com/patroni/patroni/master/docs/ha_loop_diagram.png">loop workflow diagram</a>. (Alejandro Martínez, Alexander Kukushkin)</p></li>
<li><p>Improve README, adding the Helm chart and links to release notes. (Lauri Apple)</p></li>
<li><p>Move Patroni documentation to <code class="docutils literal notranslate"><span class="pre">Read</span> <span class="pre">the</span> <span class="pre">Docs</span></code>. The up-to-date documentation is available at <a class="reference external" href="https://patroni.readthedocs.io">https://patroni.readthedocs.io</a>. (Oleksii Kliukin)</p>
<p>Makes the documentation easily viewable from different devices (including smartphones) and searchable.</p>
</li>
<li><p>Move the package to the semantic versioning. (Oleksii Kliukin)</p>
<p>Patroni will follow the major.minor.patch version schema to avoid releasing the new minor version on small but critical bugfixes. We will only publish the release notes for the minor version, which will include all patches.</p>
</li>
</ul>
</section>
<section id="version-1-1">
<h2>Version 1.1<a class="headerlink" href="#version-1-1" title="Link to this heading"></a></h2>
<p>Released 2016-09-07</p>
<p>This release improves management of Patroni cluster by bring in pause mode, improves maintenance with scheduled and conditional restarts, makes Patroni interaction with Etcd or Zookeeper more resilient and greatly enhances patronictl.</p>
<p><strong>Upgrade notice</strong></p>
<p>When upgrading from releases below 1.0 read about changing of credentials and configuration format at 1.0 release notes.</p>
<p><strong>Pause mode</strong></p>
<ul>
<li><p>Introduce pause mode to temporary detach Patroni from managing PostgreSQL instance (Murat Kabilov, Alexander Kukushkin, Oleksii Kliukin).</p>
<p>Previously, one had to send SIGKILL signal to Patroni to stop it without terminating PostgreSQL. The new pause mode detaches Patroni from PostgreSQL cluster-wide without terminating Patroni. It is similar to the maintenance mode in Pacemaker. Patroni is still responsible for updating member and leader keys in DCS, but it will not start, stop or restart PostgreSQL server in the process. There are a few exceptions, for instance, manual failovers, reinitializes and restarts are still allowed. You can read <a class="reference internal" href="pause.html#pause"><span class="std std-ref">a detailed description of this feature</span></a>.</p>
</li>
</ul>
<p>In addition, patronictl supports new <code class="docutils literal notranslate"><span class="pre">pause</span></code> and <code class="docutils literal notranslate"><span class="pre">resume</span></code> commands to toggle the pause mode.</p>
<p><strong>Scheduled and conditional restarts</strong></p>
<ul>
<li><p>Add conditions to the restart API command (Oleksii Kliukin)</p>
<p>This change enhances Patroni restarts by adding a couple of conditions that can be verified in order to do the restart. Among the conditions are restarting when PostgreSQL role is either a master or a replica, checking the PostgreSQL version number or restarting only when restart is necessary in order to apply configuration changes.</p>
</li>
<li><p>Add scheduled restarts (Oleksii Kliukin)</p>
<p>It is now possible to schedule a restart in the future. Only one scheduled restart per node is supported. It is possible to clear the scheduled restart if it is not needed anymore. A combination of scheduled and conditional restarts is supported, making it possible, for instance, to scheduled minor PostgreSQL upgrades in the night, restarting only the instances that are running the outdated minor version without adding postgres-specific logic to administration scripts.</p>
</li>
<li><p>Add support for conditional and scheduled restarts to patronictl (Murat Kabilov).</p>
<p>patronictl restart supports several new options. There is also patronictl flush command to clean the scheduled actions.</p>
</li>
</ul>
<p><strong>Robust DCS interaction</strong></p>
<ul>
<li><p>Set Kazoo timeouts depending on the loop_wait (Alexander Kukushkin)</p>
<p>Originally, ping_timeout and connect_timeout values were calculated from the negotiated session timeout. Patroni loop_wait was not taken into account. As
a result, a single retry could take more time than the session timeout, forcing Patroni to release the lock and demote.</p>
<p>This change set ping and connect timeout to half of the value of loop_wait, speeding up detection of connection issues and  leaving enough time to retry the connection attempt before losing the lock.</p>
</li>
<li><p>Update Etcd topology only after original request succeed (Alexander Kukushkin)</p>
<p>Postpone updating the Etcd topology known to the client until after the original request. When retrieving the cluster topology, implement the retry timeouts depending on the known number of nodes in the Etcd cluster. This makes our client prefer to get the results of the request to having the up-to-date list of nodes.</p>
<p>Both changes make Patroni connections to DCS more robust in the face of network issues.</p>
</li>
</ul>
<p><strong>Patronictl, monitoring and configuration</strong></p>
<ul class="simple">
<li><p>Return information about streaming replicas via the API (Feike Steenbergen)</p></li>
</ul>
<p>Previously, there was no reliable way to query Patroni about PostgreSQL instances that fail to stream changes (for instance, due to connection issues). This change exposes the contents of pg_stat_replication via the /patroni endpoint.</p>
<ul>
<li><p>Add patronictl scaffold command (Oleksii Kliukin)</p>
<p>Add a command to create cluster structure in Etcd. The cluster is created with user-specified sysid and leader, and both leader and member keys are made persistent. This command is useful to create so-called master-less configurations, where Patroni cluster consisting of only replicas replicate  from the external master node that is unaware of Patroni. Subsequently, one
may remove the leader key, promoting one of the Patroni nodes and replacing
the original master with the Patroni-based HA cluster.</p>
</li>
<li><p>Add configuration option <code class="docutils literal notranslate"><span class="pre">bin_dir</span></code> to locate PostgreSQL binaries (Ants Aasma)</p>
<p>It is useful to be able to specify the location of PostgreSQL binaries explicitly when Linux distros that support installing multiple PostgreSQL versions at the same time.</p>
</li>
<li><p>Allow configuration file path to be overridden using <code class="docutils literal notranslate"><span class="pre">custom_conf</span></code> of (Alejandro Martínez)</p>
<p>Allows for custom configuration file paths, which will be unmanaged by Patroni, <a class="reference internal" href="yaml_configuration.html#postgresql-settings"><span class="std std-ref">details</span></a>.</p>
</li>
</ul>
<p><strong>Bug fixes and code improvements</strong></p>
<ul>
<li><p>Make Patroni compatible with new version schema in PostgreSQL 10 and above (Feike Steenbergen)</p>
<p>Make sure that Patroni understand 2-digits version numbers when doing conditional restarts based on the PostgreSQL version.</p>
</li>
<li><p>Use pkgutil to find DCS modules (Alexander Kukushkin)</p>
<p>Use the dedicated python module instead of traversing directories manually in order to find DCS modules.</p>
</li>
<li><p>Always call on_start callback when starting Patroni (Alexander Kukushkin)</p>
<p>Previously, Patroni did not call any callbacks when attaching to the already running node with the correct role. Since callbacks are often used to route
client connections that could result in the failure to register the running
node in the connection routing scheme. With this fix, Patroni calls on_start
callback even when attaching to the already running node.</p>
</li>
<li><p>Do not drop active replication slots (Murat Kabilov, Oleksii Kliukin)</p>
<p>Avoid dropping active physical replication slots on master. PostgreSQL cannot
drop such slots anyway. This change makes possible to run non-Patroni managed
replicas/consumers on the master.</p>
</li>
<li><p>Close Patroni connections during start of the PostgreSQL instance (Alexander Kukushkin)</p>
<p>Forces Patroni to close all former connections when PostgreSQL node is started. Avoids the trap of reusing former connections if postmaster was killed with SIGKILL.</p>
</li>
<li><p>Replace invalid characters when constructing slot names from member names (Ants Aasma)</p>
<p>Make sure that standby names that do not comply with the slot naming rules don’t cause the slot creation and standby startup to fail. Replace the dashes in the slot names with underscores and all other characters not allowed in slot names with their unicode codepoints.</p>
</li>
</ul>
</section>
<section id="version-1-0">
<h2>Version 1.0<a class="headerlink" href="#version-1-0" title="Link to this heading"></a></h2>
<p>Released 2016-07-05</p>
<p>This release introduces the global dynamic configuration that allows dynamic changes of the PostgreSQL and Patroni configuration parameters for the entire HA cluster. It also delivers numerous bugfixes.</p>
<p><strong>Upgrade notice</strong></p>
<p>When upgrading from v0.90 or below, always upgrade all replicas before the master. Since we don’t store replication credentials in DCS anymore, an old replica won’t be able to connect to the new master.</p>
<p><strong>Dynamic Configuration</strong></p>
<ul>
<li><p>Implement the dynamic global configuration (Alexander Kukushkin)</p>
<p>Introduce new REST API endpoint /config to provide PostgreSQL and Patroni configuration parameters that should be set globally for the entire HA cluster (master and all the replicas). Those parameters are set in DCS and in many cases can be applied without disrupting PostgreSQL or Patroni. Patroni sets a special flag called “pending restart” visible via the API when some of the values require the PostgreSQL restart. In that case, restart should be issued manually via the API.</p>
<p>Patroni SIGHUP or POST to /reload will make it re-read the configuration file.</p>
<p>See the <a class="reference internal" href="patroni_configuration.html#patroni-configuration"><span class="std std-ref">Patroni configuration</span></a> for the details on which parameters can be changed and the order of processing difference configuration sources.</p>
<p>The configuration file format <em>has changed</em> since the v0.90. Patroni is still compatible with the old configuration files, but in order to take advantage of the bootstrap parameters one needs to change it. Users are encourage to update them by referring to the <a class="reference internal" href="dynamic_configuration.html#dynamic-configuration"><span class="std std-ref">dynamic configuration documentation page</span></a>.</p>
</li>
</ul>
<p><strong>More flexible configuration*</strong></p>
<ul>
<li><p>Make postgresql configuration and database name Patroni connects to configurable (Misja Hoebe)</p>
<p>Introduce <cite>database</cite> and <cite>config_base_name</cite> configuration parameters. Among others, it makes possible to run Patroni with PipelineDB and other PostgreSQL forks.</p>
</li>
<li><p>Implement possibility to configure some Patroni configuration parameters via environment (Alexander Kukushkin)</p>
<p>Those include the scope, the node name and the namespace, as well as the secrets and makes it easier to run Patroni in a dynamic environment, i.e. Kubernetes  Please, refer to the <a class="reference internal" href="ENVIRONMENT.html#environment"><span class="std std-ref">supported environment variables</span></a> for further details.</p>
</li>
<li><p>Update the built-in Patroni docker container  to take advantage of environment-based configuration (Feike Steenbergen).</p></li>
<li><p>Add Zookeeper support to Patroni docker image (Alexander Kukushkin)</p></li>
<li><p>Split the Zookeeper and Exhibitor configuration options (Alexander Kukushkin)</p></li>
<li><p>Make patronictl reuse the code from Patroni to read configuration (Alexander Kukushkin)</p>
<p>This allows patronictl to take advantage of environment-based configuration.</p>
</li>
<li><p>Set application name to node name in primary_conninfo (Alexander Kukushkin)</p>
<p>This simplifies identification and configuration of synchronous replication for a given node.</p>
</li>
</ul>
<p><strong>Stability, security and usability improvements</strong></p>
<ul>
<li><p>Reset sysid and do not call pg_controldata when restore of backup in progress (Alexander Kukushkin)</p>
<p>This change reduces the amount of noise generated by Patroni API health checks during the lengthy initialization of this node from the backup.</p>
</li>
<li><p>Fix a bunch of pg_rewind corner-cases (Alexander Kukushkin)</p>
<p>Avoid running pg_rewind if the source cluster is not the master.</p>
<p>In addition, avoid removing the data directory on an unsuccessful rewind, unless the new parameter <em>remove_data_directory_on_rewind_failure</em> is set to true. By default it is false.</p>
</li>
<li><p>Remove passwords from the replication connection string in DCS (Alexander Kukushkin)</p>
<p>Previously, Patroni always used the replication credentials from the Postgres URL in DCS. That is now changed to take the credentials from the patroni configuration. The secrets (replication username and password) and no longer exposed in DCS.</p>
</li>
<li><p>Fix the asynchronous machinery around the demote call (Alexander Kukushkin)</p>
<p>Demote now runs totally asynchronously without blocking the DCS interactions.</p>
</li>
<li><p>Make patronictl always send the authorization header if it is configured (Alexander Kukushkin)</p>
<p>This allows patronictl to issue “protected” requests, i.e. restart or reinitialize, when Patroni is configured to require authorization on those.</p>
</li>
<li><p>Handle the SystemExit exception correctly (Alexander Kukushkin)</p>
<p>Avoids the issues of Patroni not stopping properly when receiving the SIGTERM</p>
</li>
<li><p>Sample haproxy templates for confd (Alexander Kukushkin)</p>
<p>Generates and dynamically changes haproxy configuration from the patroni state in the DCS using confide</p>
</li>
<li><p>Improve and restructure the documentation to make it more friendly to the new users (Lauri Apple)</p></li>
<li><p>API must report role=master during pg_ctl stop (Alexander Kukushkin)</p>
<p>Makes the callback calls more reliable, particularly in the cluster stop case. In addition, introduce the <cite>pg_ctl_timeout</cite> option to set the timeout for the start, stop and restart calls via the <cite>pg_ctl</cite>.</p>
</li>
<li><p>Fix the retry logic in etcd (Alexander Kukushkin)</p>
<p>Make retries more predictable and robust.</p>
</li>
<li><p>Make Zookeeper code more resilient against short network hiccups (Alexander Kukushkin)</p>
<p>Reduce the connection timeouts to make Zookeeper connection attempts more frequent.</p>
</li>
</ul>
</section>
<section id="version-0-90">
<h2>Version 0.90<a class="headerlink" href="#version-0-90" title="Link to this heading"></a></h2>
<p>Released 2016-04-27</p>
<p>This releases adds support for Consul, includes a new <em>noloadbalance</em> tag, changes the behavior of the <em>clonefrom</em> tag, improves <em>pg_rewind</em> handling and improves <em>patronictl</em> control program.</p>
<p><strong>Consul support</strong></p>
<ul>
<li><p>Implement Consul support (Alexander Kukushkin)</p>
<p>Patroni runs against Consul, in addition to Etcd and Zookeeper. the connection parameters can be configured in the YAML file.</p>
</li>
</ul>
<p><strong>New and improved tags</strong></p>
<ul>
<li><p>Implement <em>noloadbalance</em> tag (Alexander Kukushkin)</p>
<p>This tag makes Patroni always return that the replica is not available to the load balancer.</p>
</li>
<li><p>Change the implementation of the <em>clonefrom</em> tag (Alexander Kukushkin)</p>
<p>Previously, a node name had to be supplied to the <em>clonefrom</em>, forcing a tagged replica to clone from the specific node. The new implementation makes <em>clonefrom</em> a boolean tag: if it is set to true, the replica becomes a candidate for other replicas to clone from it. When multiple candidates are present, the replicas picks one randomly.</p>
</li>
</ul>
<p><strong>Stability and security improvements</strong></p>
<ul>
<li><p>Numerous reliability improvements (Alexander Kukushkin)</p>
<p>Removes some spurious error messages, improves the stability of the failover, addresses some corner cases with reading data from DCS, shutdown, demote and reattaching of the former leader.</p>
</li>
<li><p>Improve systems script to avoid killing Patroni children on stop (Jan Keirse, Alexander Kukushkin)</p>
<p>Previously, when stopping Patroni, <em>systemd</em> also sent a signal to PostgreSQL. Since Patroni also tried to stop PostgreSQL by itself, it resulted in sending to different shutdown requests (the smart shutdown, followed by the fast shutdown). That resulted in replicas disconnecting too early and a former master not being able to rejoin after demote. Fix by Jan with prior research by Alexander.</p>
</li>
<li><p>Eliminate some cases where the former master was unable to call pg_rewind before rejoining as a replica (Oleksii Kliukin)</p>
<p>Previously, we only called <em>pg_rewind</em> if the former master had crashed. Change this to always run pg_rewind for the former master as long as pg_rewind is present in the system. This fixes the case when the master is shut down before the replicas managed to get the latest changes (i.e. during the “smart” shutdown).</p>
</li>
<li><p>Numerous improvements to unit- and acceptance- tests, in particular, enable support for Zookeeper and Consul (Alexander Kukushkin).</p></li>
<li><p>Make Travis CI faster and implement support for running tests against Zookeeper (Exhibitor) and Consul (Alexander Kukushkin)</p>
<p>Both unit and acceptance tests run automatically against Etcd, Zookeeper and Consul on each commit or pull-request.</p>
</li>
<li><p>Clear environment variables before calling PostgreSQL commands from Patroni (Feike Steenbergen)</p>
<p>This prevents  a possibility of reading system environment variables by connecting to the PostgreSQL cluster managed by Patroni.</p>
</li>
</ul>
<p><strong>Configuration and control changes</strong></p>
<ul>
<li><p>Unify patronictl and Patroni configuration (Feike Steenbergen)</p>
<p>patronictl can use the same configuration file as Patroni itself.</p>
</li>
<li><p>Enable Patroni to read the configuration from the environment variables (Oleksii Kliukin)</p>
<p>This simplifies generating configuration for Patroni automatically, or merging a single configuration from different sources.</p>
</li>
<li><p>Include database system identifier in the information returned by the API (Feike Steenbergen)</p></li>
<li><p>Implement <em>delete_cluster</em> for all available DCSs (Alexander Kukushkin)</p>
<p>Enables support for DCSs other than Etcd in patronictl.</p>
</li>
</ul>
</section>
<section id="version-0-80">
<h2>Version 0.80<a class="headerlink" href="#version-0-80" title="Link to this heading"></a></h2>
<p>Released 2016-03-14</p>
<p>This release adds support for <em>cascading replication</em> and simplifies Patroni management by providing <em>scheduled failovers</em>. One may use older versions of Patroni (in particular, 0.78) combined with this one in order to migrate to the new release. Note that the scheduled failover and cascading replication related features will only work with Patroni 0.80 and above.</p>
<p><strong>Cascading replication</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>Add support for the <em>replicatefrom</em> and <em>clonefrom</em> tags for the patroni node (Oleksii Kliukin).</p></li>
</ul>
<p>The tag <em>replicatefrom</em>  allows a replica to use an arbitrary node a source, not necessary the master. The <em>clonefrom</em> does the same for the initial backup. Together, they enable Patroni to fully support cascading replication.</p>
</div></blockquote>
<ul class="simple">
<li><p>Add support for running replication methods to initialize the replica even without a running replication connection (Oleksii Kliukin).</p></li>
</ul>
<blockquote>
<div><p>This is useful in order to create replicas from the snapshots stored on S3 or FTP.  A replication method that does not require a running replication connection should supply <em>no_master: true</em> in the yaml configuration. Those scripts will still be called in order if the replication connection is present.</p>
</div></blockquote>
<p><strong>Patronictl, API and DCS improvements</strong></p>
<ul>
<li><p>Implement scheduled failovers (Feike Steenbergen).</p>
<p>Failovers can be scheduled to happen at a certain time in the future, using either patronictl, or API calls.</p>
</li>
<li><p>Add support for <em>dbuser</em> and <em>password</em> parameters in patronictl (Feike Steenbergen).</p></li>
<li><p>Add PostgreSQL version to the health check output (Feike Steenbergen).</p></li>
<li><p>Improve Zookeeper support in patronictl (Oleksandr Shulgin)</p></li>
<li><p>Migrate to python-etcd 0.43 (Alexander Kukushkin)</p></li>
</ul>
<p><strong>Configuration</strong></p>
<ul class="simple">
<li><p>Add a sample systems configuration script for Patroni (Jan Keirse).</p></li>
<li><p>Fix the problem of Patroni ignoring the superuser name specified in the configuration file for DB connections  (Alexander Kukushkin).</p></li>
<li><p>Fix the handling of CTRL-C by creating a separate session ID and process group for the postmaster launched by Patroni (Alexander Kukushkin).</p></li>
</ul>
<p><strong>Tests</strong></p>
<ul>
<li><p>Add acceptance tests with <em>behave</em> in order to check real-world scenarios of running Patroni (Alexander Kukushkin, Oleksii Kliukin).</p>
<p>The tests can be launched manually using the <em>behave</em> command. They are also launched automatically for pull requests and after commits.</p>
<p>Release notes for some older versions can be found on <a class="reference external" href="https://github.com/patroni/patroni/releases">project’s github page</a>.</p>
</li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="faq.html" class="btn btn-neutral float-left" title="FAQ" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="CONTRIBUTING.html" class="btn btn-neutral float-right" title="Contributing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025 Compose, Zalando SE, Patroni Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>