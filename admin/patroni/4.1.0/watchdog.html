

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Watchdog support &mdash; Patroni 4.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="_static/github_style.css?v=1093691d" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=977c162b" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=42d1b3bd"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Pause/Resume mode for the cluster" href="pause.html" />
    <link rel="prev" title="Standby cluster" href="standby_cluster.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Patroni
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="patroni_configuration.html">Patroni configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="rest_api.html">Patroni REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="patronictl.html">patronictl</a></li>
<li class="toctree-l1"><a class="reference internal" href="replica_bootstrap.html">Replica imaging and bootstrap</a></li>
<li class="toctree-l1"><a class="reference internal" href="replication_modes.html">Replication modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="standby_cluster.html">Standby cluster</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Watchdog support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-software-watchdog-on-linux">Setting up software watchdog on Linux</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pause.html">Pause/Resume mode for the cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="dcs_failsafe_mode.html">DCS Failsafe Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="kubernetes.html">Using Patroni with Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="citus.html">Citus support</a></li>
<li class="toctree-l1"><a class="reference internal" href="existing_data.html">Convert a Standalone to a Patroni Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="existing_data.html#major-upgrade-of-postgresql-version">Major Upgrade of PostgreSQL Version</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools_integration.html">Integration with other tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security Considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="ha_multi_dc.html">HA multi datacenter</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Patroni</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Watchdog support</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/patroni/patroni/blob/master/docs/watchdog.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="watchdog-support">
<span id="watchdog"></span><h1>Watchdog support<a class="headerlink" href="#watchdog-support" title="Link to this heading"></a></h1>
<p>Having multiple PostgreSQL servers running as primary can result in transactions lost due to diverging timelines. This situation is also called a split-brain problem. To avoid split-brain Patroni needs to ensure PostgreSQL will not accept any transaction commits after leader key expires in the DCS. Under normal circumstances Patroni will try to achieve this by stopping PostgreSQL when leader lock update fails for any reason. However, this may fail to happen due to various reasons:</p>
<ul class="simple">
<li><p>Patroni has crashed due to a bug, out-of-memory condition or by being accidentally killed by a system administrator.</p></li>
<li><p>Shutting down PostgreSQL is too slow.</p></li>
<li><p>Patroni does not get to run due to high load on the system, the VM being paused by the hypervisor, or other infrastructure issues.</p></li>
</ul>
<p>To guarantee correct behavior under these conditions Patroni supports watchdog devices. Watchdog devices are software or hardware mechanisms that will reset the whole system when they do not get a keepalive heartbeat within a specified timeframe. This adds an additional layer of fail safe in case usual Patroni split-brain protection mechanisms fail.</p>
<p>Patroni will try to activate the watchdog before promoting PostgreSQL to primary. If watchdog activation fails and watchdog mode is <code class="docutils literal notranslate"><span class="pre">required</span></code> then the node will refuse to become leader. When deciding to participate in leader election Patroni will also check that watchdog configuration will allow it to become leader at all. After demoting PostgreSQL (for example due to a manual failover) Patroni will disable the watchdog again. Watchdog will also be disabled while Patroni is in paused state.</p>
<p>By default Patroni will set up the watchdog to expire 5 seconds before TTL expires. With the default setup of <code class="docutils literal notranslate"><span class="pre">loop_wait=10</span></code> and <code class="docutils literal notranslate"><span class="pre">ttl=30</span></code> this gives HA loop at least 15 seconds (<code class="docutils literal notranslate"><span class="pre">ttl</span></code> - <code class="docutils literal notranslate"><span class="pre">safety_margin</span></code> - <code class="docutils literal notranslate"><span class="pre">loop_wait</span></code>) to complete before the system gets forcefully reset. By default accessing DCS is configured to time out after 10 seconds. This means that when DCS is unavailable, for example due to network issues, Patroni and PostgreSQL will have at least 5 seconds (<code class="docutils literal notranslate"><span class="pre">ttl</span></code> - <code class="docutils literal notranslate"><span class="pre">safety_margin</span></code> - <code class="docutils literal notranslate"><span class="pre">loop_wait</span></code> - <code class="docutils literal notranslate"><span class="pre">retry_timeout</span></code>) to come to a state where all client connections are terminated.</p>
<p>Safety margin is the amount of time that Patroni reserves for time between leader key update and watchdog keepalive. Patroni will try to send a keepalive immediately after confirmation of leader key update. If Patroni process is suspended for extended amount of time at exactly the right moment the keepalive may be delayed for more than the safety margin without triggering the watchdog. This results in a window of time where watchdog will not trigger before leader key expiration, invalidating the guarantee. To be absolutely sure that watchdog will trigger under all circumstances set up the watchdog to expire after half of TTL by setting <code class="docutils literal notranslate"><span class="pre">safety_margin</span></code> to -1 to set watchdog timeout to <code class="docutils literal notranslate"><span class="pre">ttl</span> <span class="pre">//</span> <span class="pre">2</span></code>. If you need this guarantee you probably should increase <code class="docutils literal notranslate"><span class="pre">ttl</span></code> and/or reduce <code class="docutils literal notranslate"><span class="pre">loop_wait</span></code> and <code class="docutils literal notranslate"><span class="pre">retry_timeout</span></code>.</p>
<p>Currently watchdogs are only supported using Linux watchdog device interface.</p>
<section id="setting-up-software-watchdog-on-linux">
<h2>Setting up software watchdog on Linux<a class="headerlink" href="#setting-up-software-watchdog-on-linux" title="Link to this heading"></a></h2>
<p>Default Patroni configuration will try to use <code class="docutils literal notranslate"><span class="pre">/dev/watchdog</span></code> on Linux if it is accessible to Patroni. For most use cases using software watchdog built into the Linux kernel is secure enough.</p>
<p>To enable software watchdog issue the following commands as root before starting Patroni:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>modprobe<span class="w"> </span>softdog
<span class="c1"># Replace postgres with the user you will be running patroni under</span>
chown<span class="w"> </span>postgres<span class="w"> </span>/dev/watchdog
</pre></div>
</div>
<p>For testing it may be helpful to disable rebooting by adding <code class="docutils literal notranslate"><span class="pre">soft_noboot=1</span></code> to the modprobe command line. In this case the watchdog will just log a line in kernel ring buffer, visible via <cite>dmesg</cite>.</p>
<p>Patroni will log information about the watchdog when it is successfully enabled.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="standby_cluster.html" class="btn btn-neutral float-left" title="Standby cluster" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="pause.html" class="btn btn-neutral float-right" title="Pause/Resume mode for the cluster" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025 Compose, Zalando SE, Patroni Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>