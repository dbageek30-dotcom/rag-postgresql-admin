

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Convert a Standalone to a Patroni Cluster &mdash; Patroni 4.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="_static/github_style.css?v=1093691d" />
      <link rel="stylesheet" type="text/css" href="_static/custom.css?v=977c162b" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=42d1b3bd"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Integration with other tools" href="tools_integration.html" />
    <link rel="prev" title="Citus support" href="citus.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Patroni
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="patroni_configuration.html">Patroni configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="rest_api.html">Patroni REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="patronictl.html">patronictl</a></li>
<li class="toctree-l1"><a class="reference internal" href="replica_bootstrap.html">Replica imaging and bootstrap</a></li>
<li class="toctree-l1"><a class="reference internal" href="replication_modes.html">Replication modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="standby_cluster.html">Standby cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="watchdog.html">Watchdog support</a></li>
<li class="toctree-l1"><a class="reference internal" href="pause.html">Pause/Resume mode for the cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="dcs_failsafe_mode.html">DCS Failsafe Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="kubernetes.html">Using Patroni with Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="citus.html">Citus support</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Convert a Standalone to a Patroni Cluster</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#procedure">Procedure</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#major-upgrade-of-postgresql-version">Major Upgrade of PostgreSQL Version</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#faq">FAQ</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tools_integration.html">Integration with other tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security Considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="ha_multi_dc.html">HA multi datacenter</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Patroni</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Convert a Standalone to a Patroni Cluster</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/patroni/patroni/blob/master/docs/existing_data.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="convert-a-standalone-to-a-patroni-cluster">
<span id="existing-data"></span><h1>Convert a Standalone to a Patroni Cluster<a class="headerlink" href="#convert-a-standalone-to-a-patroni-cluster" title="Link to this heading"></a></h1>
<p>This section describes the process for converting a standalone PostgreSQL instance into a Patroni cluster.</p>
<p>To deploy a Patroni cluster without using a pre-existing PostgreSQL instance, see <a class="reference internal" href="README.html#running-configuring"><span class="std std-ref">Running and Configuring</span></a> instead.</p>
<section id="procedure">
<h2>Procedure<a class="headerlink" href="#procedure" title="Link to this heading"></a></h2>
<p>You can find below an overview of steps for converting an existing Postgres cluster to a Patroni managed cluster. In the steps we assume all nodes that are part of the existing cluster are currently up and running, and that you <em>do not</em> intend to change Postgres configuration while the migration is ongoing. The steps:</p>
<ol class="arabic">
<li><p>Create the Postgres users as explained for <a class="reference internal" href="yaml_configuration.html#postgresql-settings"><span class="std std-ref">authentication</span></a> section of the Patroni configuration. You can find sample SQL commands to create the users in the code block below, in which you need to replace the usernames and passwords as per your environment. If you already have the relevant users, then you can skip this step.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Patroni superuser</span>
<span class="c1">-- Replace PATRONI_SUPERUSER_USERNAME and PATRONI_SUPERUSER_PASSWORD accordingly</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">PATRONI_SUPERUSER_USERNAME</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">SUPERUSER</span><span class="w"> </span><span class="k">ENCRYPTED</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;PATRONI_SUPERUSER_PASSWORD&#39;</span><span class="p">;</span>

<span class="c1">-- Patroni replication user</span>
<span class="c1">-- Replace PATRONI_REPLICATION_USERNAME and PATRONI_REPLICATION_PASSWORD accordingly</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">PATRONI_REPLICATION_USERNAME</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">REPLICATION</span><span class="w"> </span><span class="k">ENCRYPTED</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;PATRONI_REPLICATION_PASSWORD&#39;</span><span class="p">;</span>

<span class="c1">-- Patroni rewind user, if you intend to enable use_pg_rewind in your Patroni configuration</span>
<span class="c1">-- Replace PATRONI_REWIND_USERNAME and PATRONI_REWIND_PASSWORD accordingly</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">PATRONI_REWIND_USERNAME</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">ENCRYPTED</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;PATRONI_REWIND_PASSWORD&#39;</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">pg_catalog</span><span class="p">.</span><span class="n">pg_ls_dir</span><span class="p">(</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="nb">boolean</span><span class="p">,</span><span class="w"> </span><span class="nb">boolean</span><span class="p">)</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">PATRONI_REWIND_USERNAME</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">pg_catalog</span><span class="p">.</span><span class="n">pg_stat_file</span><span class="p">(</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="nb">boolean</span><span class="p">)</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">PATRONI_REWIND_USERNAME</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">pg_catalog</span><span class="p">.</span><span class="n">pg_read_binary_file</span><span class="p">(</span><span class="nb">text</span><span class="p">)</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">PATRONI_REWIND_USERNAME</span><span class="p">;</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">EXECUTE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">pg_catalog</span><span class="p">.</span><span class="n">pg_read_binary_file</span><span class="p">(</span><span class="nb">text</span><span class="p">,</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span><span class="nb">boolean</span><span class="p">)</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">PATRONI_REWIND_USERNAME</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Perform the following steps on all Postgres nodes. Perform all steps on one node before proceeding with the next node. Start with the primary node, then proceed with each standby node:</p>
<ol class="arabic simple">
<li><p>If you are running Postgres through systemd, then disable the Postgres systemd unit. This is performed as Patroni manages starting and stopping the Postgres daemon.</p></li>
<li><p>Create a YAML configuration file for Patroni. You can use <a class="reference internal" href="patroni_configuration.html#validate-generate-config"><span class="std std-ref">Patroni configuration generation and validation tooling</span></a> for that.</p>
<ul class="simple">
<li><p><strong>Note (specific for the primary node):</strong> If you have replication slots being used for replication between cluster members, then it is recommended that you enable <code class="docutils literal notranslate"><span class="pre">use_slots</span></code> and configure the existing replication slots as permanent via the <code class="docutils literal notranslate"><span class="pre">slots</span></code> configuration item. Be aware that Patroni automatically creates replication slots for replication between members, and drops replication slots that it does not recognize, when <code class="docutils literal notranslate"><span class="pre">use_slots</span></code> is enabled. The idea of using permanent slots here is to allow your existing slots to persist while the migration to Patroni is in progress. See <a class="reference internal" href="dynamic_configuration.html#dynamic-configuration"><span class="std std-ref">Dynamic Configuration Settings</span></a> for details.</p></li>
</ul>
</li>
<li><p>Start Patroni using the <code class="docutils literal notranslate"><span class="pre">patroni</span></code> systemd service unit. It automatically detects that Postgres is already running and starts monitoring the instance.</p></li>
</ol>
</li>
<li><p>Hand over Postgres “start up procedure” to Patroni. In order to do that you need to restart the cluster members through <a class="reference internal" href="patronictl.html#patronictl-restart-parameters"><span class="std std-ref">patronictl restart cluster-name member-name</span></a> command. For minimal downtime you might want to split this step into:</p>
<ol class="arabic simple">
<li><p>Immediate restart of the standby nodes.</p></li>
<li><p>Scheduled restart of the primary node within a maintenance window.</p></li>
</ol>
</li>
<li><p>If you configured permanent slots in step <code class="docutils literal notranslate"><span class="pre">1.2.</span></code>, then you should remove them from <code class="docutils literal notranslate"><span class="pre">slots</span></code> configuration through <a class="reference internal" href="patronictl.html#patronictl-edit-config-parameters"><span class="std std-ref">patronictl edit-config cluster-name</span></a> command once the <code class="docutils literal notranslate"><span class="pre">restart_lsn</span></code> of the slots created by Patroni is able to catch up with the <code class="docutils literal notranslate"><span class="pre">restart_lsn</span></code> of the original slots for the corresponding members. By removing the slots from <code class="docutils literal notranslate"><span class="pre">slots</span></code> configuration you will allow Patroni to drop the original slots from your cluster once they are not needed anymore. You can find below an example query to check the <code class="docutils literal notranslate"><span class="pre">restart_lsn</span></code> of a couple slots, so you can compare them:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Assume original_slot_for_member_x is the name of the slot in your original</span>
<span class="c1">-- cluster for replicating changes to member X, and slot_for_member_x is the</span>
<span class="c1">-- slot created by Patroni for that purpose. You need restart_lsn of</span>
<span class="c1">-- slot_for_member_x to be &gt;= restart_lsn of original_slot_for_member_x</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">slot_name</span><span class="p">,</span>
<span class="w">       </span><span class="n">restart_lsn</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_replication_slots</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">slot_name</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;original_slot_for_member_x&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;slot_for_member_x&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="major-upgrade-of-postgresql-version">
<span id="major-upgrade"></span><h1>Major Upgrade of PostgreSQL Version<a class="headerlink" href="#major-upgrade-of-postgresql-version" title="Link to this heading"></a></h1>
<p>The only possible way to do a major upgrade currently is:</p>
<ol class="arabic simple">
<li><p>Stop Patroni</p></li>
<li><p>Upgrade PostgreSQL binaries and perform <a class="reference external" href="https://www.postgresql.org/docs/current/pgupgrade.html">pg_upgrade</a> on the primary node</p></li>
<li><p>Update patroni.yml</p></li>
<li><p>Remove the initialize key from DCS or wipe complete cluster state from DCS. The second one could be achieved by running <a class="reference internal" href="patronictl.html#patronictl-remove-parameters"><span class="std std-ref">patronictl remove cluster-name</span></a> . It is necessary because pg_upgrade runs initdb which actually creates a new database with a new PostgreSQL system identifier.</p></li>
<li><p>If you wiped the cluster state in the previous step, you may wish to copy patroni.dynamic.json from old data dir to the new one.  It will help you to retain some PostgreSQL parameters you had set before.</p></li>
<li><p>Start Patroni on the primary node.</p></li>
<li><p>Upgrade PostgreSQL binaries, update patroni.yml and wipe the data_dir on standby nodes.</p></li>
<li><p>Start Patroni on the standby nodes and wait for the replication to complete.</p></li>
</ol>
<p>Running pg_upgrade on standby nodes is not supported by PostgreSQL. If you know what you are doing, you can try the rsync procedure described in <a class="reference external" href="https://www.postgresql.org/docs/current/pgupgrade.html">https://www.postgresql.org/docs/current/pgupgrade.html</a> instead of wiping data_dir on standby nodes. The safest way is however to let Patroni replicate the data for you.</p>
<section id="faq">
<h2>FAQ<a class="headerlink" href="#faq" title="Link to this heading"></a></h2>
<ul>
<li><p>During Patroni startup, Patroni complains that it cannot bind to the PostgreSQL port.</p>
<p>You need to verify <code class="docutils literal notranslate"><span class="pre">listen_addresses</span></code> and <code class="docutils literal notranslate"><span class="pre">port</span></code> in <code class="docutils literal notranslate"><span class="pre">postgresql.conf</span></code> and <code class="docutils literal notranslate"><span class="pre">postgresql.listen</span></code> in <code class="docutils literal notranslate"><span class="pre">patroni.yml</span></code>. Don’t forget that <code class="docutils literal notranslate"><span class="pre">pg_hba.conf</span></code> should allow such access.</p>
</li>
<li><p>After asking Patroni to restart the node, PostgreSQL displays the error message <code class="docutils literal notranslate"><span class="pre">could</span> <span class="pre">not</span> <span class="pre">open</span> <span class="pre">configuration</span> <span class="pre">file</span> <span class="pre">&quot;/etc/postgresql/10/main/pg_hba.conf&quot;:</span> <span class="pre">No</span> <span class="pre">such</span> <span class="pre">file</span> <span class="pre">or</span> <span class="pre">directory</span></code></p>
<p>It can mean various things depending on how you manage PostgreSQL configuration. If you specified <cite>postgresql.config_dir</cite>, Patroni generates the <code class="docutils literal notranslate"><span class="pre">pg_hba.conf</span></code> based on the settings in the <a class="reference internal" href="yaml_configuration.html#bootstrap-settings"><span class="std std-ref">bootstrap</span></a> section only when it bootstraps a new cluster. In this scenario the <code class="docutils literal notranslate"><span class="pre">PGDATA</span></code> was not empty, therefore no bootstrap happened. This file must exist beforehand.</p>
</li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="citus.html" class="btn btn-neutral float-left" title="Citus support" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tools_integration.html" class="btn btn-neutral float-right" title="Integration with other tools" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025 Compose, Zalando SE, Patroni Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>